<!-- vehicles/templates/vehicles/debug.html -->
{% extends 'base.html' %}

{% block page_title %}Диагностика AutoGRAPH API{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-bug me-2"></i>Диагностика AutoGRAPH API
                    </h1>
                    <p class="text-muted mb-0">Проверка подключения и получение данных из AutoGRAPH API</p>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-primary" onclick="runDebug()" id="debugBtn">
                        <i class="fas fa-play me-1"></i> Запустить диагностику
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Результаты диагностики -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Результаты диагностики
                    </h5>
                </div>
                <div class="card-body">
                    <div id="debugResults">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>Нажмите "Запустить диагностику" для проверки подключения к AutoGRAPH API</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Инструкция -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>Инструкция по диагностике
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Что проверяется:</h6>
                            <ul>
                                <li>✅ Аутентификация в AutoGRAPH</li>
                                <li>✅ Получение списка схем</li>
                                <li>✅ Получение списка транспортных средств</li>
                                <li>✅ Получение онлайн-данных</li>
                                <li>✅ Структура ответов API</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Возможные проблемы:</h6>
                            <ul>
                                <li>❌ Неверные учетные данные</li>
                                <li>❌ Проблемы с сетью</li>
                                <li>❌ Изменения в API AutoGRAPH</li>
                                <li>❌ Отсутствие данных в системе</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="mb-0">Выполняется диагностика...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function runDebug() {
    const debugBtn = document.getElementById('debugBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const debugResults = document.getElementById('debugResults');

    // Показываем загрузку
    debugBtn.disabled = true;
    loadingOverlay.style.display = 'flex';
    debugResults.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Выполняется диагностика...</p></div>';

    // Выполняем запрос к API
    fetch('/vehicles/api/debug/')
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            debugBtn.disabled = false;

            if (data.success) {
                displayDebugResults(data.debug_info);
            } else {
                displayError(data.error);
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            debugBtn.disabled = false;
            displayError('Ошибка сети: ' + error.message);
        });
}

function displayDebugResults(debugInfo) {
    const debugResults = document.getElementById('debugResults');

    let html = `
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">Аутентификация</h5>
                <div class="card ${debugInfo.authentication.success ? 'border-success' : 'border-danger'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title ${debugInfo.authentication.success ? 'text-success' : 'text-danger'}">
                                    ${debugInfo.authentication.success ? '✅ Успешно' : '❌ Ошибка'}
                                </h6>
                                <p class="card-text mb-0">
                                    Токен: ${debugInfo.authentication.token_available ? 'Доступен' : 'Отсутствует'}
                                    ${debugInfo.authentication.token_preview ? `(${debugInfo.authentication.token_preview})` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (debugInfo.authentication.success) {
        // Схемы
        html += `
            <div class="row mt-4">
                <div class="col-12">
                    <h5 class="mb-3">Схемы</h5>
                    <div class="card ${debugInfo.schemas.count > 0 ? 'border-success' : 'border-warning'}">
                        <div class="card-body">
                            <h6 class="card-title ${debugInfo.schemas.count > 0 ? 'text-success' : 'text-warning'}">
                                ${debugInfo.schemas.count > 0 ? '✅ Найдено схем: ' + debugInfo.schemas.count : '⚠️ Схемы не найдены'}
                            </h6>
                            ${debugInfo.schemas.count > 0 ? `
                                <div class="mt-3">
                                    <h6>Данные схем:</h6>
                                    <pre class="bg-light p-3 rounded"><code>${JSON.stringify(debugInfo.schemas.data, null, 2)}</code></pre>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        if (debugInfo.schemas.count > 0) {
            // Транспортные средства
            html += `
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3">Транспортные средства</h5>
                        <div class="card ${debugInfo.vehicles.has_data ? 'border-success' : 'border-warning'}">
                            <div class="card-body">
                                <h6 class="card-title ${debugInfo.vehicles.has_data ? 'text-success' : 'text-warning'}">
                                    ${debugInfo.vehicles.has_data ? '✅ Найдено ТС: ' + debugInfo.vehicles.items_count : '⚠️ ТС не найдены'}
                                </h6>
                                ${debugInfo.vehicles.has_data ? `
                                    <div class="mt-3">
                                        <h6>Примеры ТС:</h6>
                                        <pre class="bg-light p-3 rounded"><code>${JSON.stringify(debugInfo.vehicles.sample_items, null, 2)}</code></pre>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Онлайн данные
            html += `
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3">Онлайн данные</h5>
                        <div class="card ${debugInfo.online_data.has_data ? 'border-success' : 'border-warning'}">
                            <div class="card-body">
                                <h6 class="card-title ${debugInfo.online_data.has_data ? 'text-success' : 'text-warning'}">
                                    ${debugInfo.online_data.has_data ? '✅ Онлайн данные доступны' : '⚠️ Онлайн данные отсутствуют'}
                                </h6>
                                ${debugInfo.online_data.has_data ? `
                                    <p>Устройств онлайн: ${debugInfo.online_data.devices_count}</p>
                                    <div class="mt-3">
                                        <h6>Примеры устройств:</h6>
                                        <pre class="bg-light p-3 rounded"><code>${JSON.stringify(debugInfo.online_data.sample_devices, null, 2)}</code></pre>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    debugResults.innerHTML = html;
}

function displayError(error) {
    const debugResults = document.getElementById('debugResults');
    debugResults.innerHTML = `
        <div class="alert alert-danger">
            <h5 class="alert-heading">❌ Ошибка диагностики</h5>
            <p class="mb-0">${error}</p>
        </div>
    `;
}
</script>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
</style>
{% endblock %}