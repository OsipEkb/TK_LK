<!-- templates/vehicles/analytics.html -->
{% extends 'base.html' %}

{% block page_title %}Аналитика транспорта{% endblock %}

{% block extra_css %}
<style>
.dashboard-preset-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
    height: 100%;
}
.dashboard-preset-card:hover {
    transform: translateY(-5px);
    border-color: #007bff;
}
.dashboard-preset-card.selected {
    border-color: #007bff;
    background-color: #f8f9fa;
}
.vehicle-selector {
    max-height: 500px;
    overflow-y: auto;
}
.vehicle-check-item {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    margin-bottom: 8px;
    padding: 10px;
    transition: all 0.2s ease;
}
.vehicle-check-item:hover {
    background-color: #f8f9fa;
}
.vehicle-check-item.selected {
    border-color: #007bff;
    background-color: #e7f3ff;
}
.analytics-chart {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.metric-card {
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.metric-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin: 10px 0;
}
.metric-label {
    font-size: 0.9rem;
    color: #6c757d;
}
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    border-radius: 8px;
}
.time-interval-btn {
    margin: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Дашборд</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'api_vehicles_list' %}"><i class="fas fa-truck"></i> Транспорт</a></li>
                    <li class="breadcrumb-item active"><i class="fas fa-chart-line"></i> Аналитика</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="fas fa-chart-line text-primary me-2"></i>Аналитика транспорта</h1>
            <p class="text-muted">Расширенная аналитика работы транспортных средств</p>
        </div>
    </div>

    <!-- Панель управления -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- Выбор дат -->
                <div class="col-md-3">
                    <label class="form-label fw-bold">Дата начала</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Дата окончания</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Интервал</label>
                    <div class="btn-group w-100" role="group" id="intervalGroup">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="loadAnalyticsBtn">
                        <i class="fas fa-sync-alt me-1"></i>Загрузить аналитику
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Левая колонка - выбор ТС и дашбордов -->
        <div class="col-md-3">
            <!-- Выбор дашборда -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>Тип дашборда
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div id="dashboardPresets">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Выбор ТС -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-truck me-2"></i>Транспортные средства
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="p-3 border-bottom">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllVehicles">
                            <label class="form-check-label fw-bold" for="selectAllVehicles">
                                Выбрать все
                            </label>
                        </div>
                    </div>
                    <div class="vehicle-selector p-2" id="vehiclesList">
                        <!-- Будет заполнено JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - аналитика -->
        <div class="col-md-9">
            <!-- Уведомления -->
            <div class="alert alert-info alert-dismissible fade show mb-4" id="infoAlert" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                <span id="alertMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Область аналитики -->
            <div id="analyticsArea">
                <!-- Пустое состояние -->
                <div class="text-center p-5 text-muted" id="emptyState">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <h4>Выберите параметры аналитики</h4>
                    <p>Выберите тип дашборда, транспортные средства и временной период для отображения аналитики</p>
                </div>

                <!-- Загрузка -->
                <div class="text-center p-5" id="loadingState" style="display: none;">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <h5>Загрузка аналитики...</h5>
                    <p class="text-muted">Это может занять несколько секунд</p>
                </div>

                <!-- Контейнер для аналитики -->
                <div id="analyticsContainer" style="display: none;">
                    <!-- Сводные метрики -->
                    <div class="row mb-4" id="summaryMetrics">
                        <!-- Будет заполнено JavaScript -->
                    </div>

                    <!-- Графики -->
                    <div class="row">
                        <div class="col-12">
                            <div class="analytics-chart">
                                <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Временные ряды</h5>
                                <div class="chart-container">
                                    <canvas id="timeSeriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Детальная таблица -->
                    <div class="row">
                        <div class="col-12">
                            <div class="analytics-chart">
                                <h5 class="mb-3"><i class="fas fa-table me-2"></i>Детальная информация</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="detailsTable">
                                        <thead>
                                            <tr>
                                                <th>Транспортное средство</th>
                                                <!-- Заголовки будут добавлены через JavaScript -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Данные будут добавлены через JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Глобальные переменные
let currentChart = null;
let selectedVehicles = new Set();
let selectedDashboard = null;
let selectedInterval = 'hour';
let vehiclesList = [];
let dashboardPresets = [];
let timeIntervals = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeAnalyticsPage();
});

async function initializeAnalyticsPage() {
    await loadPresetsAndIntervals();
    await loadVehiclesList();
    setupEventListeners();
    setDefaultDates();
}

async function loadPresetsAndIntervals() {
    try {
        const response = await fetch('/api/vehicles/analytics/presets/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                dashboardPresets = result.presets;
                timeIntervals = result.time_intervals;
                renderDashboardPresets();
                renderTimeIntervals();
            }
        }
    } catch (error) {
        console.error('Ошибка загрузки пресетов:', error);
        showAlert('Ошибка загрузки настроек аналитики', 'danger');
    }
}

async function loadVehiclesList() {
    try {
        const response = await fetch('/api/vehicles/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                vehiclesList = result.vehicles;
                renderVehiclesList();
            }
        }
    } catch (error) {
        console.error('Ошибка загрузки списка ТС:', error);
        showAlert('Ошибка загрузки списка транспортных средств', 'danger');
    }
}

function renderDashboardPresets() {
    const container = document.getElementById('dashboardPresets');
    let html = '';

    dashboardPresets.forEach(preset => {
        html += `
            <div class="dashboard-preset-card card m-2 ${selectedDashboard === preset.id ? 'selected' : ''}"
                 data-preset-id="${preset.id}">
                <div class="card-body text-center">
                    <i class="${preset.icon || 'fas fa-chart-bar'} fa-2x text-${preset.color || 'primary'} mb-3"></i>
                    <h6 class="card-title">${preset.name}</h6>
                    <p class="card-text small text-muted">${preset.description}</p>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Обработчики выбора дашборда
    container.querySelectorAll('.dashboard-preset-card').forEach(card => {
        card.addEventListener('click', function() {
            selectedDashboard = this.dataset.presetId;

            // Снимаем выделение со всех
            container.querySelectorAll('.dashboard-preset-card').forEach(c => c.classList.remove('selected'));
            // Выделяем текущий
            this.classList.add('selected');

            updateUIState();
        });
    });
}

function renderTimeIntervals() {
    const container = document.getElementById('intervalGroup');
    let html = '';

    timeIntervals.forEach(interval => {
        html += `
            <button type="button" class="btn btn-outline-primary time-interval-btn ${selectedInterval === interval.value ? 'active' : ''}"
                    data-interval="${interval.value}">
                ${interval.name}
            </button>
        `;
    });

    container.innerHTML = html;

    // Обработчики выбора интервала
    container.querySelectorAll('.time-interval-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectedInterval = this.dataset.interval;

            // Снимаем активный класс со всех
            container.querySelectorAll('.time-interval-btn').forEach(b => b.classList.remove('active'));
            // Добавляем текущему
            this.classList.add('active');
        });
    });
}

function renderVehiclesList() {
    const container = document.getElementById('vehiclesList');
    let html = '';

    vehiclesList.forEach(vehicle => {
        html += `
            <div class="vehicle-check-item ${selectedVehicles.has(vehicle.id) ? 'selected' : ''}">
                <div class="form-check">
                    <input class="form-check-input vehicle-checkbox" type="checkbox"
                           id="vehicle_${vehicle.id}" ${selectedVehicles.has(vehicle.id) ? 'checked' : ''}>
                    <label class="form-check-label" for="vehicle_${vehicle.id}">
                        <strong>${vehicle.name}</strong><br>
                        <small class="text-muted">${vehicle.license_plate || 'Номер не указан'}</small>
                    </label>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Обработчики чекбоксов
    container.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const vehicleId = this.id.replace('vehicle_', '');

            if (this.checked) {
                selectedVehicles.add(vehicleId);
                this.closest('.vehicle-check-item').classList.add('selected');
            } else {
                selectedVehicles.delete(vehicleId);
                this.closest('.vehicle-check-item').classList.remove('selected');
            }

            updateSelectAllCheckbox();
            updateUIState();
        });
    });

    // Обработчик "Выбрать все"
    document.getElementById('selectAllVehicles').addEventListener('change', function() {
        const checkboxes = container.querySelectorAll('.vehicle-checkbox');

        if (this.checked) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const vehicleId = checkbox.id.replace('vehicle_', '');
                selectedVehicles.add(vehicleId);
                checkbox.closest('.vehicle-check-item').classList.add('selected');
            });
        } else {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const vehicleId = checkbox.id.replace('vehicle_', '');
                selectedVehicles.delete(vehicleId);
                checkbox.closest('.vehicle-check-item').classList.remove('selected');
            });
        }

        updateUIState();
    });
}

function setupEventListeners() {
    // Кнопка загрузки аналитики
    document.getElementById('loadAnalyticsBtn').addEventListener('click', loadAnalytics);
}

function setDefaultDates() {
    const endDate = document.getElementById('endDate');
    const startDate = document.getElementById('startDate');

    if (!endDate.value) {
        const today = new Date().toISOString().split('T')[0];
        endDate.value = today;
    }

    if (!startDate.value) {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        startDate.value = weekAgo.toISOString().split('T')[0];
    }
}

async function loadAnalytics() {
    if (!validateSelection()) {
        return;
    }

    showLoadingState();

    try {
        const dateRange = getDateRange();
        const analyticsData = await fetchAnalyticsData(dateRange);

        if (analyticsData.success) {
            renderAnalytics(analyticsData.analytics_data);
            showAlert('Аналитика успешно загружена', 'success');
        } else {
            throw new Error(analyticsData.error || 'Unknown error');
        }

    } catch (error) {
        console.error('Ошибка загрузки аналитики:', error);
        showAlert('Ошибка загрузки аналитики: ' + error.message, 'danger');
        showEmptyState();
    }
}

async function fetchAnalyticsData(dateRange) {
    const response = await fetch('/api/vehicles/analytics/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            vehicle_ids: Array.from(selectedVehicles),
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda', // Можно сделать динамическим
            dashboard_type: selectedDashboard,
            start_date: dateRange.start,
            end_date: dateRange.end,
            interval_type: selectedInterval
        })
    });

    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    return await response.json();
}

function renderAnalytics(analyticsData) {
    // Здесь будет рендеринг аналитики
    // Пока заглушка
    document.getElementById('analyticsContainer').style.display = 'block';

    // Пример рендеринга сводных метрик
    renderSummaryMetrics(analyticsData.summary || {});

    // Пример рендеринга графика
    renderTimeSeriesChart(analyticsData.time_series || {});

    // Пример рендеринга таблицы
    renderDetailsTable(analyticsData.vehicles_data || {});
}

function renderSummaryMetrics(summary) {
    const container = document.getElementById('summaryMetrics');
    // Заглушка - в реальности здесь будет рендеринг метрик
    container.innerHTML = `
        <div class="col-md-3">
            <div class="metric-card bg-light">
                <i class="fas fa-gas-pump text-primary fa-2x"></i>
                <div class="metric-value">-</div>
                <div class="metric-label">Расход топлива</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-light">
                <i class="fas fa-road text-success fa-2x"></i>
                <div class="metric-value">-</div>
                <div class="metric-label">Пробег</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-light">
                <i class="fas fa-clock text-warning fa-2x"></i>
                <div class="metric-value">-</div>
                <div class="metric-label">Моточасы</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card bg-light">
                <i class="fas fa-tachometer-alt text-info fa-2x"></i>
                <div class="metric-value">-</div>
                <div class="metric-label">Средняя скорость</div>
            </div>
        </div>
    `;
}

function renderTimeSeriesChart(timeSeries) {
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');

    // Уничтожаем старый график
    if (currentChart) {
        currentChart.destroy();
    }

    // Заглушка - в реальности здесь будет рендеринг графика
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
            datasets: [{
                label: 'Пример данных',
                data: [65, 59, 80, 81, 56, 55, 40],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

function renderDetailsTable(vehiclesData) {
    const table = document.getElementById('detailsTable');
    // Заглушка - в реальности здесь будет рендеринг таблицы
    table.innerHTML = `
        <thead>
            <tr>
                <th>Транспортное средство</th>
                <th>Статус</th>
                <th>Данные</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Тестовые данные</td>
                <td><span class="badge bg-success">Загружено</span></td>
                <td>Реализация в разработке</td>
            </tr>
        </tbody>
    `;
}

// Вспомогательные функции
function validateSelection() {
    if (!selectedDashboard) {
        showAlert('Выберите тип дашборда', 'warning');
        return false;
    }

    if (selectedVehicles.size === 0) {
        showAlert('Выберите хотя бы одно транспортное средство', 'warning');
        return false;
    }

    const dateRange = getDateRange();
    if (!dateRange.start || !dateRange.end) {
        showAlert('Выберите период дат', 'warning');
        return false;
    }

    return true;
}

function updateUIState() {
    const hasSelection = selectedDashboard && selectedVehicles.size > 0;
    const loadBtn = document.getElementById('loadAnalyticsBtn');

    loadBtn.disabled = !hasSelection;
}

function updateSelectAllCheckbox() {
    const selectAll = document.getElementById('selectAllVehicles');
    const checkboxes = document.querySelectorAll('.vehicle-checkbox');
    const checkedCount = document.querySelectorAll('.vehicle-checkbox:checked').length;

    selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
    selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
}

function showLoadingState() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('analyticsContainer').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
}

function showEmptyState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('analyticsContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
}

function showAlert(message, type) {
    const alert = document.getElementById('infoAlert');
    const messageEl = document.getElementById('alertMessage');

    alert.className = `alert alert-${type} alert-dismissible fade show`;
    messageEl.textContent = message;
    alert.style.display = 'block';

    // Автоматически скрыть через 5 секунд
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

function getDateRange() {
    return {
        start: document.getElementById('startDate').value,
        end: document.getElementById('endDate').value
    };
}

function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}