<!DOCTYPE html>
<html>
<head>
    <title>AutoGRAPH Debug Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 1rem; }
        .success { border-left: 4px solid #28a745; }
        .warning { border-left: 4px solid #ffc107; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 0.25rem; font-size: 0.8rem; }
        .badge { font-size: 0.8em; }
        .table-sm { font-size: 0.875rem; }
        .loading { opacity: 0.6; }
        .trip-count { font-weight: bold; color: #28a745; }
        .data-source { font-size: 0.8em; padding: 0.2em 0.5em; border-radius: 0.25em; }
        .data-source-real { background: #d4edda; color: #155724; }
        .data-source-basic { background: #fff3cd; color: #856404; }
        .data-source-empty { background: #f8d7da; color: #721c24; }
        .data-source-simple { background: #cce7ff; color: #004085; }
        .data-source-total-only { background: #d1ecf1; color: #0c5460; }
        .data-source-real-trips { background: #d4edda; color: #155724; }
        .transformation-success { color: #28a745; }
        .transformation-failed { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="mb-4">üöó AutoGRAPH Debug Dashboard</h1>

        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div class="row">
            <div class="col-12">
                <div class="card success">
                    <div class="card-body">
                        <h5 class="card-title">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AutoGRAPH</h5>
                        <div id="connection-status">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –¢–° -->
        <div class="row">
            <div class="col-12">
                <div class="card info">
                    <div class="card-body">
                        <h5 class="card-title">üìã –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</h5>
                        <div id="vehicles-list">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–µ—Å—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">üìä –¢–µ—Å—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã)</h5>
                        <div id="historical-tests">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="row">
            <div class="col-12">
                <div class="card info">
                    <div class="card-body">
                        <h5 class="card-title">‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã)</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>–°–ø–∏—Å–æ–∫ –¢–°</h6>
                                        <button class="btn btn-sm btn-primary" onclick="testEndpoint('/vehicles/api/list/', 'test-list-result')">–¢–µ—Å—Ç</button>
                                        <div id="test-list-result" class="mt-2 small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>7 –¥–Ω–µ–π</h6>
                                        <button class="btn btn-sm btn-primary" onclick="testHistorical(7)">–¢–µ—Å—Ç</button>
                                        <div id="test-historical-result-7" class="mt-2 small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>30 –¥–Ω–µ–π</h6>
                                        <button class="btn btn-sm btn-primary" onclick="testHistorical(30)">–¢–µ—Å—Ç</button>
                                        <div id="test-historical-result-30" class="mt-2 small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>90 –¥–Ω–µ–π</h6>
                                        <button class="btn btn-sm btn-primary" onclick="testHistorical(90)">–¢–µ—Å—Ç</button>
                                        <div id="test-historical-result-90" class="mt-2 small"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw –¥–∞–Ω–Ω—ã–µ -->
        <div class="row">
            <div class="col-12">
                <div class="card warning">
                    <div class="card-body">
                        <h5 class="card-title">üîß Raw –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h5>
                        <button class="btn btn-sm btn-outline-primary mb-3" onclick="toggleRawData()">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å Raw –¥–∞–Ω–Ω—ã–µ</button>
                        <div id="raw-data" style="display: none;">
                            <pre id="raw-data-content">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        async function loadExtendedDebug() {
            try {
                showLoading();
                const response = await fetch('/vehicles/api/debug/extended/');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                renderDebugData(data);
            } catch (error) {
                console.error('Error loading debug data:', error);
                document.getElementById('connection-status').innerHTML =
                    '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</div>';
                document.getElementById('vehicles-list').innerHTML = '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¢–°</div>';
                document.getElementById('historical-tests').innerHTML = '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        function showLoading() {
            document.getElementById('connection-status').innerHTML =
                '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('vehicles-list').innerHTML =
                '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('historical-tests').innerHTML =
                '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        function renderDebugData(data) {
            console.log('Debug data received:', data);

            // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectionStatus = data.service_status?.login === 'success'
                ? '<div class="alert alert-success">‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AutoGRAPH API</div>'
                : '<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AutoGRAPH API</div>';
            document.getElementById('connection-status').innerHTML = connectionStatus;

            // –°–ø–∏—Å–æ–∫ –¢–°
            const vehicles = data.available_data?.formatted_vehicles || [];
            let vehiclesHtml = `<p>–ù–∞–π–¥–µ–Ω–æ –¢–°: <span class="badge bg-primary">${vehicles.length}</span></p>`;

            if (vehicles.length > 0) {
                vehiclesHtml += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ì–æ—Å–Ω–æ–º–µ—Ä</th><th>Serial</th></tr></thead><tbody>';
                vehicles.forEach(vehicle => {
                    vehiclesHtml += `<tr>
                        <td><code class="small">${vehicle.id}</code></td>
                        <td>${vehicle.name}</td>
                        <td>${vehicle.license_plate}</td>
                        <td>${vehicle.serial || '-'}</td>
                    </tr>`;
                });
                vehiclesHtml += '</tbody></table></div>';
            } else {
                vehiclesHtml += '<div class="alert alert-warning">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö</div>';
            }

            document.getElementById('vehicles-list').innerHTML = vehiclesHtml;

            // –¢–µ—Å—Ç—ã –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            const historicalTests = data.available_data?.historical_tests || {};
            let testsHtml = '';

            if (Object.keys(historicalTests).length === 0) {
                testsHtml = '<div class="alert alert-warning">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>';
            } else {
                Object.entries(historicalTests).forEach(([vehicleId, test]) => {
                    testsHtml += `<div class="card mb-4">
                        <div class="card-header">
                            <h6>üöó ${test.vehicle_name}</h6>
                            <small class="text-muted">ID: <code>${vehicleId}</code></small>
                        </div>
                        <div class="card-body">`;

                    const periodTests = test.period_tests || {};

                    if (Object.keys(periodTests).length === 0) {
                        testsHtml += '<div class="alert alert-warning">‚ö†Ô∏è –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –ø–µ—Ä–∏–æ–¥–æ–≤</div>';
                    } else {
                        Object.entries(periodTests).forEach(([periodName, periodTest]) => {
                            const hasTrips = periodTest.has_trips || periodTest.trips_count > 0;
                            const hasSummary = periodTest.has_summary;
                            const transformationSuccess = periodTest.transformation_success;
                            const dataSource = periodTest.data_source || 'unknown';

                            let statusClass = 'warning';
                            let statusIcon = '‚ö†Ô∏è';

                            if (periodTest.success) {
                                if (hasTrips && transformationSuccess) {
                                    statusClass = 'success';
                                    statusIcon = '‚úÖ';
                                } else if (hasTrips && !transformationSuccess) {
                                    statusClass = 'warning';
                                    statusIcon = '‚ö†Ô∏è';
                                } else if (transformationSuccess) {
                                    statusClass = 'info';
                                    statusIcon = '‚ÑπÔ∏è';
                                } else {
                                    statusClass = 'warning';
                                    statusIcon = '‚ö†Ô∏è';
                                }
                            } else {
                                statusClass = 'danger';
                                statusIcon = '‚ùå';
                            }

                            const dataSourceClass = `data-source data-source-${dataSource.replace('autograph_', '').replace('_', '-')}`;
                            const transformationClass = transformationSuccess ? 'transformation-success' : 'transformation-failed';
                            const transformationText = transformationSuccess ? '–£—Å–ø–µ—à–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å';

                            testsHtml += `<div class="card mb-3 ${statusClass}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6>${statusIcon} ${periodName}</h6>
                                        <span class="${dataSourceClass}">${dataSource}</span>
                                    </div>
                                    <p><small class="text-muted">–ü–µ—Ä–∏–æ–¥: ${periodTest.period || 'N/A'}</small></p>`;

                            testsHtml += `<p>
                                <span class="trip-count">–†–µ–π—Å–æ–≤: ${periodTest.trips_count}</span> |
                                <span class="${transformationClass}">–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è: ${transformationText}</span> |
                                Summary: ${hasSummary ? '‚úÖ' : '‚ùå'}
                            </p>`;

                            if (periodTest.sample_data) {
                                testsHtml += `<div class="mt-2 p-2 bg-light rounded">
                                    <strong>–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                                    <pre class="small">${JSON.stringify(periodTest.sample_data, null, 2)}</pre>
                                </div>`;
                            }

                            if (periodTest.raw_trips_data) {
                                const rawData = periodTest.raw_trips_data;
                                testsHtml += `<div class="mt-2 p-2 bg-light rounded">
                                    <strong>Raw –¥–∞–Ω–Ω—ã–µ API:</strong><br>
                                    –ú–µ—Ç–æ–¥: ${rawData.api_method}<br>
                                    –¢–∏–ø: ${rawData.data_type}<br>
                                    –ö–ª—é—á–∏: ${JSON.stringify(rawData.keys)}<br>
                                    –ö–ª—é—á–∏ vehicle: ${JSON.stringify(rawData.vehicle_data_keys)}<br>
                                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Å–æ–≤: <strong class="trip-count">${rawData.trips_count}</strong><br>`;

                                if (rawData.formatted_dates_used) {
                                    testsHtml += `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã: ${JSON.stringify(rawData.formatted_dates_used)}<br>`;
                                }

                                testsHtml += `</div>`;
                            } else if (periodTest.raw_trips_error) {
                                testsHtml += `<div class="mt-2 p-2 bg-warning rounded">–û—à–∏–±–∫–∞ raw –¥–∞–Ω–Ω—ã—Ö: ${periodTest.raw_trips_error}</div>`;
                            }

                            testsHtml += `</div></div>`;
                        });
                    }

                    testsHtml += `</div></div>`;
                });
            }

            document.getElementById('historical-tests').innerHTML = testsHtml;

            // Raw –¥–∞–Ω–Ω—ã–µ
            document.getElementById('raw-data-content').textContent = JSON.stringify(data, null, 2);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testEndpoint(url, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.innerHTML = '<div class="text-warning">‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';

            try {
                const response = await fetch(url);
                const data = await response.json();
                resultElement.innerHTML = `<div class="text-success">‚úÖ –£—Å–ø–µ—Ö! –¢–°: ${data.vehicles?.length || 0}</div>`;
            } catch (error) {
                resultElement.innerHTML = `<div class="text-danger">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testHistorical(days) {
            const resultElement = document.getElementById(`test-historical-result-${days}`);
            resultElement.innerHTML = '<div class="text-warning">‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';

            // –í—ã—á–∏—Å–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - days);

            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];

            try {
                const response = await fetch(`/vehicles/api/statistics/?vehicle_id=8570f4fd-ee21-431c-8412-9b4b54e955af&start_date=${startStr}&end_date=${endStr}`);
                const data = await response.json();
                if (data.success) {
                    const tripsCount = data.trips_count || 0;
                    const dataSource = data.data_source || 'unknown';
                    const transformationSuccess = data.transformation_success || false;
                    resultElement.innerHTML = `
                        <div class="text-success">
                            ‚úÖ –£—Å–ø–µ—Ö!
                            <br>–ü–µ—Ä–∏–æ–¥: ${startStr} - ${endStr}
                            <br>–ò—Å—Ç–æ—á–Ω–∏–∫: <span class="badge bg-success">${dataSource}</span>
                            <br>–†–µ–π—Å–æ–≤: <span class="trip-count">${tripsCount}</span>
                            <br>–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è: <span class="${transformationSuccess ? 'transformation-success' : 'transformation-failed'}">${transformationSuccess ? '–£—Å–ø–µ—à–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å'}</span>
                        </div>`;
                } else {
                    resultElement.innerHTML = `<div class="text-danger">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            } catch (error) {
                resultElement.innerHTML = `<div class="text-danger">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        function toggleRawData() {
            const rawData = document.getElementById('raw-data');
            rawData.style.display = rawData.style.display === 'none' ? 'block' : 'none';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadExtendedDebug();
        });
    </script>
</body>
</html>