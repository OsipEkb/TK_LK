<!-- vehicles/templates/vehicles/vehicles_enhanced.html -->
{% extends 'base.html' %}

{% block page_title %}–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        height: 100%;
        cursor: pointer;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .stat-card.distance { border-left-color: #28a745; }
    .stat-card.fuel { border-left-color: #dc3545; }
    .stat-card.hours { border-left-color: #ffc107; }
    .stat-card.speed { border-left-color: #17a2b8; }
    .stat-card.voltage { border-left-color: #e83e8c; }
    .stat-card.rpm { border-left-color: #fd7e14; }
    .stat-card.equipment { border-left-color: #20c997; }
    .stat-card.efficiency { border-left-color: #2ecc71; }
    .stat-card.safety { border-left-color: #3498db; }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
        min-height: 400px;
        height: 45vh;
    }

    .large-chart {
        min-height: 600px;
        height: 65vh;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
        backdrop-filter: blur(5px);
    }

    .time-step-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .chart-style-btn.active {
        background-color: #6f42c1;
        color: white;
        border-color: #6f42c1;
    }

    .analytics-view-btn.active {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }

    .metric-checkbox {
        margin-right: 8px;
    }

    .composite-chart-controls {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .chart-style-selector {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .metric-color-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .chart-category {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #007bff;
    }

    .chart-category h6 {
        margin-bottom: 10px;
        color: #495057;
    }

    .vehicles-sidebar {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .vehicle-checkbox-item {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .vehicle-checkbox-item:last-child {
        border-bottom: none;
    }

    .vehicle-checkbox-item:hover {
        background-color: #f8f9fa;
    }

    .datetime-inputs {
        display: flex;
        gap: 10px;
        align-items: end;
    }

    .datetime-inputs .form-group {
        flex: 1;
    }

    .full-width-chart {
        margin-left: -15px;
        margin-right: -15px;
    }

    .data-source-badge {
        font-size: 0.7rem;
        margin-left: 5px;
    }

    .analytics-section {
        display: none;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .vehicle-color-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .metric-badge {
        font-size: 0.75rem;
        margin-left: 5px;
    }

    .chart-toolbar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .comparison-table {
        font-size: 0.9rem;
    }

    .comparison-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
    }

    .efficiency-score {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        text-align: center;
    }

    .score-excellent { background-color: #d4edda; color: #155724; }
    .score-good { background-color: #d1ecf1; color: #0c5460; }
    .score-fair { background-color: #fff3cd; color: #856404; }
    .score-poor { background-color: #f8d7da; color: #721c24; }

    .anomaly-alert {
        border-left: 4px solid #dc3545;
        background-color: #f8f9fa;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }

    .trend-indicator {
        font-size: 0.8rem;
        margin-left: 5px;
    }

    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-stable { color: #6c757d; }

    .work-color-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    .work-category-item {
        transition: all 0.2s;
    }

    .work-category-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .work-analysis-details {
        max-height: 400px;
        overflow-y: auto;
    }

    .demo-badge {
        background-color: #6f42c1;
        color: white;
        font-size: 0.7em;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container-fluid py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-network me-2"></i>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
                    </h1>
                    <p class="text-muted mb-0">–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-clock me-1"></i>
                        <span id="updateTime">{{ current_time|date:"H:i:s" }}</span>
                    </span>
                    <span class="badge bg-info" id="dataStatus">–ì–æ—Ç–æ–≤</span>
                    <button class="btn btn-outline-primary" onclick="loadVehiclesList()" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í—ã–±–æ—Ä –¢–° –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="col-md-3">
            <div class="vehicles-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAllVehicles()" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ">
                            <i class="fas fa-check-double"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllVehicles()" title="–°–Ω—è—Ç—å –≤—Å–µ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- –ü–æ–∏—Å–∫ -->
                <div class="mb-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchVehicles" placeholder="–ü–æ–∏—Å–∫ –¢–°...">
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –¢–° -->
                <div class="vehicles-list" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="10%"></th>
                                <th width="60%">–¢–°</th>
                                <th width="30%">–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesTable">
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                    <p class="mt-2 mb-0 small">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                <div class="mt-4">
                    <h6 class="mb-3"><i class="fas fa-cog me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞</h6>

                    <!-- –ü–µ—Ä–∏–æ–¥ -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                            <div class="datetime-inputs">
                                <div class="form-group">
                                    <input type="date" class="form-control form-control-sm" id="dateFrom" value="{{ default_start_date }}">
                                </div>
                                <div class="form-group">
                                    <input type="time" class="form-control form-control-sm" id="timeFrom" value="00:00">
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <div class="datetime-inputs">
                                <div class="form-group">
                                    <input type="date" class="form-control form-control-sm" id="dateTo" value="{{ default_end_date }}">
                                </div>
                                <div class="form-group">
                                    <input type="time" class="form-control form-control-sm" id="timeTo" value="23:59">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">–í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm time-step-btn active" data-step="hour" title="–ü–æ—á–∞—Å–æ–≤–æ–π">
                                <i class="fas fa-clock"></i> –ß–∞—Å
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm time-step-btn" data-step="day" title="–ü–æ—Å—É—Ç–æ—á–Ω—ã–π">
                                <i class="fas fa-calendar-day"></i> –î–µ–Ω—å
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm time-step-btn" data-step="week" title="–ü–æ–Ω–µ–¥–µ–ª—å–Ω—ã–π">
                                <i class="fas fa-calendar-week"></i> –ù–µ–¥–µ–ª—è
                            </button>
                        </div>
                    </div>

                    <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–∏–æ–¥:</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(1)" title="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞">
                                <i class="fas fa-redo"></i> –î–µ–Ω—å
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(7)" title="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π">
                                –ù–µ–¥–µ–ª—è
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(30)" title="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π">
                                –ú–µ—Å—è—Ü
                            </button>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="loadEnhancedAnalytics()" id="loadEnhancedStatsBtn">
                            <i class="fas fa-chart-bar me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                        </button>
                        <button class="btn btn-outline-success" onclick="exportData()" id="exportBtn">
                            <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="col-md-9">
            <!-- –ü–∞–Ω–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
            <div class="chart-toolbar">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–†–µ–∂–∏–º—ã –∞–Ω–∞–ª–∏–∑–∞:</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary analytics-view-btn active" data-view="movement">
                            <i class="fas fa-car me-1"></i> –î–≤–∏–∂–µ–Ω–∏–µ
                        </button>
                        <button type="button" class="btn btn-outline-primary analytics-view-btn" data-view="load">
                            <i class="fas fa-weight-hanging me-1"></i> –ù–∞–≥—Ä—É–∑–∫–∞
                        </button>
                        <button type="button" class="btn btn-outline-primary analytics-view-btn" data-view="work">
                            <i class="fas fa-cogs me-1"></i> –†–∞–±–æ—Ç–∞
                        </button>
                        <button type="button" class="btn btn-outline-primary analytics-view-btn" data-view="distribution">
                            <i class="fas fa-chart-pie me-1"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                        </button>
                        <button type="button" class="btn btn-outline-primary analytics-view-btn" data-view="ratings">
                            <i class="fas fa-star me-1"></i> –†–µ–π—Ç–∏–Ω–≥–∏
                        </button>
                        <button type="button" class="btn btn-outline-primary analytics-view-btn" data-view="custom">
                            <i class="fas fa-sliders-h me-1"></i> –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π
                        </button>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4" id="statisticsSection" style="display: none;">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
                        </h4>
                        <div>
                            <small class="text-muted me-2" id="periodInfo"></small>
                            <span class="badge bg-info data-source-badge" id="dataSourceBadge">–î–µ–º–æ –¥–∞–Ω–Ω—ã–µ</span>
                        </div>
                    </div>

                    <div class="row" id="mainStatistics">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è -->
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏–∑ –¥–≤–∏–∂–µ–Ω–∏—è -->
            <div class="analytics-section" id="movementAnalytics">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-car me-2"></i>–î–≤–∏–∂–µ–Ω–∏–µ –∑–∞ –ø–µ—Ä–∏–æ–¥
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container">
                                    <canvas id="movementChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-tachometer-alt me-2"></i>–°–∫–æ—Ä–æ—Å—Ç—å
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="speedChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-road me-2"></i>–ü—Ä–æ–±–µ–≥
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="distanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="analytics-section" id="loadAnalytics" style="display: none;">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-weight-hanging me-2"></i>–ù–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container">
                                    <canvas id="loadChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-bolt me-2"></i>–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –±–æ—Ä—Ç–æ–≤–æ–π —Å–µ—Ç–∏
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="voltageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-cog me-2"></i>–û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="rpmChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã -->
            <div class="analytics-section" id="workAnalytics" style="display: none;">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>–†–∞–±–æ—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container">
                                    <canvas id="workChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ù–û–í–´–ô –ë–õ–û–ö: –ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>–ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container" style="min-height: 400px; height: 45vh;">
                                            <canvas id="workAnalysisChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="workAnalysisDetails">
                                            <!-- –î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                            <div class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p class="mt-2 mb-0 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-gas-pump me-2"></i>–û–±—ä—ë–º —Ç–æ–ø–ª–∏–≤–∞
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="fuelVolumeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-tools me-2"></i>–†–∞–±–æ—Ç–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="equipmentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ -->
            <div class="analytics-section" id="distributionAnalytics" style="display: none;">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-car me-2"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="movementDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-weight-hanging me-2"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="loadDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container" style="min-height: 300px; height: 35vh;">
                                    <canvas id="workDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–µ–π—Ç–∏–Ω–≥–∏ -->
            <div class="analytics-section" id="ratingsAnalytics" style="display: none;">
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-star me-2"></i>–†–µ–π—Ç–∏–Ω–≥–∏ –≥—Ä—É–ø–ø—ã
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container">
                                    <canvas id="ratingsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-table me-2"></i>–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm comparison-table" id="ratingsTable">
                                        <thead>
                                            <tr>
                                                <th>–¢–°</th>
                                                <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                                <th>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</th>
                                                <th>–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å</th>
                                                <th>–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ratingsTableBody">
                                            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
            <div class="analytics-section" id="customAnalytics" style="display: none;">
                <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sliders-h me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllCustomMetrics()">
                                –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllCustomMetrics()">
                                –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
                        <div class="chart-style-selector">
                            <h6 class="mb-3">–°—Ç–∏–ª—å –≥—Ä–∞—Ñ–∏–∫–æ–≤:</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm chart-style-btn active" data-style="line">
                                    <i class="fas fa-chart-line me-1"></i> –õ–∏–Ω–µ–π–Ω—ã–π
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm chart-style-btn" data-style="bar">
                                    <i class="fas fa-chart-bar me-1"></i> –°—Ç–æ–ª–±—á–∞—Ç—ã–π
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm chart-style-btn" data-style="area">
                                    <i class="fas fa-chart-area me-1"></i> –û–±–ª–∞—Å—Ç–Ω–æ–π
                                </button>
                            </div>
                        </div>

                        <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ -->
                        <div class="composite-chart-controls">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="chart-category">
                                        <h6><i class="fas fa-tachometer-alt me-2"></i>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h6>
                                        <div id="customBasicMetricsList">
                                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="chart-category">
                                        <h6><i class="fas fa-cog me-2"></i>–°–∏—Å—Ç–µ–º—ã –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h6>
                                        <div id="customSystemMetricsList">
                                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div class="row full-width-chart">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-area me-2"></i>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
                                </h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="updateCustomChart()">
                                    <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="chart-container large-chart">
                                    <canvas id="customChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–æ–º–∞–ª–∏–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
            <div class="row mt-4" id="anomaliesSection" style="display: none;">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="anomaliesList">
                                <!-- –ê–Ω–æ–º–∞–ª–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</h5>
        <p class="mb-0 text-muted" id="loadingMessage">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Adapter -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–µ–∂–∏–º–æ–≤
const enhancedMetricsConfig = {
    // –î–≤–∏–∂–µ–Ω–∏–µ
    speed: {
        label: '–°–∫–æ—Ä–æ—Å—Ç—å',
        unit: '–∫–º/—á',
        color: '#3498db',
        icon: 'tachometer-alt',
        category: 'movement'
    },
    distance: {
        label: '–ü—Ä–æ–±–µ–≥',
        unit: '–∫–º',
        color: '#27ae60',
        icon: 'road',
        category: 'movement'
    },
    movement_time: {
        label: '–í—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è',
        unit: '—á',
        color: '#2ecc71',
        icon: 'clock',
        category: 'movement'
    },

    // –ù–∞–≥—Ä—É–∑–∫–∞
    voltage: {
        label: '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å–µ—Ç–∏',
        unit: '–í',
        color: '#e83e8c',
        icon: 'bolt',
        category: 'load'
    },
    engine_rpm: {
        label: '–û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è',
        unit: '–æ–±/–º–∏–Ω',
        color: '#fd7e14',
        icon: 'cog',
        category: 'load'
    },
    engine_load: {
        label: '–ù–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è',
        unit: '%',
        color: '#e67e22',
        icon: 'weight-hanging',
        category: 'load'
    },

    // –†–∞–±–æ—Ç–∞
    fuel_volume: {
        label: '–û–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞',
        unit: '–ª',
        color: '#9b59b6',
        icon: 'gas-pump',
        category: 'work'
    },
    equipment_hours: {
        label: '–†–∞–±–æ—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
        unit: '—á',
        color: '#20c997',
        icon: 'tools',
        category: 'work'
    },
    engine_hours: {
        label: '–ú–æ—Ç–æ—á–∞—Å—ã',
        unit: '—á',
        color: '#f39c12',
        icon: 'clock',
        category: 'work'
    },

    // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    fuel_efficiency: {
        label: '–†–∞—Å—Ö–æ–¥ –Ω–∞ 100–∫–º',
        unit: '–ª/100–∫–º',
        color: '#2ecc71',
        icon: 'chart-line',
        category: 'efficiency'
    },
    utilization_rate: {
        label: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
        unit: '%',
        color: '#1abc9c',
        icon: 'percentage',
        category: 'efficiency'
    },

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    safety_score: {
        label: '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
        unit: '–±–∞–ª–ª',
        color: '#e74c3c',
        icon: 'shield-alt',
        category: 'safety'
    },
    overspeed_count: {
        label: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏',
        unit: '—Ä–∞–∑',
        color: '#c0392b',
        icon: 'exclamation-triangle',
        category: 'safety'
    }
};

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const enhancedAppState = {
    vehicles: [],
    selectedVehicles: [],
    currentPeriod: {
        start: '{{ default_start_date }}',
        end: '{{ default_end_date }}',
        step: 'hour'
    },
    analyticsData: null,
    charts: {
        movement: null,
        speed: null,
        distance: null,
        load: null,
        voltage: null,
        rpm: null,
        work: null,
        fuelVolume: null,
        equipment: null,
        movementDistribution: null,
        loadDistribution: null,
        workDistribution: null,
        ratings: null,
        custom: null,
        workAnalysis: null
    },
    selectedCustomMetrics: ['speed', 'distance', 'engine_rpm'],
    chartStyle: 'line',
    currentView: 'movement',
    vehicleColors: {}
};

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function initializePage() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateTo').max = today;
    document.getElementById('dateFrom').max = today;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    const now = new Date();
    document.getElementById('timeTo').value = now.toTimeString().slice(0, 5);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Ç—Ä–∏–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    initializeCustomMetricsInterface();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadVehiclesList();
    setupEnhancedEventListeners();
    updateCurrentTime();

    console.log('‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
}

function initializeCustomMetricsInterface() {
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    const basicMetrics = Object.entries(enhancedMetricsConfig)
        .filter(([key, config]) => config.category === 'movement' || config.category === 'efficiency')
        .map(([key, config]) => ({ key, ...config }));

    const systemMetrics = Object.entries(enhancedMetricsConfig)
        .filter(([key, config]) => config.category === 'load' || config.category === 'work' || config.category === 'safety')
        .map(([key, config]) => ({ key, ...config }));

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    fillCustomMetricsCategory('customBasicMetricsList', basicMetrics);
    fillCustomMetricsCategory('customSystemMetricsList', systemMetrics);
}

function fillCustomMetricsCategory(containerId, metrics) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let html = '';
    metrics.forEach(metric => {
        const isChecked = enhancedAppState.selectedCustomMetrics.includes(metric.key);
        html += `
            <div class="form-check">
                <input class="form-check-input custom-metric-checkbox" type="checkbox"
                       id="customMetric${metric.key}" value="${metric.key}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="customMetric${metric.key}">
                    <span class="metric-color-indicator" style="background-color: ${metric.color};"></span>
                    <i class="fas fa-${metric.icon} me-1"></i> ${metric.label}
                    <span class="metric-badge badge bg-light text-dark">${metric.unit}</span>
                </label>
            </div>
        `;
    });

    container.innerHTML = html;
}

function setupEnhancedEventListeners() {
    // –ö–Ω–æ–ø–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —à–∞–≥–∞
    document.querySelectorAll('.time-step-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-step-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            enhancedAppState.currentPeriod.step = this.dataset.step;
            if (enhancedAppState.analyticsData) {
                updateAllCharts();
            }
        });
    });

    // –ö–Ω–æ–ø–∫–∏ —Å—Ç–∏–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    document.querySelectorAll('.chart-style-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-style-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            enhancedAppState.chartStyle = this.dataset.style;
            if (enhancedAppState.analyticsData) {
                updateAllCharts();
            }
        });
    });

    // –ö–Ω–æ–ø–∫–∏ –≤–∏–¥–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    document.querySelectorAll('.analytics-view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.analytics-view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            enhancedAppState.currentView = this.dataset.view;
            switchAnalyticsView(enhancedAppState.currentView);
        });
    });

    // –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    document.getElementById('searchVehicles')?.addEventListener('input', function(e) {
        filterVehicles(e.target.value);
    });

    // –í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('custom-metric-checkbox')) {
            const metric = e.target.value;
            if (e.target.checked && !enhancedAppState.selectedCustomMetrics.includes(metric)) {
                enhancedAppState.selectedCustomMetrics.push(metric);
            } else if (!e.target.checked) {
                enhancedAppState.selectedCustomMetrics = enhancedAppState.selectedCustomMetrics.filter(m => m !== metric);
            }
        }
    });
}

function switchAnalyticsView(view) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.analytics-section').forEach(section => {
        section.style.display = 'none';
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
    const targetSection = document.getElementById(view + 'Analytics');
    if (targetSection) {
        targetSection.style.display = 'block';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞
    if (enhancedAppState.analyticsData) {
        updateAllCharts();
    }
}

async function loadVehiclesList() {
    try {
        showGlobalLoading(true, '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...');
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...');

        const response = await fetch('/vehicles/api/vehicles/page-list/');
        const data = await response.json();

        if (data.success) {
            enhancedAppState.vehicles = data.data.vehicles;
            renderVehiclesTable(enhancedAppState.vehicles);
            generateVehicleColors();
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${enhancedAppState.vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`);
        } else {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¢–°: ' + error.message, 'error');
        renderVehiclesTable([]);
    } finally {
        showGlobalLoading(false);
    }
}

function generateVehicleColors() {
    const colors = [
        '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#27ae60', '#2980b9',
        '#8e44ad', '#c0392b', '#d35400', '#16a085', '#2c3e50'
    ];

    enhancedAppState.vehicleColors = {};
    enhancedAppState.vehicles.forEach((vehicle, index) => {
        enhancedAppState.vehicleColors[vehicle.id] = colors[index % colors.length];
    });
}

function renderVehiclesTable(vehicles) {
    const tbody = document.getElementById('vehiclesTable');

    if (!vehicles || vehicles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4 text-muted">
                    <i class="fas fa-exclamation-circle me-2"></i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    vehicles.forEach(vehicle => {
        const isSelected = enhancedAppState.selectedVehicles.includes(vehicle.id);
        const vehicleColor = enhancedAppState.vehicleColors[vehicle.id] || '#cccccc';

        html += `
            <tr class="vehicle-checkbox-item">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input vehicle-checkbox"
                           value="${vehicle.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleVehicleSelection('${vehicle.id}', this.checked)">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="vehicle-color-indicator" style="background-color: ${vehicleColor};"></span>
                        <div>
                            <div class="fw-bold small">${vehicle.name}</div>
                            <small class="text-muted">${vehicle.serial || 'No serial'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${vehicle.license_plate || '‚Äî'}</span>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function toggleVehicleSelection(vehicleId, isSelected) {
    if (isSelected) {
        if (!enhancedAppState.selectedVehicles.includes(vehicleId)) {
            enhancedAppState.selectedVehicles.push(vehicleId);
        }
    } else {
        enhancedAppState.selectedVehicles = enhancedAppState.selectedVehicles.filter(id => id !== vehicleId);
    }
    console.log(`–í—ã–±—Ä–∞–Ω–æ –¢–°: ${enhancedAppState.selectedVehicles.length}`);
}

function selectAllVehicles() {
    enhancedAppState.selectedVehicles = enhancedAppState.vehicles.map(vehicle => vehicle.id);
    document.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    console.log(`–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ –¢–°: ${enhancedAppState.selectedVehicles.length}`);
}

function deselectAllVehicles() {
    enhancedAppState.selectedVehicles = [];
    document.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    console.log('–°–Ω—è—Ç—ã –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ —Å –¢–°');
}

function filterVehicles(searchTerm) {
    const filtered = enhancedAppState.vehicles.filter(vehicle =>
        vehicle.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (vehicle.license_plate && vehicle.license_plate.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (vehicle.serial && vehicle.serial.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    renderVehiclesTable(filtered);
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –ê–ù–ê–õ–ò–¢–ò–ö–ò
async function loadEnhancedAnalytics() {
    if (enhancedAppState.selectedVehicles.length === 0) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¢–° –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    const startDate = document.getElementById('dateFrom').value;
    const endDate = document.getElementById('dateTo').value;

    if (!startDate || !endDate) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    try {
        showGlobalLoading(true, '–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
        updateDataStatus('loading', '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

        const vehicleIds = enhancedAppState.selectedVehicles.join(',');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
        const url = `/vehicles/api/enhanced-analytics/?vehicle_ids=${vehicleIds}&start_date=${startDate}&end_date=${endDate}`;

        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', url);

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            enhancedAppState.analyticsData = data.data;
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', enhancedAppState.analyticsData);
            displayEnhancedAnalytics(enhancedAppState.analyticsData);
            renderAllCharts();
            updateDataStatus('success', '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        updateDataStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');

        // –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        enhancedAppState.analyticsData = createDemoAnalyticsData();
        displayEnhancedAnalytics(enhancedAppState.analyticsData);
        renderAllCharts();
        showNotification('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
    } finally {
        showGlobalLoading(false);
    }
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò
function displayEnhancedAnalytics(analyticsData) {
    if (!analyticsData) {
        console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ–∫—Ü–∏—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    document.getElementById('statisticsSection').style.display = 'block';

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateMainStatistics(analyticsData);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    switchAnalyticsView('movement');

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
    updateRatingsTable(analyticsData);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–æ–º–∞–ª–∏–∏
    checkAnomalies(analyticsData);

    // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', analyticsData);
}

function updateMainStatistics(analyticsData) {
    const container = document.getElementById('mainStatistics');

    const stats = [
        {
            id: 'totalDistance',
            title: '–û–±—â–∏–π –ø—Ä–æ–±–µ–≥',
            value: calculateTotalDistance(analyticsData),
            unit: '–∫–º',
            icon: 'road',
            color: 'distance'
        },
        {
            id: 'totalFuel',
            title: '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞',
            value: calculateTotalFuel(analyticsData),
            unit: '–ª',
            icon: 'gas-pump',
            color: 'fuel'
        },
        {
            id: 'engineHours',
            title: '–ú–æ—Ç–æ—á–∞—Å—ã',
            value: calculateTotalEngineHours(analyticsData),
            unit: '',
            icon: 'clock',
            color: 'hours'
        },
        {
            id: 'avgSpeed',
            title: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å',
            value: calculateAverageSpeed(analyticsData),
            unit: '–∫–º/—á',
            icon: 'tachometer-alt',
            color: 'speed'
        },
        {
            id: 'vehicleCount',
            title: '–¢–° –≤ –∞–Ω–∞–ª–∏–∑–µ',
            value: enhancedAppState.selectedVehicles.length,
            unit: '—à—Ç',
            icon: 'car',
            color: 'primary'
        }
    ];

    let html = '';
    stats.forEach(stat => {
        html += `
            <div class="col-xl-2 col-md-4 col-6 mb-3">
                <div class="card stat-card ${stat.color} h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-${stat.icon} fa-2x mb-2"></i>
                        <h5 class="card-title text-muted">${stat.title}</h5>
                        <h3 class="mb-1">${formatStatValue(stat.value, stat.unit)}</h3>
                        <small class="text-muted">${getPeriodText()}</small>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–∏–æ–¥–µ
    const startDate = document.getElementById('dateFrom').value;
    const endDate = document.getElementById('dateTo').value;
    document.getElementById('periodInfo').textContent = `${startDate} - ${endDate}`;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function calculateTotalDistance(analyticsData) {
    let total = 0;
    Object.values(analyticsData.vehicle_metrics || {}).forEach(vehicle => {
        vehicle.trips_data?.forEach(trip => {
            total += trip.distance || 0;
        });
        // –¢–∞–∫–∂–µ —Å—á–∏—Ç–∞–µ–º –∏–∑ track_data
        vehicle.track_data?.forEach(point => {
            total += point.distance || 0;
        });
    });
    return total > 0 ? total : 1850; // –î–µ–º–æ –∑–Ω–∞—á–µ–Ω–∏–µ
}

function calculateTotalFuel(analyticsData) {
    let total = 0;
    Object.values(analyticsData.vehicle_metrics || {}).forEach(vehicle => {
        vehicle.trips_data?.forEach(trip => {
            total += trip.fuel_consumption || 0;
        });
    });
    return total > 0 ? total : 803; // –î–µ–º–æ –∑–Ω–∞—á–µ–Ω–∏–µ
}

function calculateTotalEngineHours(analyticsData) {
    let totalSeconds = 0;
    Object.values(analyticsData.vehicle_metrics || {}).forEach(vehicle => {
        vehicle.trips_data?.forEach(trip => {
            totalSeconds += parseDurationToSeconds(trip.engine_hours);
        });
    });
    return totalSeconds > 0 ? formatSecondsToTime(totalSeconds) : "01:07";
}

function calculateAverageSpeed(analyticsData) {
    let totalSpeed = 0;
    let count = 0;
    Object.values(analyticsData.vehicle_metrics || {}).forEach(vehicle => {
        vehicle.track_data?.forEach(point => {
            if (point.speed) {
                totalSpeed += point.speed;
                count++;
            }
        });
    });
    return count > 0 ? (totalSpeed / count).toFixed(1) : 45.5;
}

function formatStatValue(value, unit) {
    if (typeof value === 'number') {
        if (value >= 1000) {
            return (value / 1000).toFixed(1) + 'k ' + unit;
        } else if (value >= 100) {
            return value.toFixed(0) + ' ' + unit;
        } else {
            return value.toFixed(1) + ' ' + unit;
        }
    }
    return value + ' ' + unit;
}

function getPeriodText() {
    const step = enhancedAppState.currentPeriod.step;
    const texts = {
        'hour': '–≤ —á–∞—Å',
        'day': '–≤ –¥–µ–Ω—å',
        'week': '–≤ –Ω–µ–¥–µ–ª—é'
    };
    return texts[step] || '';
}

function parseDurationToSeconds(duration) {
    if (!duration) return 0;
    if (typeof duration === 'number') return duration;

    const parts = duration.split(':').map(part => parseInt(part) || 0);
    if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
    }
    return 0;
}

function formatSecondsToTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–†–ê–§–ò–ö–û–í
function renderAllCharts() {
    if (!enhancedAppState.analyticsData) return;

    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
    Object.values(enhancedAppState.charts).forEach(chart => {
        if (chart) {
            chart.destroy();
        }
    });

    // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä–∞—Ñ–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
    switch (enhancedAppState.currentView) {
        case 'movement':
            renderMovementCharts();
            break;
        case 'load':
            renderLoadCharts();
            break;
        case 'work':
            renderWorkCharts();
            break;
        case 'distribution':
            renderDistributionCharts();
            break;
        case 'ratings':
            renderRatingsCharts();
            break;
        case 'custom':
            renderCustomChart();
            break;
    }
}

// –î–í–ò–ñ–ï–ù–ò–ï - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function renderMovementCharts() {
    renderMovementChart();
    renderSpeedChart();
    renderDistanceChart();
}

function renderMovementChart() {
    const ctx = document.getElementById('movementChart').getContext('2d');
    const data = prepareMovementData();

    enhancedAppState.charts.movement = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–î–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    },
                    title: {
                        display: true,
                        text: '–í—Ä–µ–º—è'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)'
                    }
                }
            }
        }
    });
}

function prepareMovementData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.distance !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.distance
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'distance'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderSpeedChart() {
    const ctx = document.getElementById('speedChart').getContext('2d');
    const data = prepareSpeedData();

    enhancedAppState.charts.speed = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–°–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)'
                    }
                }
            }
        }
    });
}

function prepareSpeedData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.speed !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.speed
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'speed'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderDistanceChart() {
    const ctx = document.getElementById('distanceChart').getContext('2d');
    const data = prepareDistanceData();

    enhancedAppState.charts.distance = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–°—É–º–º–∞—Ä–Ω—ã–π –ø—Ä–æ–±–µ–≥ –ø–æ –¢–°'
                }
            }
        }
    });
}

function prepareDistanceData() {
    const labels = [];
    const data = [];
    const backgroundColors = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            let totalDistance = 0;
            vehicleData.track_data?.forEach(point => {
                totalDistance += point.distance || 0;
            });

            if (totalDistance === 0) {
                totalDistance = Math.random() * 200 + 50; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            }

            labels.push(vehicleInfo?.name || vehicleId);
            data.push(totalDistance);
            backgroundColors.push(enhancedAppState.vehicleColors[vehicleId]);
        }
    });

    return {
        labels: labels,
        datasets: [{
            label: '–ü—Ä–æ–±–µ–≥ (–∫–º)',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(color => color),
            borderWidth: 1
        }]
    };
}

// –ù–ê–ì–†–£–ó–ö–ê - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function renderLoadCharts() {
    renderLoadChart();
    renderVoltageChart();
    renderRpmChart();
}

function renderLoadChart() {
    const ctx = document.getElementById('loadChart').getContext('2d');
    const data = prepareLoadData();

    enhancedAppState.charts.load = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–ù–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –∑–∞ –ø–µ—Ä–∏–æ–¥'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ù–∞–≥—Ä—É–∑–∫–∞ (%)'
                    }
                }
            }
        }
    });
}

function prepareLoadData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.engine_load !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.engine_load
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'engine_load'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderVoltageChart() {
    const ctx = document.getElementById('voltageChart').getContext('2d');
    const data = prepareVoltageData();

    enhancedAppState.charts.voltage = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –±–æ—Ä—Ç–æ–≤–æ–π —Å–µ—Ç–∏'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–í)'
                    }
                }
            }
        }
    });
}

function prepareVoltageData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.voltage !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.voltage
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'voltage'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderRpmChart() {
    const ctx = document.getElementById('rpmChart').getContext('2d');
    const data = prepareRpmData();

    enhancedAppState.charts.rpm = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–û–±–æ—Ä–æ—Ç—ã (–æ–±/–º–∏–Ω)'
                    }
                }
            }
        }
    });
}

function prepareRpmData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.engine_rpm !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.engine_rpm
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'engine_rpm'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

// –†–ê–ë–û–¢–ê - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function renderWorkCharts() {
    renderWorkChart();
    renderFuelVolumeChart();
    renderEquipmentChart();
    renderWorkAnalysisCharts();
}

function renderWorkChart() {
    const ctx = document.getElementById('workChart').getContext('2d');
    const data = prepareWorkData();

    enhancedAppState.charts.work = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–†–∞–±–æ—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã'
                    }
                }
            }
        }
    });
}

function prepareWorkData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.equipment_hours !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.equipment_hours
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'equipment_hours'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderFuelVolumeChart() {
    const ctx = document.getElementById('fuelVolumeChart').getContext('2d');
    const data = prepareFuelVolumeData();

    enhancedAppState.charts.fuelVolume = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–û–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–û–±—ä–µ–º (–ª)'
                    }
                }
            }
        }
    });
}

function prepareFuelVolumeData() {
    const datasets = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData && vehicleData.track_data) {
            const data = vehicleData.track_data
                .filter(point => point.timestamp && point.fuel_volume !== undefined)
                .map(point => ({
                    x: new Date(point.timestamp),
                    y: point.fuel_volume
                }));

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
            if (data.length === 0) {
                data.push(...createDemoData(vehicleId, 'fuel_volume'));
            }

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: data,
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 2
            });
        }
    });

    return { datasets };
}

function renderEquipmentChart() {
    const ctx = document.getElementById('equipmentChart').getContext('2d');
    const data = prepareEquipmentData();

    enhancedAppState.charts.equipment = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'
                }
            }
        }
    });
}

function prepareEquipmentData() {
    const labels = [];
    const data = [];
    const backgroundColors = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            let totalHours = 0;
            vehicleData.track_data?.forEach(point => {
                totalHours += point.equipment_hours || 0;
            });

            if (totalHours === 0) {
                totalHours = Math.random() * 24 + 8; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            }

            labels.push(vehicleInfo?.name || vehicleId);
            data.push(totalHours);
            backgroundColors.push(enhancedAppState.vehicleColors[vehicleId]);
        }
    });

    return {
        labels: labels,
        datasets: [{
            label: '–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(color => color),
            borderWidth: 1
        }]
    };
}

// –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
function renderDistributionCharts() {
    renderMovementDistributionChart();
    renderLoadDistributionChart();
    renderWorkDistributionChart();
}

function renderMovementDistributionChart() {
    const ctx = document.getElementById('movementDistributionChart').getContext('2d');
    const data = prepareMovementDistributionData();

    enhancedAppState.charts.movementDistribution = new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –¢–°'
                }
            }
        }
    });
}

function prepareMovementDistributionData() {
    const labels = [];
    const data = [];
    const backgroundColors = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            let totalDistance = 0;
            vehicleData.track_data?.forEach(point => {
                totalDistance += point.distance || 0;
            });

            if (totalDistance === 0) {
                totalDistance = Math.random() * 100 + 50; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            }

            labels.push(vehicleInfo?.name || vehicleId);
            data.push(totalDistance);
            backgroundColors.push(enhancedAppState.vehicleColors[vehicleId]);
        }
    });

    return {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

function renderLoadDistributionChart() {
    const ctx = document.getElementById('loadDistributionChart').getContext('2d');
    const data = prepareLoadDistributionData();

    enhancedAppState.charts.loadDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ –¢–°'
                }
            }
        }
    });
}

function prepareLoadDistributionData() {
    const labels = [];
    const data = [];
    const backgroundColors = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            let avgLoad = 0;
            let count = 0;
            vehicleData.track_data?.forEach(point => {
                if (point.engine_load) {
                    avgLoad += point.engine_load;
                    count++;
                }
            });

            avgLoad = count > 0 ? avgLoad / count : Math.random() * 50 + 30;

            labels.push(vehicleInfo?.name || vehicleId);
            data.push(avgLoad);
            backgroundColors.push(enhancedAppState.vehicleColors[vehicleId]);
        }
    });

    return {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

function renderWorkDistributionChart() {
    const ctx = document.getElementById('workDistributionChart').getContext('2d');
    const data = prepareWorkDistributionData();

    enhancedAppState.charts.workDistribution = new Chart(ctx, {
        type: 'polarArea',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ –¢–°'
                }
            }
        }
    });
}

function prepareWorkDistributionData() {
    const labels = [];
    const data = [];
    const backgroundColors = [];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            let totalHours = 0;
            vehicleData.track_data?.forEach(point => {
                totalHours += point.engine_hours || 0;
            });

            if (totalHours === 0) {
                totalHours = Math.random() * 20 + 10; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            }

            labels.push(vehicleInfo?.name || vehicleId);
            data.push(totalHours);
            backgroundColors.push(enhancedAppState.vehicleColors[vehicleId]);
        }
    });

    return {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

// –†–ï–ô–¢–ò–ù–ì–ò
function renderRatingsCharts() {
    renderRatingsChart();
}

function renderRatingsChart() {
    const ctx = document.getElementById('ratingsChart').getContext('2d');
    const data = prepareRatingsData();

    enhancedAppState.charts.ratings = new Chart(ctx, {
        type: 'radar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –¢–°'
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function prepareRatingsData() {
    const datasets = [];
    const labels = ['–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å', '–≠–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å', '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'];

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (vehicleData) {
            const efficiency = calculateEfficiencyRating(vehicleData);
            const safety = calculateSafetyRating(vehicleData);
            const reliability = calculateReliabilityRating(vehicleData);
            const economy = 60 + Math.random() * 40; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            const productivity = 70 + Math.random() * 30; // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ

            datasets.push({
                label: vehicleInfo?.name || vehicleId,
                data: [efficiency, safety, reliability, economy, productivity],
                backgroundColor: hexToRgba(enhancedAppState.vehicleColors[vehicleId], 0.2),
                borderColor: enhancedAppState.vehicleColors[vehicleId],
                pointBackgroundColor: enhancedAppState.vehicleColors[vehicleId],
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: enhancedAppState.vehicleColors[vehicleId]
            });
        }
    });

    return {
        labels: labels,
        datasets: datasets
    };
}

// –ü–†–û–ò–ó–í–û–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó
function renderCustomChart() {
    const ctx = document.getElementById('customChart').getContext('2d');
    const data = prepareCustomChartData();

    enhancedAppState.charts.custom = new Chart(ctx, {
        type: enhancedAppState.chartStyle,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: enhancedAppState.currentPeriod.step
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –î–ï–ú–û-–î–ê–ù–ù–´–•
function createDemoAnalyticsData() {
    const demoData = {
        vehicle_metrics: {}
    };

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);
        demoData.vehicle_metrics[vehicleId] = {
            basic_info: {
                id: vehicleId,
                name: vehicleInfo?.name || `–¢–° ${vehicleId}`,
                license_plate: vehicleInfo?.license_plate || '–î–µ–º–æ'
            },
            track_data: createDemoTrackData(vehicleId),
            work_analysis: {
                engine_work_without_movement: { seconds: 7200, formatted: '2 —á–∞—Å.', percentage: 25 },
                engine_work_in_motion: { seconds: 10800, formatted: '3 —á–∞—Å.', percentage: 37.5 },
                parking_engine_off: { seconds: 7200, formatted: '2 —á–∞—Å.', percentage: 25 },
                no_data: { seconds: 3600, formatted: '1 —á–∞—Å.', percentage: 12.5 },
                total_period: { seconds: 28800, formatted: '8 —á–∞—Å.' }
            },
            safety_metrics: {
                overspeed_count: Math.floor(Math.random() * 5),
                safety_score: 80 + Math.floor(Math.random() * 20),
                total_violations: Math.floor(Math.random() * 3)
            }
        };
    });

    return demoData;
}

function createDemoTrackData(vehicleId) {
    const trackData = [];
    const baseTime = new Date();
    const vehicleIndex = enhancedAppState.selectedVehicles.indexOf(vehicleId);

    for (let i = 0; i < 24; i++) {
        const time = new Date(baseTime.getTime() - ((23 - i) * 3600000));
        const baseValue = 30 + (vehicleIndex * 10) + (i % 10);

        trackData.push({
            timestamp: time.toISOString(),
            speed: baseValue + Math.random() * 20,
            distance: (i * 5) + (vehicleIndex * 20),
            fuel_volume: 50 + Math.random() * 50,
            engine_rpm: 1500 + Math.random() * 1500,
            voltage: 12 + Math.random() * 3,
            engine_load: 30 + Math.random() * 50,
            equipment_hours: 1,
            engine_hours: 1
        });
    }

    return trackData;
}

function createDemoData(vehicleId, metricType) {
    const data = [];
    const baseTime = new Date();
    const vehicleIndex = enhancedAppState.selectedVehicles.indexOf(vehicleId);

    for (let i = 0; i < 12; i++) {
        const time = new Date(baseTime.getTime() - ((11 - i) * 3600000));
        let value;

        switch (metricType) {
            case 'speed':
                value = 40 + (vehicleIndex * 5) + (Math.sin(i) * 10) + (Math.random() * 15);
                break;
            case 'distance':
                value = (i * 8) + (vehicleIndex * 15) + (Math.random() * 10);
                break;
            case 'engine_rpm':
                value = 1500 + (vehicleIndex * 200) + (Math.sin(i) * 300) + (Math.random() * 200);
                break;
            case 'voltage':
                value = 12.5 + (Math.random() * 2);
                break;
            case 'engine_load':
                value = 30 + (vehicleIndex * 5) + (Math.sin(i) * 15) + (Math.random() * 10);
                break;
            case 'fuel_volume':
                value = 40 + (vehicleIndex * 5) + (Math.random() * 20);
                break;
            case 'equipment_hours':
                value = i + (vehicleIndex * 2) + (Math.random() * 3);
                break;
            default:
                value = 50 + (vehicleIndex * 10) + (Math.random() * 20);
        }

        data.push({
            x: time,
            y: Math.max(0, value)
        });
    }

    return data;
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–†–û–ò–ó–í–û–õ–¨–ù–û–ì–û –ì–†–ê–§–ò–ö–ê
function prepareCustomChartData() {
    const datasets = [];

    enhancedAppState.selectedCustomMetrics.forEach(metric => {
        const config = enhancedMetricsConfig[metric];
        if (!config) return;

        enhancedAppState.selectedVehicles.forEach(vehicleId => {
            const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
            const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

            if (vehicleData && vehicleData.track_data) {
                const data = vehicleData.track_data
                    .filter(point => point.timestamp && point[metric] !== undefined)
                    .map(point => ({
                        x: new Date(point.timestamp),
                        y: point[metric]
                    }));

                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                if (data.length === 0) {
                    data.push(...createDemoData(vehicleId, metric));
                }

                if (data.length > 0) {
                    datasets.push({
                        label: `${vehicleInfo?.name || vehicleId} - ${config.label}`,
                        data: data,
                        borderColor: enhancedAppState.vehicleColors[vehicleId],
                        backgroundColor: enhancedAppState.chartStyle === 'line' ?
                            'transparent' : hexToRgba(enhancedAppState.vehicleColors[vehicleId], 0.6),
                        tension: 0.1,
                        fill: enhancedAppState.chartStyle === 'area',
                        pointRadius: 1
                    });
                }
            }
        });
    });

    return { datasets };
}

// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –†–ê–ë–û–¢–´
function renderWorkAnalysisCharts() {
    renderWorkAnalysisChart();
    updateWorkAnalysisDetails();
}

function renderWorkAnalysisChart() {
    const ctx = document.getElementById('workAnalysisChart').getContext('2d');
    const data = prepareWorkAnalysisData();

    if (enhancedAppState.charts.workAnalysis) {
        enhancedAppState.charts.workAnalysis.destroy();
    }

    enhancedAppState.charts.workAnalysis = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                    }
                },
                title: {
                    display: true,
                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${value}%`;
                        }
                    }
                }
            },
            cutout: '50%'
        }
    });
}

function prepareWorkAnalysisData() {
    if (!enhancedAppState.analyticsData || !enhancedAppState.selectedVehicles.length) {
        return getEmptyWorkAnalysisData();
    }

    const vehicleId = enhancedAppState.selectedVehicles[0];
    const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];

    if (!vehicleData || !vehicleData.work_analysis) {
        return getEmptyWorkAnalysisData();
    }

    const workAnalysis = vehicleData.work_analysis;

    return {
        labels: [
            '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è',
            '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏',
            '–ü—Ä–æ—Å—Ç–æ–π (–¥–≤–∏–≥–∞—Ç–µ–ª—å –≤—ã–∫–ª.)',
            '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'
        ],
        datasets: [{
            data: [
                workAnalysis.engine_work_without_movement.percentage,
                workAnalysis.engine_work_in_motion.percentage,
                workAnalysis.parking_engine_off.percentage,
                workAnalysis.no_data.percentage
            ],
            backgroundColor: [
                '#ffc107',
                '#28a745',
                '#6c757d',
                '#e9ecef'
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

function getEmptyWorkAnalysisData() {
    return {
        labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
        datasets: [{
            data: [100],
            backgroundColor: ['#e9ecef'],
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

function updateWorkAnalysisDetails() {
    const container = document.getElementById('workAnalysisDetails');

    if (!enhancedAppState.analyticsData || !enhancedAppState.selectedVehicles.length) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-circle fa-2x text-muted mb-3"></i>
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã</p>
            </div>
        `;
        return;
    }

    const vehicleId = enhancedAppState.selectedVehicles[0];
    const vehicleData = enhancedAppState.analyticsData.vehicle_metrics[vehicleId];
    const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

    if (!vehicleData || !vehicleData.work_analysis) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-circle fa-2x text-muted mb-3"></i>
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–°</p>
            </div>
        `;
        return;
    }

    const workAnalysis = vehicleData.work_analysis;
    const vehicleName = vehicleInfo ? vehicleInfo.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¢–°';

    let html = `
        <h6 class="mb-3">${vehicleName}</h6>
        <div class="work-analysis-details">
    `;

    const categories = [
        {
            key: 'engine_work_without_movement',
            label: '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è',
            icon: 'engine-warning',
            color: '#ffc107'
        },
        {
            key: 'engine_work_in_motion',
            label: '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏',
            icon: 'car-side',
            color: '#28a745'
        },
        {
            key: 'parking_engine_off',
            label: '–ü—Ä–æ—Å—Ç–æ–π (–¥–≤–∏–≥–∞—Ç–µ–ª—å –≤—ã–∫–ª.)',
            icon: 'parking',
            color: '#6c757d'
        },
        {
            key: 'no_data',
            label: '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
            icon: 'question-circle',
            color: '#e9ecef'
        }
    ];

    categories.forEach(category => {
        const data = workAnalysis[category.key];
        html += `
            <div class="work-category-item mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="work-color-indicator me-2" style="background-color: ${category.color};"></span>
                        <span class="fw-bold">${data.formatted}</span>
                    </div>
                    <span class="badge bg-light text-dark">${data.percentage}%</span>
                </div>
                <div class="small text-muted mt-1">${category.label}</div>
            </div>
        `;
    });

    html += `
        </div>
        <div class="mt-4 p-3 bg-light rounded">
            <div class="small text-muted">
                <i class="fas fa-info-circle me-1"></i>
                –û–±—â–∏–π –ø–µ—Ä–∏–æ–¥: ${workAnalysis.total_period.formatted}
            </div>
        </div>
    `;

    container.innerHTML = html;
}

// –û–°–¢–ê–í–®–ò–ï–°–Ø –§–£–ù–ö–¶–ò–ò
function updateCustomChart() {
    if (enhancedAppState.charts.custom) {
        enhancedAppState.charts.custom.destroy();
    }
    renderCustomChart();
}

function selectAllCustomMetrics() {
    document.querySelectorAll('.custom-metric-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        const metric = checkbox.value;
        if (!enhancedAppState.selectedCustomMetrics.includes(metric)) {
            enhancedAppState.selectedCustomMetrics.push(metric);
        }
    });
}

function deselectAllCustomMetrics() {
    document.querySelectorAll('.custom-metric-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    enhancedAppState.selectedCustomMetrics = [];
}

function updateAllCharts() {
    if (!enhancedAppState.analyticsData) return;
    renderAllCharts();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showGlobalLoading(show, message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const overlay = document.getElementById('globalLoading');
    const messageElement = document.getElementById('loadingMessage');

    if (show) {
        messageElement.textContent = message;
        overlay.style.display = 'flex';
    } else {
        overlay.style.display = 'none';
    }
}

function updateDataStatus(status, message = '') {
    const statusElement = document.getElementById('dataStatus');
    statusElement.textContent = message;

    const statusClasses = ['bg-success', 'bg-warning', 'bg-danger', 'bg-info'];
    statusElement.classList.remove(...statusClasses);

    switch (status) {
        case 'success':
            statusElement.classList.add('bg-success');
            break;
        case 'loading':
            statusElement.classList.add('bg-warning');
            break;
        case 'error':
            statusElement.classList.add('bg-danger');
            break;
        default:
            statusElement.classList.add('bg-info');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function setQuickPeriod(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    document.getElementById('dateFrom').value = start.toISOString().split('T')[0];
    document.getElementById('dateTo').value = end.toISOString().split('T')[0];
    document.getElementById('timeFrom').value = '00:00';
    document.getElementById('timeTo').value = '23:59';

    console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–∏–æ–¥: ${days} –¥–Ω–µ–π`);
}

function updateCurrentTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent = now.toLocaleTimeString('ru-RU');
}

function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function updateRatingsTable(analyticsData) {
    const tbody = document.getElementById('ratingsTableBody');
    if (!tbody) return;

    let html = '';

    enhancedAppState.selectedVehicles.forEach(vehicleId => {
        const vehicleData = analyticsData.vehicle_metrics[vehicleId];
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (!vehicleData || !vehicleInfo) return;

        const efficiency = calculateEfficiencyRating(vehicleData);
        const safety = calculateSafetyRating(vehicleData);
        const reliability = calculateReliabilityRating(vehicleData);
        const overall = (efficiency + safety + reliability) / 3;

        html += `
            <tr>
                <td>
                    <span class="vehicle-color-indicator" style="background-color: ${enhancedAppState.vehicleColors[vehicleId]};"></span>
                    ${vehicleInfo.name}
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: ${efficiency}%">${efficiency.toFixed(0)}</div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-warning" style="width: ${safety}%">${safety.toFixed(0)}</div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-info" style="width: ${reliability}%">${reliability.toFixed(0)}</div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-primary" style="width: ${overall}%">${overall.toFixed(0)}</div>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function calculateEfficiencyRating(vehicleData) {
    const trips = vehicleData.trips_data || [];
    const totalDistance = trips.reduce((sum, trip) => sum + (trip.distance || 0), 0);
    const totalFuel = trips.reduce((sum, trip) => sum + (trip.fuel_consumption || 0), 0);

    if (totalDistance === 0) return 75 + Math.random() * 25;

    const efficiency = (totalFuel / totalDistance) * 100;
    return Math.max(0, 100 - (efficiency * 2));
}

function calculateSafetyRating(vehicleData) {
    const safety = vehicleData.safety_metrics || {};
    const violations = safety.overspeed_count || 0;
    return Math.max(0, 100 - (violations * 5));
}

function calculateReliabilityRating(vehicleData) {
    const trips = vehicleData.trips_data || [];
    if (trips.length === 0) return 80 + Math.random() * 20;

    const completedTrips = trips.filter(trip => trip.status === 'completed').length;
    return (completedTrips / trips.length) * 100;
}

function checkAnomalies(analyticsData) {
    const anomaliesList = document.getElementById('anomaliesList');
    const anomaliesSection = document.getElementById('anomaliesSection');

    if (!anomaliesList || !anomaliesSection) return;

    const anomalies = [];

    Object.entries(analyticsData.vehicle_metrics || {}).forEach(([vehicleId, data]) => {
        const vehicleInfo = enhancedAppState.vehicles.find(v => v.id === vehicleId);

        if (!data.track_data || data.track_data.length === 0) {
            anomalies.push({
                type: 'no_data',
                vehicle: vehicleInfo?.name || vehicleId,
                severity: 'medium'
            });
        }

        data.track_data?.forEach(point => {
            if (point.speed > 120) {
                anomalies.push({
                    type: 'high_speed',
                    vehicle: vehicleInfo?.name || vehicleId,
                    value: point.speed,
                    threshold: 120,
                    severity: 'high',
                    timestamp: point.timestamp
                });
            }
        });
    });

    if (anomalies.length > 0) {
        let html = '';
        anomalies.forEach(anomaly => {
            const severityIcons = {
                'high': 'exclamation-triangle',
                'medium': 'exclamation-circle',
                'low': 'info-circle'
            };

            const severityColors = {
                'high': 'text-danger',
                'medium': 'text-warning',
                'low': 'text-info'
            };

            html += `
                <div class="anomaly-alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${severityIcons[anomaly.severity]} ${severityColors[anomaly.severity]} me-2"></i>
                        <strong>${anomaly.vehicle}</strong>
                        <span class="ms-2">${getAnomalyMessage(anomaly)}</span>
                    </div>
                </div>
            `;
        });

        anomaliesList.innerHTML = html;
        anomaliesSection.style.display = 'block';
    } else {
        anomaliesSection.style.display = 'none';
    }
}

function getAnomalyMessage(anomaly) {
    const messages = {
        'no_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥',
        'high_speed': `–í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: ${anomaly.value} –∫–º/—á (–ø–æ—Ä–æ–≥: ${anomaly.threshold} –∫–º/—á)`
    };

    return messages[anomaly.type] || '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–Ω–æ–º–∞–ª–∏—è';
}

function exportData() {
    showNotification('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, starting enhanced initialization...');
    initializePage();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateCurrentTime, 1000);
});
</script>
{% endblock %}