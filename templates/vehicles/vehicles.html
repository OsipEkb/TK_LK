{% extends 'base.html' %}

{% block page_title %}–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç - –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card.distance { border-left-color: #28a745; }
    .stat-card.fuel { border-left-color: #dc3545; }
    .stat-card.hours { border-left-color: #ffc107; }
    .stat-card.speed { border-left-color: #17a2b8; }
    .stat-card.duration { border-left-color: #6f42c1; }
    .stat-card.parking { border-left-color: #6c757d; }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
        min-height: 400px;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .time-step-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .chart-style-btn.active {
        background-color: #6f42c1;
        color: white;
        border-color: #6f42c1;
    }

    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .historical-badge {
        background-color: #6f42c1 !important;
    }

    .metric-checkbox {
        margin-right: 8px;
    }

    .composite-chart-controls {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .chart-style-selector {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .metric-color-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .stats-period-tabs {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .period-tab {
        padding: 8px 16px;
        border: none;
        background: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .period-tab.active {
        background: #007bff;
        color: white;
    }

    .stats-comparison-card {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .stats-comparison-card .trend-up {
        color: #28a745;
    }

    .stats-comparison-card .trend-down {
        color: #dc3545;
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stats-label {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .stats-change {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .export-buttons {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }

    .debug-panel {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container-fluid py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-bar me-2"></i>–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                    </h1>
                    <p class="text-muted mb-0">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark me-3" id="lastUpdate">
                        <i class="fas fa-clock me-1"></i>
                        <span id="updateTime">{{ current_time|date:"H:i:s" }}</span>
                    </span>
                    <button class="btn btn-outline-primary" onclick="loadVehiclesList()" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="fas fa-sliders-h me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- –í—ã–±–æ—Ä –¢–° -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</label>
                    <select class="form-select" id="vehicleSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>
                    </select>
                    <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>
                </div>

                <!-- –ü–µ—Ä–∏–æ–¥ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="form-control" id="dateFrom" value="{{ default_start_date }}">
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="form-control" id="dateTo" value="{{ default_end_date }}">
                </div>

                <!-- –í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">–í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary time-step-btn active" data-step="hour">–ß–∞—Å</button>
                        <button type="button" class="btn btn-outline-primary time-step-btn" data-step="day">–î–µ–Ω—å</button>
                        <button type="button" class="btn btn-outline-primary time-step-btn" data-step="week">–ù–µ–¥–µ–ª—è</button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="loadStatistics()" id="loadStatsBtn">
                        <i class="fas fa-chart-bar me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label fw-bold">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞:</label>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(1)">–°–µ–≥–æ–¥–Ω—è</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(7)">–ù–µ–¥–µ–ª—è</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(30)">–ú–µ—Å—è—Ü</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(90)">–ö–≤–∞—Ä—Ç–∞–ª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <h6><i class="fas fa-bug me-2"></i>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
        <div class="row">
            <div class="col-md-3">
                <small><strong>–°—Ç–∞—Ç—É—Å –¥–∞–Ω–Ω—ã—Ö:</strong> <span id="debugStatus">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span></small>
            </div>
            <div class="col-md-3">
                <small><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> <span id="debugSource">‚Äî</span></small>
            </div>
            <div class="col-md-3">
                <small><strong>–í—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫:</strong> <span id="debugDataPoints">0</span></small>
            </div>
            <div class="col-md-3">
                <small><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> <span id="debugLastUpdate">‚Äî</span></small>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4" id="statisticsSection" style="display: none;">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
                <small class="text-muted ms-2" id="periodInfo"></small>
            </h4>

            <div class="row">
                <!-- –ü—Ä–æ–±–µ–≥ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card distance h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-road fa-2x text-success mb-2"></i>
                            <h5 class="card-title text-muted">–ü—Ä–æ–±–µ–≥</h5>
                            <h3 class="text-success mb-1" id="totalDistance">0 –∫–º</h3>
                            <small class="text-muted">–û–±—â–∏–π –ø—Ä–æ–±–µ–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>

                <!-- –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card fuel h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-gas-pump fa-2x text-danger mb-2"></i>
                            <h5 class="card-title text-muted">–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</h5>
                            <h3 class="text-danger mb-1" id="totalFuel">0 –ª</h3>
                            <small class="text-muted">–í—Å–µ–≥–æ –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</small>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ—Ç–æ—á–∞—Å—ã -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card hours h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h5 class="card-title text-muted">–ú–æ—Ç–æ—á–∞—Å—ã</h5>
                            <h3 class="text-warning mb-1" id="engineHours">0:00</h3>
                            <small class="text-muted">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è</small>
                        </div>
                    </div>
                </div>

                <!-- –í –¥–≤–∏–∂–µ–Ω–∏–∏ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card duration h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-play fa-2x text-primary mb-2"></i>
                            <h5 class="card-title text-muted">–í –¥–≤–∏–∂–µ–Ω–∏–∏</h5>
                            <h3 class="text-primary mb-1" id="moveDuration">0:00</h3>
                            <small class="text-muted">–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è</small>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞ —Å—Ç–æ—è–Ω–∫–µ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card parking h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-pause fa-2x text-secondary mb-2"></i>
                            <h5 class="card-title text-muted">–ù–∞ —Å—Ç–æ—è–Ω–∫–µ</h5>
                            <h3 class="text-secondary mb-1" id="parkDuration">0:00</h3>
                            <small class="text-muted">–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</small>
                        </div>
                    </div>
                </div>

                <!-- –ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card speed h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-tachometer-alt fa-2x text-info mb-2"></i>
                            <h5 class="card-title text-muted">–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å</h5>
                            <h3 class="text-info mb-1" id="maxSpeed">0 –∫–º/—á</h3>
                            <small class="text-muted">–ü–∏–∫–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row" id="chartsSection" style="display: none;">
        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>–°–æ—Å—Ç–∞–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
                    <div class="chart-style-selector">
                        <h6 class="mb-3">–°—Ç–∏–ª—å –≥—Ä–∞—Ñ–∏–∫–æ–≤:</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary chart-style-btn active" data-style="line">
                                <i class="fas fa-chart-line me-1"></i> –õ–∏–Ω–µ–π–Ω—ã–π
                            </button>
                            <button type="button" class="btn btn-outline-primary chart-style-btn" data-style="bar">
                                <i class="fas fa-chart-bar me-1"></i> –°—Ç–æ–ª–±—á–∞—Ç—ã–π
                            </button>
                            <button type="button" class="btn btn-outline-primary chart-style-btn" data-style="area">
                                <i class="fas fa-chart-area me-1"></i> –û–±–ª–∞—Å—Ç–Ω–æ–π
                            </button>
                        </div>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ -->
                    <div class="composite-chart-controls">
                        <h6 class="mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricFuel" value="fuel_consumption" checked>
                                    <label class="form-check-label" for="metricFuel">
                                        <span class="metric-color-indicator" style="background-color: #e74c3c;"></span>
                                        <i class="fas fa-gas-pump me-1"></i> –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricDistance" value="distance" checked>
                                    <label class="form-check-label" for="metricDistance">
                                        <span class="metric-color-indicator" style="background-color: #27ae60;"></span>
                                        <i class="fas fa-road me-1"></i> –ü—Ä–æ–±–µ–≥
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricSpeed" value="max_speed">
                                    <label class="form-check-label" for="metricSpeed">
                                        <span class="metric-color-indicator" style="background-color: #3498db;"></span>
                                        <i class="fas fa-tachometer-alt me-1"></i> –°–∫–æ—Ä–æ—Å—Ç—å
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricHours" value="engine_hours">
                                    <label class="form-check-label" for="metricHours">
                                        <span class="metric-color-indicator" style="background-color: #f39c12;"></span>
                                        <i class="fas fa-clock me-1"></i> –ú–æ—Ç–æ—á–∞—Å—ã
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricFuelLevel" value="fuel_level">
                                    <label class="form-check-label" for="metricFuelLevel">
                                        <span class="metric-color-indicator" style="background-color: #9b59b6;"></span>
                                        <i class="fas fa-oil-can me-1"></i> –£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input metric-checkbox" type="checkbox" id="metricTotalFuel" value="total_fuel_volume" checked>
                                    <label class="form-check-label" for="metricTotalFuel">
                                        <span class="metric-color-indicator" style="background-color: #e67e22;"></span>
                                        <i class="fas fa-gas-pump me-1"></i> –û–±—â–∏–π –æ–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-primary" onclick="updateCompositeChart()">
                                <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="selectAllMetrics()">
                                –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllMetrics()">
                                –°–Ω—è—Ç—å –≤—Å–µ
                            </button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="compositeChart" height="350"></canvas>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –¢–∞–±—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–∏–æ–¥–∞–º–∏ -->
                    <div class="stats-period-tabs" id="periodTabs">
                        <button class="period-tab active" data-period="all">–û–±—â–∞—è –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
                        <button class="period-tab" data-period="daily">–ü–æ –¥–Ω—è–º</button>
                        <button class="period-tab" data-period="hourly">–ü–æ —á–∞—Å–∞–º</button>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="detailedStatsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>–ü–µ—Ä–∏–æ–¥</th>
                                    <th class="text-end">–ü—Ä–æ–±–µ–≥ (–∫–º)</th>
                                    <th class="text-end">–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–ª)</th>
                                    <th class="text-end">–ú–æ—Ç–æ—á–∞—Å—ã</th>
                                    <th class="text-end">–°–∫–æ—Ä–æ—Å—Ç—å –º–∞–∫—Å. (–∫–º/—á)</th>
                                    <th class="text-end">–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ (–ª)</th>
                                </tr>
                            </thead>
                            <tbody id="detailedStatsBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="row mt-4" id="comparisonStats" style="display: none;">
                        <div class="col-12">
                            <h6 class="mb-3">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º:</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="stats-comparison-card">
                                        <div class="stats-value" id="distanceComparison">0 –∫–º</div>
                                        <div class="stats-label">–ü—Ä–æ–±–µ–≥</div>
                                        <div class="stats-change" id="distanceChange">+0%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-comparison-card">
                                        <div class="stats-value" id="fuelComparison">0 –ª</div>
                                        <div class="stats-label">–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</div>
                                        <div class="stats-change" id="fuelChange">+0%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-comparison-card">
                                        <div class="stats-value" id="hoursComparison">0 —á</div>
                                        <div class="stats-label">–ú–æ—Ç–æ—á–∞—Å—ã</div>
                                        <div class="stats-change" id="hoursChange">+0%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-comparison-card">
                                        <div class="stats-value" id="efficiencyComparison">0 –ª/100–∫–º</div>
                                        <div class="stats-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                                        <div class="stats-change" id="efficiencyChange">+0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-lg-4 mb-4">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–° -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–°
                    </h5>
                </div>
                <div class="card-body">
                    <div id="vehicleInfo">
                        <p class="text-muted mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <tbody id="additionalStats">
                                <tr>
                                    <td colspan="2" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </h5>
                </div>
                <div class="card-body">
                    <div class="export-buttons">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="exportToCSV()">
                                <i class="fas fa-file-csv me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                            </button>
                            <button class="btn btn-outline-success" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                            </button>
                            <button class="btn btn-outline-info" onclick="exportChartData()">
                                <i class="fas fa-chart-bar me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–æ–≤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ -->
    <div class="row" id="vehiclesListSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    </h5>
                    <div class="d-flex align-items-center">
                        <div class="input-group input-group-sm me-2" style="width: 200px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchVehicles" class="form-control" placeholder="–ü–æ–∏—Å–∫...">
                        </div>
                        <span class="badge historical-badge">
                            <i class="fas fa-history me-1"></i> –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="30%">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</th>
                                    <th width="15%">–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                                    <th width="15%">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</th>
                                    <th width="15%">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                                    <th width="25%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                        <p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const appState = {
    vehicles: [],
    selectedVehicle: null,
    currentPeriod: {
        start: '{{ default_start_date }}',
        end: '{{ default_end_date }}',
        step: 'hour'
    },
    statistics: null,
    compositeChart: null,
    selectedMetrics: ['fuel_consumption', 'distance', 'total_fuel_volume'],
    chartStyle: 'line',
    currentStatsPeriod: 'all'
};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
const metricsConfig = {
    distance: {
        label: '–ü—Ä–æ–±–µ–≥',
        unit: '–∫–º',
        color: '#27ae60',
        icon: 'road'
    },
    fuel_consumption: {
        label: '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞',
        unit: '–ª',
        color: '#e74c3c',
        icon: 'gas-pump'
    },
    max_speed: {
        label: '–°–∫–æ—Ä–æ—Å—Ç—å',
        unit: '–∫–º/—á',
        color: '#3498db',
        icon: 'tachometer-alt'
    },
    engine_hours: {
        label: '–ú–æ—Ç–æ—á–∞—Å—ã',
        unit: '—á',
        color: '#f39c12',
        icon: 'clock'
    },
    fuel_level: {
        label: '–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞',
        unit: '–ª',
        color: '#9b59b6',
        icon: 'oil-can'
    },
    total_fuel_volume: {
        label: '–û–±—â–∏–π –æ–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞',
        unit: '–ª',
        color: '#e67e22',
        icon: 'gas-pump'
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, starting initialization...');
    initializePage();
});

function initializePage() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateTo').max = today;
    document.getElementById('dateFrom').max = today;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    loadVehiclesList();
    setupEventListeners();
    updateCurrentTime();
}

function setupEventListeners() {
    // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–≥–∏
    document.querySelectorAll('.time-step-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-step-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            appState.currentPeriod.step = this.dataset.step;
        });
    });

    // –°—Ç–∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    document.querySelectorAll('.chart-style-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-style-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            appState.chartStyle = this.dataset.style;
            if (appState.statistics) {
                updateCompositeChart();
            }
        });
    });

    // –ß–µ–∫–±–æ–∫—Å—ã –º–µ—Ç—Ä–∏–∫
    document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedMetrics();
        });
    });

    // –ü–æ–∏—Å–∫ –≤ —Å–ø–∏—Å–∫–µ –¢–°
    document.getElementById('searchVehicles').addEventListener('input', function(e) {
        filterVehiclesList();
    });

    // –¢–∞–±—ã –ø–µ—Ä–∏–æ–¥–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            appState.currentStatsPeriod = this.dataset.period;
            if (appState.statistics) {
                updateDetailedStatsTable();
            }
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateCurrentTime, 1000);
}

async function loadVehiclesList() {
    try {
        showGlobalLoading(true);
        console.log('üîÑ Loading real vehicles data from API...');

        const response = await fetch('/vehicles/api/list/');
        console.log('üì° API Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('üìä API Data received:', data);

            if (data.success) {
                appState.vehicles = data.vehicles || [];
                console.log(`‚úÖ Loaded ${appState.vehicles.length} vehicles, source: ${data.source}`);

                updateVehiclesListWithData(appState.vehicles);
                updateVehicleSelectWithData(appState.vehicles);

                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${appState.vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');
            } else {
                throw new Error(data.error || 'API returned success:false');
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Error loading vehicles list:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
    } finally {
        showGlobalLoading(false);
    }
}

function updateVehiclesListWithData(vehicles) {
    const tbody = document.getElementById('vehiclesTable');
    if (!tbody) {
        console.error('‚ùå vehiclesTable element not found!');
        return;
    }

    if (!vehicles || vehicles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö</td></tr>';
        return;
    }

    let html = '';
    vehicles.forEach(vehicle => {
        if (!vehicle || !vehicle.id) {
            console.warn('‚ö†Ô∏è Skipping invalid vehicle:', vehicle);
            return;
        }

        const vehicleId = vehicle.id || '';
        const vehicleName = vehicle.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const licensePlate = vehicle.license_plate || '';
        const serial = vehicle.serial || '';

        html += `
            <tr data-vehicle-id="${escapeHtml(vehicleId)}">
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-truck me-2 text-muted"></i>
                        <div>
                            <strong>${escapeHtml(vehicleName)}</strong>
                            ${serial ? `<br><small class="text-muted">${escapeHtml(serial)}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    ${licensePlate ?
                        `<span class="badge bg-dark">${escapeHtml(licensePlate)}</span>` :
                        '<span class="text-muted">‚Äî</span>'}
                </td>
                <td><span class="badge historical-badge">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</span></td>
                <td>${serial ? escapeHtml(serial) : '<span class="text-muted">‚Äî</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectVehicle('${escapeHtml(vehicleId)}')">
                        <i class="fas fa-chart-bar me-1"></i> –ê–Ω–∞–ª–∏–∑
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateVehicleSelectWithData(vehicles) {
    const select = document.getElementById('vehicleSelect');
    if (!select) return;

    let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>';
    vehicles.forEach(vehicle => {
        const displayName = vehicle.license_plate ?
            `${vehicle.name} (${vehicle.license_plate})` : vehicle.name;
        html += `<option value="${vehicle.id}">${escapeHtml(displayName)}</option>`;
    });

    select.innerHTML = html;
}

function filterVehiclesList() {
    const searchTerm = document.getElementById('searchVehicles').value.toLowerCase();
    const rows = document.querySelectorAll('#vehiclesTable tr[data-vehicle-id]');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function selectVehicle(vehicleId) {
    const vehicle = appState.vehicles.find(v => v.id === vehicleId);
    if (vehicle) {
        appState.selectedVehicle = vehicle;
        document.getElementById('vehicleSelect').value = vehicleId;
        updateVehicleInfo(vehicle);
        showNotification(`–í—ã–±—Ä–∞–Ω–æ –¢–°: ${vehicle.name}`, 'success');
        setQuickPeriod(7);
        setTimeout(() => loadStatistics(), 500);
    }
}

async function loadStatistics() {
    const vehicleId = document.getElementById('vehicleSelect').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    if (!vehicleId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    if (!dateFrom || !dateTo) {
        showNotification('–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    if (new Date(dateFrom) > new Date(dateTo)) {
        showNotification('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'warning');
        return;
    }

    try {
        showGlobalLoading(true);

        const params = new URLSearchParams({
            vehicle_id: vehicleId,
            schema_id: appState.selectedVehicle?.schema_id || 'fad66447-fe18-4a2a-a7b9-945eab775fda',
            start_date: dateFrom,
            end_date: dateTo,
            time_step: appState.currentPeriod.step
        });

        const url = `/vehicles/api/statistics/?${params}`;
        console.log('üì° GET Request to:', url);

        const response = await fetch(url);
        console.log('üì° Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Statistics data received:', data);

            if (data.success && data.statistics) {
                appState.statistics = data.statistics;
                console.log('üìä Statistics structure:', {
                    hasSummary: !!data.statistics.summary,
                    hasTimeSeries: !!data.statistics.time_series,
                    statisticsKeys: Object.keys(data.statistics)
                });

                displayStatistics(data.statistics);
                updateCompositeChart();
                updateDetailedStatsTable();
                updateAdditionalStats();
                updateComparisonStats();
                updateDebugInfo(data);

                if (data.data_source === 'autograph_real') {
                    showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${data.statistics.vehicle_name}`, 'success');
                } else {
                    showNotification(`‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${data.statistics.vehicle_name}`, 'warning');
                }
            } else {
                throw new Error(data.error || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
        showFallbackData(vehicleId, dateFrom, dateTo);
    } finally {
        showGlobalLoading(false);
    }
}

function showFallbackData(vehicleId, startDate, endDate) {
    console.log('üîÑ Loading fallback data...');

    const fallbackStats = {
        summary: {
            total_distance: 245.5,
            total_fuel_consumption: 78.3,
            total_engine_hours: "45:30:00",
            total_move_duration: "32:15:00",
            total_park_duration: "13:15:00",
            max_speed: 85.5,
            average_speed: 45.2,
            fuel_efficiency: 12.5,
            parking_count: 8,
            overspeed_count: 2,
        },
        fuel_analytics: {
            current_level: 125.5,
            refills_count: 2,
            refills_volume: 80.0,
            consumption_per_motor_hour: 8.2,
            total_fuel_volume: 205.5,
        },
        violations: {
            overspeed_duration: "00:15:00",
            penalty_points: 15.5,
            overspeed_points: 8.2,
        },
        time_series: generateFallbackTimeSeries(startDate, endDate),
        vehicle_id: vehicleId,
        vehicle_name: '–¢–µ—Å—Ç–æ–≤–æ–µ –¢–°',
        license_plate: '–ê123–ë–í77',
        data_source: 'fallback'
    };

    appState.statistics = fallbackStats;
    displayStatistics(fallbackStats);
    updateCompositeChart();
    updateDetailedStatsTable();
    updateAdditionalStats();
    updateComparisonStats();
    updateDebugInfo({data_source: 'fallback', statistics: fallbackStats});

    showNotification('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏', 'warning');
}

function generateFallbackTimeSeries(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const timeSeries = [];
    let current = new Date(start);

    while (current <= end) {
        timeSeries.push({
            timestamp: current.toISOString(),
            distance: (Math.random() * 10 + 5).toFixed(1),
            fuel_consumption: (Math.random() * 3 + 1).toFixed(1),
            max_speed: (Math.random() * 40 + 30).toFixed(1),
            engine_hours: (Math.random() * 0.5 + 0.1).toFixed(1),
            fuel_level: (Math.random() * 100 + 150).toFixed(1),
            total_fuel_volume: (Math.random() * 50 + 200).toFixed(1)
        });
        current.setHours(current.getHours() + 1);
    }

    return timeSeries;
}

function displayStatistics(statistics) {
    if (!statistics) {
        console.error('‚ùå Statistics is null or undefined');
        showNotification('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'error');
        return;
    }

    if (!statistics.summary) {
        console.error('‚ùå Statistics summary is missing:', statistics);
        showNotification('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'error');
        return;
    }

    document.getElementById('statisticsSection').style.display = 'block';
    document.getElementById('chartsSection').style.display = 'block';

    const summary = statistics.summary;
    const fuel = statistics.fuel_analytics || {};
    const violations = statistics.violations || {};

    document.getElementById('totalDistance').textContent = `${summary.total_distance || 0} –∫–º`;
    document.getElementById('totalFuel').textContent = `${summary.total_fuel_consumption || 0} –ª`;
    document.getElementById('engineHours').textContent = summary.total_engine_hours || "00:00:00";
    document.getElementById('moveDuration').textContent = summary.total_move_duration || "00:00:00";
    document.getElementById('parkDuration').textContent = summary.total_park_duration || "00:00:00";
    document.getElementById('maxSpeed').textContent = `${summary.max_speed || 0} –∫–º/—á`;

    updateVehicleInfoWithStatistics(statistics);

    const vehicleName = statistics.vehicle_name || appState.selectedVehicle?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const dataSource = statistics.data_source || 'unknown';
    const periodInfo = `–¢–°: ${vehicleName} | –ü–µ—Ä–∏–æ–¥: ${document.getElementById('dateFrom').value} - ${document.getElementById('dateTo').value} | –ò—Å—Ç–æ—á–Ω–∏–∫: ${dataSource === 'autograph_real' ? 'AutoGRAPH' : '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ'}`;
    document.getElementById('periodInfo').textContent = periodInfo;
}

function updateCompositeChart() {
    if (!appState.statistics) {
        console.error('‚ùå Cannot update chart: statistics is null');
        showNotification('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'warning');
        return;
    }

    if (!appState.statistics.time_series) {
        console.error('‚ùå Cannot update chart: time_series is missing');
        showNotification('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞', 'warning');
        return;
    }

    updateSelectedMetrics();

    if (appState.selectedMetrics.length === 0) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å', 'warning');
        return;
    }

    const ctx = document.getElementById('compositeChart').getContext('2d');

    if (appState.compositeChart) {
        appState.compositeChart.destroy();
    }

    const timeSeries = appState.statistics.time_series;
    const labels = timeSeries.map(item => {
        if (!item || !item.timestamp) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

        try {
            if (appState.currentPeriod.step === 'hour') {
                return new Date(item.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else {
                return new Date(item.timestamp).toLocaleDateString('ru-RU');
            }
        } catch (e) {
            return '–û—à–∏–±–∫–∞ –¥–∞—Ç—ã';
        }
    });

    const datasets = appState.selectedMetrics.map(metric => {
        const config = metricsConfig[metric];
        const data = timeSeries.map(item => parseFloat(item[metric]) || 0);

        const baseDataset = {
            label: `${config.label} (${config.unit})`,
            data: data,
            borderColor: config.color,
            backgroundColor: config.color + '20',
            tension: 0.4,
        };

        switch(appState.chartStyle) {
            case 'bar':
                baseDataset.type = 'bar';
                baseDataset.backgroundColor = config.color + '80';
                baseDataset.borderColor = config.color;
                baseDataset.borderWidth = 1;
                break;
            case 'area':
                baseDataset.fill = true;
                baseDataset.backgroundColor = config.color + '40';
                break;
            default:
                baseDataset.fill = false;
                baseDataset.pointBackgroundColor = config.color;
                baseDataset.pointBorderColor = '#fff';
                baseDataset.pointBorderWidth = 2;
                baseDataset.pointRadius = 3;
        }

        return baseDataset;
    });

    appState.compositeChart = new Chart(ctx, {
        type: appState.chartStyle === 'bar' ? 'bar' : 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: '–ó–Ω–∞—á–µ–Ω–∏—è' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateDetailedStatsTable() {
    if (!appState.statistics || !appState.statistics.time_series) {
        return;
    }

    const tbody = document.getElementById('detailedStatsBody');
    const timeSeries = appState.statistics.time_series;

    let html = '';

    if (appState.currentStatsPeriod === 'all') {
        const summary = appState.statistics.summary || {};
        html = `
            <tr>
                <td><strong>–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</strong></td>
                <td class="text-end"><strong>${summary.total_distance || 0} –∫–º</strong></td>
                <td class="text-end"><strong>${summary.total_fuel_consumption || 0} –ª</strong></td>
                <td class="text-end"><strong>${summary.total_engine_hours || "00:00:00"}</strong></td>
                <td class="text-end"><strong>${summary.max_speed || 0} –∫–º/—á</strong></td>
                <td class="text-end"><strong>${(appState.statistics.fuel_analytics || {}).current_level || 0} –ª</strong></td>
            </tr>
        `;
    } else if (appState.currentStatsPeriod === 'daily') {
        const dailyData = aggregateDataByDay(timeSeries);
        dailyData.forEach(day => {
            html += `
                <tr>
                    <td>${day.date}</td>
                    <td class="text-end">${day.distance} –∫–º</td>
                    <td class="text-end">${day.fuel} –ª</td>
                    <td class="text-end">${day.hours} —á</td>
                    <td class="text-end">${day.maxSpeed} –∫–º/—á</td>
                    <td class="text-end">${day.fuelLevel} –ª</td>
                </tr>
            `;
        });
    } else if (appState.currentStatsPeriod === 'hourly') {
        const hourlyData = timeSeries.slice(0, 24);
        hourlyData.forEach(hour => {
            const time = new Date(hour.timestamp).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            html += `
                <tr>
                    <td>${time}</td>
                    <td class="text-end">${hour.distance} –∫–º</td>
                    <td class="text-end">${hour.fuel_consumption} –ª</td>
                    <td class="text-end">${hour.engine_hours} —á</td>
                    <td class="text-end">${hour.max_speed} –∫–º/—á</td>
                    <td class="text-end">${hour.fuel_level} –ª</td>
                </tr>
            `;
        });
    }

    tbody.innerHTML = html;
}

function aggregateDataByDay(timeSeries) {
    const dailyData = {};

    timeSeries.forEach(entry => {
        const date = new Date(entry.timestamp).toLocaleDateString('ru-RU');

        if (!dailyData[date]) {
            dailyData[date] = {
                date: date,
                distance: 0,
                fuel: 0,
                hours: 0,
                maxSpeed: 0,
                fuelLevel: 0,
            };
        }

        dailyData[date].distance += parseFloat(entry.distance || 0);
        dailyData[date].fuel += parseFloat(entry.fuel_consumption || 0);
        dailyData[date].hours += parseFloat(entry.engine_hours || 0);
        dailyData[date].maxSpeed = Math.max(dailyData[date].maxSpeed, parseFloat(entry.max_speed || 0));
        dailyData[date].fuelLevel = parseFloat(entry.fuel_level || 0);
    });

    return Object.values(dailyData).map(day => ({
        ...day,
        distance: day.distance.toFixed(1),
        fuel: day.fuel.toFixed(1),
        hours: day.hours.toFixed(1),
        maxSpeed: day.maxSpeed.toFixed(1),
        fuelLevel: day.fuelLevel.toFixed(1)
    }));
}

function updateAdditionalStats() {
    if (!appState.statistics) return;

    const summary = appState.statistics.summary || {};
    const fuel = appState.statistics.fuel_analytics || {};
    const violations = appState.statistics.violations || {};

    const tbody = document.getElementById('additionalStats');

    const stats = [
        { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', value: `${summary.fuel_efficiency || 0} –ª/100–∫–º`, icon: 'tachometer-alt' },
        { label: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å', value: `${summary.average_speed || 0} –∫–º/—á`, icon: 'speedometer' },
        { label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ—è–Ω–æ–∫', value: summary.parking_count || 0, icon: 'map-marker-alt' },
        { label: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏', value: summary.overspeed_count || 0, icon: 'exclamation-triangle' },
        { label: '–ó–∞–ø—Ä–∞–≤–∫–∏', value: `${fuel.refills_count || 0} (${fuel.refills_volume || 0} –ª)`, icon: 'gas-pump' },
        { label: '–†–∞—Å—Ö–æ–¥ –Ω–∞ –º–æ—Ç–æ—á–∞—Å', value: `${fuel.consumption_per_motor_hour || 0} –ª/—á`, icon: 'clock' },
        { label: '–ë–∞–ª–ª—ã –Ω–∞—Ä—É—à–µ–Ω–∏–π', value: violations.penalty_points || 0, icon: 'star' },
        { label: '–í—Ä–µ–º—è –ø—Ä–µ–≤—ã—à–µ–Ω–∏–π', value: violations.overspeed_duration || "00:00:00", icon: 'stopwatch' }
    ];

    let html = '';
    stats.forEach(stat => {
        html += `
            <tr>
                <td><i class="fas fa-${stat.icon} me-2 text-muted"></i>${stat.label}</td>
                <td class="text-end fw-bold">${stat.value}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateComparisonStats() {
    if (!appState.statistics) return;

    const summary = appState.statistics.summary || {};
    document.getElementById('comparisonStats').style.display = 'block';
}

function updateDebugInfo(data) {
    const debugPanel = document.getElementById('debugPanel');
    debugPanel.style.display = 'block';

    document.getElementById('debugStatus').textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    document.getElementById('debugSource').textContent = data.data_source || 'unknown';
    document.getElementById('debugDataPoints').textContent = appState.statistics?.time_series?.length || 0;
    document.getElementById('debugLastUpdate').textContent = new Date().toLocaleTimeString();
}

function updateSelectedMetrics() {
    appState.selectedMetrics = [];
    document.querySelectorAll('.metric-checkbox:checked').forEach(checkbox => {
        appState.selectedMetrics.push(checkbox.value);
    });
}

function selectAllMetrics() {
    document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedMetrics();
    if (appState.statistics) {
        updateCompositeChart();
    }
}

function deselectAllMetrics() {
    document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedMetrics();
}

function updateVehicleInfo(vehicle) {
    const container = document.getElementById('vehicleInfo');
    const info = `
        <div class="mb-2"><strong>${escapeHtml(vehicle.name)}</strong></div>
        ${vehicle.license_plate ? `<div class="mb-1"><small class="text-muted">–ì–æ—Å–Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.license_plate)}</div>` : ''}
        ${vehicle.serial ? `<div class="mb-1"><small class="text-muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.serial)}</div>` : ''}
        <div class="mb-1"><small class="text-muted">–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</small><span class="badge historical-badge">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</span></div>
        <div class="mt-3"><small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</small></div>
    `;
    container.innerHTML = info;
}

function updateVehicleInfoWithStatistics(statistics) {
    const container = document.getElementById('vehicleInfo');
    const vehicle = appState.selectedVehicle;
    const info = `
        <div class="mb-2"><strong>${escapeHtml(statistics.vehicle_name || vehicle.name)}</strong></div>
        ${vehicle.license_plate ? `<div class="mb-1"><small class="text-muted">–ì–æ—Å–Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.license_plate)}</div>` : ''}
        ${vehicle.serial ? `<div class="mb-1"><small class="text-muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.serial)}</div>` : ''}
        <div class="mb-1"><small class="text-muted">–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</small><span class="badge historical-badge">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</span></div>
        <div class="mb-1">
            <small class="text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:</small>
            <span class="badge ${statistics.data_source === 'autograph_real' ? 'bg-success' : 'bg-warning'}">
                ${statistics.data_source === 'autograph_real' ? 'AutoGRAPH' : '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ'}
            </span>
        </div>
        <div class="mt-3"><small class="text-muted">–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥: ${statistics.period?.start || ''} - ${statistics.period?.end || ''}</small></div>
    `;
    container.innerHTML = info;
}

// –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
function exportToCSV() {
    if (!appState.statistics) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    const timeSeries = appState.statistics.time_series;
    let csvContent = "–î–∞—Ç–∞;–í—Ä–µ–º—è;–ü—Ä–æ–±–µ–≥ (–∫–º);–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–ª);–ú–æ—Ç–æ—á–∞—Å—ã;–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á);–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ (–ª);–û–±—â–∏–π –æ–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞ (–ª)\n";
    timeSeries.forEach(item => {
        const date = new Date(item.timestamp).toLocaleDateString('ru-RU');
        const time = new Date(item.timestamp).toLocaleTimeString('ru-RU');
        csvContent += `${date};${time};${item.distance};${item.fuel_consumption};${item.engine_hours};${item.max_speed};${item.fuel_level};${item.total_fuel_volume}\n`;
    });
    downloadFile(csvContent, `vehicle_data_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
}

function exportToExcel() {
    if (!appState.statistics) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    const timeSeries = appState.statistics.time_series;
    const data = timeSeries.map(item => ({
        '–î–∞—Ç–∞': new Date(item.timestamp).toLocaleDateString('ru-RU'),
        '–í—Ä–µ–º—è': new Date(item.timestamp).toLocaleTimeString('ru-RU'),
        '–ü—Ä–æ–±–µ–≥ (–∫–º)': item.distance,
        '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–ª)': item.fuel_consumption,
        '–ú–æ—Ç–æ—á–∞—Å—ã': item.engine_hours,
        '–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)': item.max_speed,
        '–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ (–ª)': item.fuel_level,
        '–û–±—â–∏–π –æ–±—ä–µ–º —Ç–æ–ø–ª–∏–≤–∞ (–ª)': item.total_fuel_volume
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–î–∞–Ω–Ω—ã–µ –¢–°");
    XLSX.writeFile(wb, `vehicle_data_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportChartData() {
    if (!appState.compositeChart) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    const chartCanvas = document.getElementById('compositeChart');
    const image = chartCanvas.toDataURL('image/png');
    downloadFile(image, `vehicle_chart_${new Date().toISOString().split('T')[0]}.png`, 'image/png');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function setQuickPeriod(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - days + 1);
    document.getElementById('dateFrom').value = startDate.toISOString().split('T')[0];
    document.getElementById('dateTo').value = endDate.toISOString().split('T')[0];
}

function showGlobalLoading(show) {
    document.getElementById('globalLoading').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' :
                      type === 'success' ? 'alert-success' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px;';
    alert.innerHTML = `
        <strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function updateCurrentTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent =
        now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function loadData() {
    loadVehiclesList();
}

function refreshData() {
    loadVehiclesList();
    if (appState.selectedVehicle) {
        loadStatistics();
    }
}
</script>
{% endblock %}