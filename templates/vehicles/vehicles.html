{% extends 'base.html' %}

{% block page_title %}–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç - –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card.distance { border-left-color: #28a745; }
    .stat-card.fuel { border-left-color: #dc3545; }
    .stat-card.hours { border-left-color: #ffc107; }
    .stat-card.speed { border-left-color: #17a2b8; }
    .stat-card.duration { border-left-color: #6f42c1; }

    .vehicle-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .vehicle-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .vehicle-card.selected {
        border: 2px solid #007bff;
        background-color: #f8f9fa;
    }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .time-step-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .status-online { color: #28a745; }
    .status-offline { color: #6c757d; }
    .status-moving { color: #17a2b8; }

    .historical-badge {
        background-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-bar me-2"></i>–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                    </h1>
                    <p class="text-muted mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark me-3" id="lastUpdate">
                        <i class="fas fa-clock me-1"></i>
                        <span id="updateTime">{{ current_time|date:"H:i:s" }}</span>
                    </span>
                    <button class="btn btn-outline-primary" onclick="loadData()" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="fas fa-sliders-h me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- –í—ã–±–æ—Ä –¢–° -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</label>
                    <select class="form-select" id="vehicleSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>
                    </select>
                    <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>
                </div>

                <!-- –ü–µ—Ä–∏–æ–¥ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="form-control" id="dateFrom" value="{{ default_start_date }}">
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="form-control" id="dateTo" value="{{ default_end_date }}">
                </div>

                <!-- –í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">–í—Ä–µ–º–µ–Ω–Ω–æ–π —à–∞–≥</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary time-step-btn active" data-step="hour">–ß–∞—Å</button>
                        <button type="button" class="btn btn-outline-primary time-step-btn" data-step="day">–î–µ–Ω—å</button>
                        <button type="button" class="btn btn-outline-primary time-step-btn" data-step="week">–ù–µ–¥–µ–ª—è</button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="col-md-2">
                    <label class="form-label fw-bold">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="loadStatistics()" id="loadStatsBtn">
                        <i class="fas fa-chart-bar me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label fw-bold">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞:</label>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(1)">–°–µ–≥–æ–¥–Ω—è</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(7)">–ù–µ–¥–µ–ª—è</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(30)">–ú–µ—Å—è—Ü</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(90)">–ö–≤–∞—Ä—Ç–∞–ª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4" id="statisticsSection" style="display: none;">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                <small class="text-muted ms-2" id="periodInfo"></small>
            </h4>

            <div class="row">
                <!-- –ü—Ä–æ–±–µ–≥ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card distance h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-road fa-2x text-success mb-2"></i>
                            <h5 class="card-title text-muted">–ü—Ä–æ–±–µ–≥</h5>
                            <h3 class="text-success mb-1" id="totalDistance">0 –∫–º</h3>
                            <small class="text-muted">–û–±—â–∏–π –ø—Ä–æ–±–µ–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                    </div>
                </div>

                <!-- –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card fuel h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-gas-pump fa-2x text-danger mb-2"></i>
                            <h5 class="card-title text-muted">–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</h5>
                            <h3 class="text-danger mb-1" id="totalFuel">0 –ª</h3>
                            <small class="text-muted">–í—Å–µ–≥–æ –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</small>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ—Ç–æ—á–∞—Å—ã -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card hours h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h5 class="card-title text-muted">–ú–æ—Ç–æ—á–∞—Å—ã</h5>
                            <h3 class="text-warning mb-1" id="engineHours">0:00</h3>
                            <small class="text-muted">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è</small>
                        </div>
                    </div>
                </div>

                <!-- –í –¥–≤–∏–∂–µ–Ω–∏–∏ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card duration h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-play fa-2x text-primary mb-2"></i>
                            <h5 class="card-title text-muted">–í –¥–≤–∏–∂–µ–Ω–∏–∏</h5>
                            <h3 class="text-primary mb-1" id="moveDuration">0:00</h3>
                            <small class="text-muted">–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è</small>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞ —Å—Ç–æ—è–Ω–∫–µ -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-pause fa-2x text-secondary mb-2"></i>
                            <h5 class="card-title text-muted">–ù–∞ —Å—Ç–æ—è–Ω–∫–µ</h5>
                            <h3 class="text-secondary mb-1" id="parkDuration">0:00</h3>
                            <small class="text-muted">–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</small>
                        </div>
                    </div>
                </div>

                <!-- –ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å -->
                <div class="col-xl-2 col-md-4 col-6 mb-3">
                    <div class="card stat-card speed h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-tachometer-alt fa-2x text-info mb-2"></i>
                            <h5 class="card-title text-muted">–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å</h5>
                            <h3 class="text-info mb-1" id="maxSpeed">0 –∫–º/—á</h3>
                            <small class="text-muted">–ü–∏–∫–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row" id="chartsSection" style="display: none;">
        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary chart-type-btn active" data-type="fuel">
                                    <i class="fas fa-gas-pump me-1"></i> –¢–æ–ø–ª–∏–≤–æ
                                </button>
                                <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="distance">
                                    <i class="fas fa-road me-1"></i> –ü—Ä–æ–±–µ–≥
                                </button>
                                <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="speed">
                                    <i class="fas fa-tachometer-alt me-1"></i> –°–∫–æ—Ä–æ—Å—Ç—å
                                </button>
                                <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="hours">
                                    <i class="fas fa-clock me-1"></i> –ú–æ—Ç–æ—á–∞—Å—ã
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="mainChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 data-table">
                            <thead class="table-light">
                                <tr>
                                    <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                                    <th class="text-end">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody id="detailedStats">
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–° -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–°
                    </h5>
                </div>
                <div class="card-body">
                    <div id="vehicleInfo">
                        <p class="text-muted mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ -->
    <div class="row" id="vehiclesListSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    </h5>
                    <div class="d-flex align-items-center">
                        <div class="input-group input-group-sm me-2" style="width: 200px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchVehicles" class="form-control" placeholder="–ü–æ–∏—Å–∫...">
                        </div>
                        <span class="badge historical-badge">
                            <i class="fas fa-history me-1"></i> –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="30%">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</th>
                                    <th width="15%">–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                                    <th width="15%">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</th>
                                    <th width="15%">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                                    <th width="25%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                        <p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const appState = {
    vehicles: [],
    selectedVehicle: null,
    currentPeriod: {
        start: '{{ default_start_date }}',
        end: '{{ default_end_date }}',
        step: 'hour'
    },
    statistics: null,
    chart: null
};

// –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
console.log('üîß DEBUG: Vehicles page loaded');
console.log('üìç Current path:', window.location.pathname);
console.log('üìç Default period:', appState.currentPeriod);

// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, starting initialization...');

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback –¥–∞–Ω–Ω—ã–µ
    showFallbackDataImmediately();

    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    initializePage();
});

function showFallbackDataImmediately() {
    console.log('üîÑ Showing immediate fallback data...');
    const immediateFallback = [
        {
            id: '11804e75-d2c3-4f2b-9107-5ad899adfe12',
            name: '644 Freightliner',
            license_plate: '–ù 644 –í–ö 186',
            serial: 'FLC123456',
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda'
        },
        {
            id: 'abe04e76-cf82-41ac-9836-086ae66e652e',
            name: '776 Freightliner',
            license_plate: '–í 776 –ú–ú 102',
            serial: 'FLC123457',
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda'
        },
        {
            id: '8570f4fd-ee21-431c-8412-9b4b54e955af',
            name: '336 Freightliner',
            license_plate: '–ï 336 –¢–ï 86',
            serial: 'FLC123458',
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda'
        },
        {
            id: 'mock-4',
            name: '716 Freightliner',
            license_plate: '–† 716 –†–ï 186',
            serial: 'FLC123459',
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda'
        },
        {
            id: 'mock-5',
            name: '031 Freightliner',
            license_plate: '–û 031 –£–¢ 86',
            serial: 'FLC123460',
            schema_id: 'fad66447-fe18-4a2a-a7b9-945eab775fda'
        }
    ];

    // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateVehiclesListWithData(immediateFallback);
    updateVehicleSelectWithData(immediateFallback);
    console.log('‚úÖ Immediate fallback data displayed');
}

function updateVehiclesListWithData(vehicles) {
    const tbody = document.getElementById('vehiclesTable');
    if (!tbody) {
        console.error('‚ùå vehiclesTable element not found!');
        return;
    }

    if (vehicles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    let html = '';
    vehicles.forEach(vehicle => {
        html += `
            <tr data-vehicle-id="${vehicle.id}">
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-truck me-2 text-muted"></i>
                        <div>
                            <strong>${escapeHtml(vehicle.name)}</strong>
                            ${vehicle.serial ? `<br><small class="text-muted">${escapeHtml(vehicle.serial)}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    ${vehicle.license_plate ?
                        `<span class="badge bg-dark">${escapeHtml(vehicle.license_plate)}</span>` :
                        '<span class="text-muted">‚Äî</span>'}
                </td>
                <td><span class="badge historical-badge">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</span></td>
                <td>${vehicle.serial ? escapeHtml(vehicle.serial) : '<span class="text-muted">‚Äî</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectVehicle('${vehicle.id}')">
                        <i class="fas fa-chart-bar me-1"></i> –ê–Ω–∞–ª–∏–∑
                    </button>
                    <button class="btn btn-sm btn-outline-info ms-1" onclick="showVehicleDetails('${vehicle.id}')">
                        <i class="fas fa-info-circle me-1"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    console.log(`‚úÖ Updated vehicles list with ${vehicles.length} vehicles`);
}

function updateVehicleSelectWithData(vehicles) {
    const select = document.getElementById('vehicleSelect');
    if (!select) {
        console.error('‚ùå vehicleSelect element not found!');
        return;
    }

    let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>';
    vehicles.forEach(vehicle => {
        const displayName = vehicle.license_plate ?
            `${vehicle.name} (${vehicle.license_plate})` : vehicle.name;
        html += `<option value="${vehicle.id}">${escapeHtml(displayName)}</option>`;
    });

    select.innerHTML = html;
    console.log('‚úÖ Updated vehicle select');
}

function initializePage() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateTo').max = today;
    document.getElementById('dateFrom').max = today;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    loadVehiclesList();
    setupEventListeners();
    updateCurrentTime();
}

function setupEventListeners() {
    // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–≥–∏
    document.querySelectorAll('.time-step-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-step-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            appState.currentPeriod.step = this.dataset.step;
        });
    });

    // –¢–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            if (appState.statistics) {
                updateChart(this.dataset.type);
            }
        });
    });

    // –ü–æ–∏—Å–∫ –≤ —Å–ø–∏—Å–∫–µ –¢–°
    document.getElementById('searchVehicles').addEventListener('input', function(e) {
        filterVehiclesList();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateCurrentTime, 1000);
}

async function loadVehiclesList() {
    try {
        showGlobalLoading(true);
        console.log('üîÑ Loading real vehicles data from API...');

        const response = await fetch('/vehicles/api/list/');
        console.log('üì° API Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('üìä API Data received:', data);

            if (data.success) {
                appState.vehicles = data.vehicles;
                console.log(`‚úÖ Loaded ${data.vehicles.length} vehicles, source: ${data.source}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                updateVehiclesListWithData(data.vehicles);
                updateVehicleSelectWithData(data.vehicles);

                if (data.note) {
                    showNotification(data.note, 'info');
                }

                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`, 'success');
            } else {
                console.warn('‚ö†Ô∏è API returned success:false');
                showNotification('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ', 'warning');
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Error loading vehicles list:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ', 'warning');
    } finally {
        showGlobalLoading(false);
    }
}

function filterVehiclesList() {
    const searchTerm = document.getElementById('searchVehicles').value.toLowerCase();
    const rows = document.querySelectorAll('#vehiclesTable tr[data-vehicle-id]');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function selectVehicle(vehicleId) {
    const vehicle = appState.vehicles.find(v => v.id === vehicleId);
    if (vehicle) {
        appState.selectedVehicle = vehicle;
        document.getElementById('vehicleSelect').value = vehicleId;
        updateVehicleInfo(vehicle);
        showNotification(`–í—ã–±—Ä–∞–Ω–æ –¢–°: ${vehicle.name}`, 'success');

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
        setQuickPeriod(7);
        setTimeout(() => loadStatistics(), 500);
    }
}

function showVehicleDetails(vehicleId) {
    const vehicle = appState.vehicles.find(v => v.id === vehicleId);
    if (vehicle) {
        showNotification(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ${vehicle.name} (${vehicle.license_plate})`, 'info');
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    }
}

async function loadStatistics() {
    const vehicleId = document.getElementById('vehicleSelect').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    if (!vehicleId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    if (!dateFrom || !dateTo) {
        showNotification('–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return;
    }

    if (new Date(dateFrom) > new Date(dateTo)) {
        showNotification('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'warning');
        return;
    }

    try {
        showGlobalLoading(true);

        const response = await fetch('/vehicles/api/statistics/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                vehicle_id: vehicleId,
                schema_id: appState.selectedVehicle?.schema_id || 'fad66447-fe18-4a2a-a7b9-945eab775fda',
                start_date: dateFrom,
                end_date: dateTo,
                time_step: appState.currentPeriod.step
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                appState.statistics = data.statistics;
                displayStatistics(data.statistics);
                updateChart('fuel');
                showNotification(`–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ ${dateFrom} - ${dateTo}`, 'success');
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
    } finally {
        showGlobalLoading(false);
    }
}

function displayStatistics(statistics) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏
    document.getElementById('statisticsSection').style.display = 'block';
    document.getElementById('chartsSection').style.display = 'block';

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const summary = statistics.summary;
    document.getElementById('totalDistance').textContent = `${summary.total_distance} –∫–º`;
    document.getElementById('totalFuel').textContent = `${summary.total_fuel_consumption} –ª`;
    document.getElementById('engineHours').textContent = summary.total_engine_hours;
    document.getElementById('moveDuration').textContent = summary.total_move_duration;
    document.getElementById('parkDuration').textContent = summary.total_park_duration;
    document.getElementById('maxSpeed').textContent = `${summary.max_speed} –∫–º/—á`;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–∏–æ–¥–µ
    const periodInfo = `–ü–µ—Ä–∏–æ–¥: ${document.getElementById('dateFrom').value} - ${document.getElementById('dateTo').value} (${appState.currentPeriod.step === 'hour' ? '–ø–æ—á–∞—Å–æ–≤–æ' : appState.currentPeriod.step === 'day' ? '–µ–∂–µ–¥–Ω–µ–≤–Ω–æ' : '–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ'})`;
    document.getElementById('periodInfo').textContent = periodInfo;

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateDetailedStats(summary);
}

function updateDetailedStats(summary) {
    const tbody = document.getElementById('detailedStats');

    const stats = [
        { label: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å', value: `${summary.average_speed || 0} –∫–º/—á`, icon: 'tachometer-alt' },
        { label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–ø–ª–∏–≤–∞', value: `${summary.fuel_efficiency || 0} –ª/100–∫–º`, icon: 'gas-pump' },
        { label: '–†–∞—Å—Ö–æ–¥ –Ω–∞ –º–æ—Ç–æ—á–∞—Å', value: `${(summary.total_fuel_consumption / durationToHours(summary.total_engine_hours) || 0).toFixed(1)} –ª/—á`, icon: 'clock' },
        { label: '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã', value: summary.total_engine_hours, icon: 'cogs' },
        { label: '–ö–æ—ç—Ñ. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', value: `${(durationToHours(summary.total_move_duration) / durationToHours(summary.total_engine_hours) * 100 || 0).toFixed(1)}%`, icon: 'chart-pie' }
    ];

    let html = '';
    stats.forEach(stat => {
        html += `
            <tr>
                <td>
                    <i class="fas fa-${stat.icon} me-2 text-muted"></i>
                    ${stat.label}
                </td>
                <td class="text-end fw-bold">${stat.value}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateChart(chartType) {
    const ctx = document.getElementById('mainChart').getContext('2d');

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (appState.chart) {
        appState.chart.destroy();
    }

    const timeSeries = appState.statistics.time_series;
    const labels = timeSeries.map(item => {
        if (appState.currentPeriod.step === 'hour') {
            return new Date(item.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        } else {
            return new Date(item.timestamp).toLocaleDateString('ru-RU');
        }
    });

    let data, label, color;

    switch(chartType) {
        case 'fuel':
            data = timeSeries.map(item => item.fuel_consumption);
            label = '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–ª)';
            color = '#e74c3c';
            break;
        case 'distance':
            data = timeSeries.map(item => item.distance);
            label = '–ü—Ä–æ–±–µ–≥ (–∫–º)';
            color = '#27ae60';
            break;
        case 'speed':
            data = timeSeries.map(item => item.max_speed);
            label = '–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)';
            color = '#3498db';
            break;
        case 'hours':
            data = timeSeries.map(item => durationToHours(item.engine_hours));
            label = '–ú–æ—Ç–æ—á–∞—Å—ã (—á)';
            color = '#f39c12';
            break;
    }

    appState.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color + '20',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function updateVehicleInfo(vehicle) {
    const container = document.getElementById('vehicleInfo');

    const info = `
        <div class="mb-2">
            <strong>${escapeHtml(vehicle.name)}</strong>
        </div>
        ${vehicle.license_plate ? `<div class="mb-1"><small class="text-muted">–ì–æ—Å–Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.license_plate)}</div>` : ''}
        ${vehicle.serial ? `<div class="mb-1"><small class="text-muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</small> ${escapeHtml(vehicle.serial)}</div>` : ''}
        <div class="mb-1">
            <small class="text-muted">–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</small>
            <span class="badge historical-badge">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</span>
        </div>
        <div class="mt-3">
            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</small>
        </div>
    `;

    container.innerHTML = info;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function setQuickPeriod(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - days + 1);

    document.getElementById('dateFrom').value = startDate.toISOString().split('T')[0];
    document.getElementById('dateTo').value = endDate.toISOString().split('T')[0];
}

function durationToHours(duration) {
    if (!duration) return 0;
    const parts = duration.split(':');
    return parseInt(parts[0]) + parseInt(parts[1])/60 + parseInt(parts[2])/3600;
}

function showGlobalLoading(show) {
    document.getElementById('globalLoading').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' :
                      type === 'success' ? 'alert-success' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px;';
    alert.innerHTML = `
        <strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function updateCurrentTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent =
        now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function loadData() {
    loadVehiclesList();
}

function refreshData() {
    loadVehiclesList();
    if (appState.selectedVehicle) {
        loadStatistics();
    }
}
</script>
{% endblock %}