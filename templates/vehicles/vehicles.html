{% extends 'base.html' %}

{% block page_title %}–ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞{% endblock %}

{% block extra_css %}
<style>
.chart-container {
    position: relative;
    height: 400px;
    min-height: 400px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 8px;
}
.control-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
}
.vehicle-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.vehicle-card:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}
.vehicle-card.selected {
    border-color: #007bff;
    background-color: #e7f1ff;
}
.vehicle-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-online { background-color: #28a745; }
.status-offline { background-color: #dc3545; }
.chart-type-btn {
    margin: 2px;
}
.print-btn {
    margin-left: 10px;
}
.chart-card {
    transition: transform 0.2s;
}
.chart-card:hover {
    transform: translateY(-2px);
}
.vehicle-info {
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥</a></li>
                    <li class="breadcrumb-item active"><i class="fas fa-chart-line"></i> –ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="fas fa-chart-line text-primary me-2"></i>–ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</h1>
            <p class="text-muted">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</p>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="control-panel">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input type="date" class="form-control" id="startDate" value="{{ default_start_date|default:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="date" class="form-control" id="endDate" value="{{ default_end_date|default:'' }}">
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success" id="loadDataBtn">
                    <i class="fas fa-sync-alt me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¢–°
                </button>
                <button class="btn btn-secondary print-btn" id="printBtn" style="display: none;">
                    <i class="fas fa-print me-1"></i>–ü–µ—á–∞—Ç—å
                </button>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <label class="form-label fw-bold">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary chart-type-btn active" data-type="fuel">
                        <i class="fas fa-gas-pump me-1"></i>–¢–æ–ø–ª–∏–≤–æ
                    </button>
                    <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="work">
                        <i class="fas fa-cogs me-1"></i>–†–∞–±–æ—Ç–∞
                    </button>
                    <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="speed">
                        <i class="fas fa-tachometer-alt me-1"></i>–°–∫–æ—Ä–æ—Å—Ç—å
                    </button>
                    <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="mileage">
                        <i class="fas fa-road me-1"></i>–ü—Ä–æ–±–µ–≥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ mock –¥–∞–Ω–Ω—ã—Ö -->
    <div class="alert alert-info alert-dismissible fade show mb-4" id="mockDataAlert" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>
        <strong>–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º:</strong> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –≤—ã–±–æ—Ä –¢–° -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-truck me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
                    </h6>
                </div>
                <div class="card-body p-0">
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                    <div id="vehiclesLoading" class="text-center p-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¢–°...</span>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –¢–° -->
                    <div id="vehiclesList" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-truck fa-2x mb-2"></i>
                            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¢–°" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –≥—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="col-md-9">
            <div id="chartsArea">
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                <div class="text-center p-5 text-muted" id="emptyState">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h4>–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</h4>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤</p>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
                <div id="chartsContainer" style="display: none;">
                    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentCharts = {};
let selectedVehicles = new Set();
let currentChartType = 'fuel';

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

function initializePage() {
    setupEventListeners();
    setDefaultDates();
}

function setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    document.getElementById('loadDataBtn').addEventListener('click', loadVehicles);

    // –ö–Ω–æ–ø–∫–∏ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            this.classList.add('active');
            currentChartType = this.dataset.type;
            refreshAllCharts();
        });
    });

    // –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏
    document.getElementById('printBtn').addEventListener('click', printCharts);

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç
    document.getElementById('startDate').addEventListener('change', refreshAllCharts);
    document.getElementById('endDate').addEventListener('change', refreshAllCharts);
}

function setDefaultDates() {
    const endDate = document.getElementById('endDate');
    const startDate = document.getElementById('startDate');

    if (!endDate.value) {
        const today = new Date().toISOString().split('T')[0];
        endDate.value = today;
    }

    if (!startDate.value) {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        startDate.value = weekAgo.toISOString().split('T')[0];
    }
}

async function loadVehicles() {
    const btn = document.getElementById('loadDataBtn');
    const loadingEl = document.getElementById('vehiclesLoading');

    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
    btn.disabled = true;
    loadingEl.style.display = 'block';

    try {
        const response = await fetch('/api/vehicles/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Unknown error');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è mock –¥–∞–Ω–Ω—ã–µ
        if (result.source === 'mock_data') {
            document.getElementById('mockDataAlert').style.display = 'block';
        }

        displayVehicles(result.vehicles);

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ' + error.message);
    } finally {
        btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¢–°';
        btn.disabled = false;
        loadingEl.style.display = 'none';
    }
}

function displayVehicles(vehicles) {
    const container = document.getElementById('vehiclesList');

    if (!vehicles || vehicles.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</div>';
        return;
    }

    let html = '';
    vehicles.forEach(vehicle => {
        const isOnline = vehicle.is_online || false;
        const fuelLevel = vehicle.fuel_level || '-';
        const speed = vehicle.speed || '0';

        html += `
            <div class="vehicle-card ${selectedVehicles.has(vehicle.id) ? 'selected' : ''}"
                 data-vehicle-id="${vehicle.id}">
                <div class="form-check mb-2">
                    <input class="form-check-input vehicle-checkbox" type="checkbox"
                           id="vehicle_${vehicle.id}" ${selectedVehicles.has(vehicle.id) ? 'checked' : ''}>
                    <label class="form-check-label fw-bold" for="vehicle_${vehicle.id}">
                        <span class="vehicle-status ${isOnline ? 'status-online' : 'status-offline'}"></span>
                        ${vehicle.name}
                    </label>
                </div>
                <div class="vehicle-info text-muted">
                    <div>${vehicle.license_plate || '–ù–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                    ${isOnline ? `
                        <div class="text-success">
                            <i class="fas fa-gas-pump me-1"></i>–¢–æ–ø–ª–∏–≤–æ: ${fuelLevel} –ª
                        </div>
                        <div class="text-info">
                            <i class="fas fa-tachometer-alt me-1"></i>–°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –∫–º/—á
                        </div>
                    ` : `
                        <div class="text-danger">
                            <i class="fas fa-wifi-slash me-1"></i>–ù–µ—Ç —Å–≤—è–∑–∏
                        </div>
                    `}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    container.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const vehicleId = this.closest('.vehicle-card').dataset.vehicleId;
            const vehicleCard = this.closest('.vehicle-card');

            if (this.checked) {
                selectedVehicles.add(vehicleId);
                vehicleCard.classList.add('selected');
                showVehicleChart(vehicleId);
            } else {
                selectedVehicles.delete(vehicleId);
                vehicleCard.classList.remove('selected');
                hideVehicleChart(vehicleId);
            }

            updateUIState();
        });
    });
}

function updateUIState() {
    const hasSelectedVehicles = selectedVehicles.size > 0;
    const emptyState = document.getElementById('emptyState');
    const chartsContainer = document.getElementById('chartsContainer');
    const printBtn = document.getElementById('printBtn');

    if (hasSelectedVehicles) {
        emptyState.style.display = 'none';
        chartsContainer.style.display = 'block';
        printBtn.style.display = 'inline-block';
    } else {
        emptyState.style.display = 'block';
        chartsContainer.style.display = 'none';
        printBtn.style.display = 'none';
    }
}

async function showVehicleChart(vehicleId) {
    const chartsContainer = document.getElementById('chartsContainer');

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let chartDiv = document.getElementById(`chart_${vehicleId}`);
    if (!chartDiv) {
        chartDiv = document.createElement('div');
        chartDiv.id = `chart_${vehicleId}`;
        chartDiv.className = 'chart-card mb-4';
        chartDiv.innerHTML = `
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 chart-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h6>
                    <button class="btn btn-sm btn-outline-danger remove-chart" data-vehicle-id="${vehicleId}">
                        <i class="fas fa-times"></i> –£–±—Ä–∞—Ç—å
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-loading text-center py-4">
                        <div class="spinner-border" role="status"></div>
                        <div class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                    <div class="chart-content" style="display: none;">
                        <div class="chart-container">
                            <canvas id="chartCanvas_${vehicleId}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        chartsContainer.appendChild(chartDiv);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        chartDiv.querySelector('.remove-chart').addEventListener('click', function() {
            const vehId = this.dataset.vehicleId;
            hideVehicleChart(vehId);
        });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    await loadAndCreateChart(vehicleId);
}

async function loadAndCreateChart(vehicleId) {
    const chartDiv = document.getElementById(`chart_${vehicleId}`);
    const loadingEl = chartDiv.querySelector('.chart-loading');
    const contentEl = chartDiv.querySelector('.chart-content');
    const titleEl = chartDiv.querySelector('.chart-title');

    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';

    try {
        const dateRange = getDateRange();
        const chartData = await fetchChartData(vehicleId, dateRange, currentChartType);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const vehicleName = getVehicleName(vehicleId);
        titleEl.textContent = `${vehicleName} - ${getChartTypeTitle(currentChartType)}`;

        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        createChart(vehicleId, chartData, currentChartType);

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

    } catch (error) {
        loadingEl.innerHTML = `
            <div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –¢–° ${vehicleId}:`, error);
    }
}

async function fetchChartData(vehicleId, dateRange, chartType) {
    console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞...');

    const response = await fetch('/api/vehicles/chart-data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            vehicle_id: vehicleId,
            start_date: dateRange.start,
            end_date: dateRange.end,
            chart_type: chartType
        })
    });

    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();

    if (!result.success) {
        throw new Error(result.error || 'Unknown error');
    }

    return result.chart_data;
}

function createChart(vehicleId, chartData, chartType) {
    const canvas = document.getElementById(`chartCanvas_${vehicleId}`);
    if (!canvas) return;

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentCharts[vehicleId]) {
        currentCharts[vehicleId].destroy();
    }

    const ctx = canvas.getContext('2d');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    const config = {
        type: chartType === 'work' ? 'bar' : 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '–î–∞—Ç–∞'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: getYAxisTitle(chartType)
                    }
                }
            }
        }
    };

    currentCharts[vehicleId] = new Chart(ctx, config);
}

function hideVehicleChart(vehicleId) {
    // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
    const chartDiv = document.getElementById(`chart_${vehicleId}`);
    if (chartDiv) {
        chartDiv.remove();
    }

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (currentCharts[vehicleId]) {
        currentCharts[vehicleId].destroy();
        delete currentCharts[vehicleId];
    }

    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¢–°
    const vehicleCard = document.querySelector(`.vehicle-card[data-vehicle-id="${vehicleId}"]`);
    if (vehicleCard) {
        vehicleCard.classList.remove('selected');
        const checkbox = vehicleCard.querySelector('.vehicle-checkbox');
        if (checkbox) checkbox.checked = false;
    }

    selectedVehicles.delete(vehicleId);
    updateUIState();
}

function refreshAllCharts() {
    selectedVehicles.forEach(vehicleId => {
        loadAndCreateChart(vehicleId);
    });
}

function printCharts() {
    window.print();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getDateRange() {
    return {
        start: document.getElementById('startDate').value,
        end: document.getElementById('endDate').value
    };
}

function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getVehicleName(vehicleId) {
    const vehicleCard = document.querySelector(`.vehicle-card[data-vehicle-id="${vehicleId}"]`);
    return vehicleCard ? vehicleCard.querySelector('.fw-bold').textContent.trim() : '–¢–°';
}

function getChartTypeTitle(type) {
    const titles = {
        fuel: '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞',
        work: '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã',
        speed: '–°–∫–æ—Ä–æ—Å—Ç—å',
        mileage: '–ü—Ä–æ–±–µ–≥'
    };
    return titles[type] || '–ì—Ä–∞—Ñ–∏–∫';
}

function getYAxisTitle(chartType) {
    const titles = {
        fuel: '–õ–∏—Ç—Ä—ã',
        work: '–ß–∞—Å—ã',
        speed: '–∫–º/—á',
        mileage: '–ö–∏–ª–æ–º–µ—Ç—Ä—ã'
    };
    return titles[chartType] || '–ó–Ω–∞—á–µ–Ω–∏–µ';
}

function showError(message) {
    alert('–û—à–∏–±–∫–∞: ' + message);
}
</script>
{% endblock %}