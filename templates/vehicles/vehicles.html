{% extends 'base.html' %}
{% load static %}

{% block page_title %}Анализ данных ТС{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vehicles/css/vehicles.css' %}">
{% endblock %}

{% block body_class %}vehicles-container{% endblock %}

{% block content %}
<div class="vehicles-container">
    <!-- Заголовок -->
    <div class="vehicles-header mb-4">
        <div class="header-glow"></div>
        <div class="container-fluid header-content py-3">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center">
                        <div class="header-icon-wrapper me-3">
                            <i class="fas fa-chart-network fa-2x text-gold"></i>
                        </div>
                        <div>
                            <h1 class="h2 mb-2 fw-bold text-light">Анализ данных ТС</h1>
                            <div class="d-flex align-items-center gap-3">
                                <span class="header-badge">
                                    <i class="fas fa-plug me-1"></i> AutoGRAPH Активно
                                </span>
                                <span class="text-light opacity-75">
                                    <i class="fas fa-user me-1"></i> {{ autograph_username|default:"Система" }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <button class="btn btn-gold me-2" onclick="analyzer.loadData()" id="loadDataBtn">
                        <i class="fas fa-sync-alt me-2"></i>Загрузить
                    </button>
                    <button class="btn btn-outline-gold" onclick="analyzer.showPresets()">
                        <i class="fas fa-sliders-h me-2"></i>Шаблоны
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-3">
        <div class="row g-4">
            <!-- Левая панель -->
            <div class="col-lg-3">
                <!-- Выбор ТС -->
                <div class="control-panel mb-4">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-car"></i>
                            Транспортные средства
                            <span class="badge bg-gold text-dark ms-2" id="selectedCount">0</span>
                        </h5>
                    </div>
                    <div class="panel-body">
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text bg-dark border-secondary text-light">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control bg-dark border-secondary text-light"
                                   placeholder="Поиск ТС..." id="vehicleSearch"
                                   onkeyup="analyzer.searchVehicles(this.value)">
                        </div>

                        <div class="btn-group w-100 mb-3">
                            <button class="btn btn-dark-custom flex-grow-1" onclick="analyzer.selectAllVehicles()">
                                <i class="fas fa-check-double me-1"></i> Все
                            </button>
                            <button class="btn btn-dark-custom flex-grow-1" onclick="analyzer.deselectAllVehicles()">
                                <i class="fas fa-times me-1"></i> Сбросить
                            </button>
                        </div>

                        <div class="vehicles-list" id="vehiclesList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-gold" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                                <p class="text-muted mt-3 mb-0">Загрузка ТС...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Период анализа -->
                <div class="control-panel mb-4">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-calendar-alt"></i>
                            Период анализа
                        </h5>
                    </div>
                    <div class="panel-body">
                        <div class="mb-3">
                            <label class="form-label text-light">Начало</label>
                            <input type="date" class="form-control bg-dark border-secondary text-light"
                                   id="dateFrom" value="{{ default_start_date }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">Окончание</label>
                            <input type="date" class="form-control bg-dark border-secondary text-light"
                                   id="dateTo" value="{{ default_end_date }}">
                        </div>

                        <div class="btn-group w-100 mb-3">
                            <button class="btn btn-dark-custom flex-grow-1 period-btn" data-days="1">День</button>
                            <button class="btn btn-dark-custom flex-grow-1 period-btn" data-days="7">Неделя</button>
                            <button class="btn btn-dark-custom flex-grow-1 period-btn active" data-days="30">Месяц</button>
                        </div>
                    </div>
                </div>

                <!-- Шаблоны отчетов -->
                <div class="control-panel mb-4">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-file-alt"></i>
                            Шаблоны отчетов
                        </h5>
                    </div>
                    <div class="panel-body">
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-dark-custom text-start mb-2" onclick="analyzer.applyPreset('fuel')">
                                <i class="fas fa-gas-pump me-2"></i>Расход топлива
                            </button>
                            <button class="btn btn-dark-custom text-start mb-2" onclick="analyzer.applyPreset('mileage')">
                                <i class="fas fa-route me-2"></i>Пробег и движение
                            </button>
                            <button class="btn btn-dark-custom text-start mb-2" onclick="analyzer.applyPreset('safety')">
                                <i class="fas fa-shield-alt me-2"></i>Безопасность
                            </button>
                            <button class="btn btn-dark-custom text-start mb-2" onclick="analyzer.applyPreset('engine')">
                                <i class="fas fa-cogs me-2"></i>Двигатель
                            </button>
                            <button class="btn btn-dark-custom text-start" onclick="analyzer.applyPreset('all')">
                                <i class="fas fa-chart-bar me-2"></i>Все показатели
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Центральная панель -->
            <div class="col-lg-9">
                <!-- Плеер данных -->
                <div class="data-player d-none" id="playerSection">
                    <div class="player-header">
                        <div class="player-title">
                            <i class="fas fa-play-circle"></i>
                            Плеер данных
                        </div>
                        <div class="player-speed">
                            <label class="text-light small me-2">Скорость:</label>
                            <select class="form-select form-select-sm bg-dark border-secondary text-light" id="playerSpeed">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="2">2x</option>
                                <option value="4">4x</option>
                                <option value="8">8x</option>
                            </select>
                        </div>
                    </div>

                    <div class="player-controls">
                        <button class="player-btn" id="playerPrev" title="Предыдущая запись">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="player-btn" id="playerPlay" title="Воспроизвести">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="player-btn" id="playerPause" title="Пауза">
                            <i class="fas fa-pause"></i>
                        </button>
                        <button class="player-btn" id="playerStop" title="Стоп">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="player-btn" id="playerNext" title="Следующая запись">
                            <i class="fas fa-step-forward"></i>
                        </button>

                        <div class="player-timeline" id="playerTimeline">
                            <div class="player-progress" id="playerProgress"></div>
                        </div>

                        <div class="player-time" id="playerTime">0 / 0</div>
                    </div>

                    <div class="player-data">
                        <div class="data-current-values" id="playerCurrentValues">
                            <div class="text-center py-3">
                                <i class="fas fa-database fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Загрузите данные для просмотра</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Секция графиков и таблицы -->
                <div class="charts-section d-none" id="chartsSection">
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <button class="tab-btn active" data-tab="charts" onclick="analyzer.switchTab('charts')">
                                <i class="fas fa-chart-line me-2"></i> Графики
                            </button>
                            <button class="tab-btn" data-tab="table" onclick="analyzer.switchTab('table')">
                                <i class="fas fa-table me-2"></i> Таблица данных
                            </button>
                            <button class="tab-btn" data-tab="multi" onclick="analyzer.switchTab('multi')">
                                <i class="fas fa-chart-area me-2"></i> Мультиграфики
                            </button>
                        </div>

                        <!-- Вкладка графиков -->
                        <div class="tab-content active" id="chartsTab">
                            <div class="mb-4">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-light">Тип графика</label>
                                            <select class="form-control bg-dark border-secondary text-light" id="chartTypeSelect">
                                                <option value="line">Линейный</option>
                                                <option value="bar">Столбчатый</option>
                                                <option value="area">Областной</option>
                                                <option value="scatter">Точечный</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-light">Параметр</label>
                                            <select class="form-control bg-dark border-secondary text-light" id="chartParamSelect">
                                                <option value="">Выберите параметр...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-light">Цвет</label>
                                            <input type="color" class="form-control form-control-color bg-dark border-secondary"
                                                   id="chartColorSelect" value="#FFD700" title="Выберите цвет линии">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3 d-flex align-items-end h-100">
                                            <button class="btn btn-gold w-100" onclick="analyzer.addChart()">
                                                <i class="fas fa-plus me-2"></i>Добавить график
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Активные графики -->
                            <div class="active-charts mb-4" id="activeCharts">
                                <!-- Графики будут добавляться динамически -->
                            </div>

                            <!-- Основной график -->
                            <div class="chart-wrapper">
                                <div class="chart-controls">
                                    <div class="chart-zoom-controls">
                                        <button class="zoom-btn" id="chartZoomOut" title="Уменьшить">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <input type="range" class="form-range" id="chartZoomSlider" min="1" max="100" value="100">
                                        <button class="zoom-btn" id="chartZoomIn" title="Увеличить">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <span class="time-marker ms-3" id="chartRangeInfo">Загрузка данных...</span>
                                    </div>
                                    <div class="chart-time-range">
                                        <button class="zoom-btn" id="chartPrev" title="Предыдущие данные">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <input type="range" class="form-range" id="chartRangeSlider" min="0" max="100" value="0">
                                        <button class="zoom-btn" id="chartNext" title="Следующие данные">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="chart-container">
                                    <canvas id="mainChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Вкладка мультиграфиков -->
                        <div class="tab-content" id="multiTab">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="text-gold mb-0">Мультиграфики</h5>
                                    <div>
                                        <button class="btn btn-outline-gold btn-sm me-2" onclick="analyzer.addMultiChart()">
                                            <i class="fas fa-plus me-1"></i>Новый график
                                        </button>
                                        <button class="btn btn-outline-gold btn-sm" onclick="analyzer.clearAllCharts()">
                                            <i class="fas fa-trash me-1"></i>Очистить все
                                        </button>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">Создавайте несколько графиков с разными параметрами на одном экране</p>
                            </div>

                            <div class="multi-charts-container" id="multiChartsContainer">
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
                                    <h5 class="text-gold mb-2">Нет активных графиков</h5>
                                    <p class="text-muted mb-0">Добавьте первый график с помощью кнопки "Новый график"</p>
                                </div>
                            </div>
                        </div>

                        <!-- Вкладка таблицы -->
                        <div class="tab-content" id="tableTab">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="text-gold mb-0">Таблица данных</h5>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="showAllDataSwitch" checked>
                                            <label class="form-check-label text-light small" for="showAllDataSwitch">
                                                Показать все записи
                                            </label>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-outline-gold btn-sm" onclick="analyzer.exportData('csv')" id="exportCsvBtn">
                                                <i class="fas fa-file-csv me-1"></i>CSV
                                            </button>
                                            <button class="btn btn-outline-gold btn-sm" onclick="analyzer.exportData('json')" id="exportJsonBtn">
                                                <i class="fas fa-file-code me-1"></i>JSON
                                            </button>
                                            <button class="btn btn-outline-gold btn-sm" onclick="analyzer.exportData('excel')" id="exportExcelBtn">
                                                <i class="fas fa-file-excel me-1"></i>Excel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="data-table-container">
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ТС</th>
                                                <th>Дата и время</th>
                                                <th class="text-end">Пробег (км)</th>
                                                <th class="text-end">Скорость (км/ч)</th>
                                                <th class="text-end">Расход (л)</th>
                                                <th class="text-end">Рейтинг (%)</th>
                                                <th class="text-end">Моточасы (ч)</th>
                                                <th class="text-end">Движение (ч)</th>
                                                <th class="text-end">Стоянка (ч)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="fas fa-database fa-2x text-muted mb-3"></i>
                                                    <p class="text-muted mb-0">Загрузите данные для просмотра</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Оверлей загрузки -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4 id="loadingTitle" class="mt-4 mb-2 text-gold">Загрузка данных</h4>
        <p id="loadingMessage" class="text-light opacity-75 mb-0">Пожалуйста, подождите...</p>
        <div class="progress mt-3" style="width: 300px;">
            <div class="progress-bar bg-gold" id="loadingProgress" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Контейнер для уведомлений -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Модальное окно выбора цвета -->
<div class="modal fade" id="colorPickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-gold">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gold">Выбор цвета параметра</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="color-picker-grid" id="colorPickerGrid">
                    <!-- Цвета будут добавлены динамически -->
                </div>
                <div class="mt-3">
                    <input type="color" class="form-control form-control-color" id="customColorPicker" value="#FFD700">
                    <label class="form-label text-light mt-2">Пользовательский цвет</label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-gold" onclick="analyzer.applySelectedColor()">Применить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="{% static 'vehicles/js/vehicles.js' %}"></script>

<script>
// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
    if (typeof window.analyzer !== 'undefined') {
        window.analyzer.init();
    } else {
        console.error('Analyzer не найден');
    }
});
</script>
{% endblock %}