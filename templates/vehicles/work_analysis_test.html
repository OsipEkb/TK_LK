<!-- vehicles/templates/vehicles/work_analysis_test.html -->
{% extends 'base.html' %}

{% block page_title %}–¢–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –¢–°{% endblock %}

{% block extra_css %}
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1060;
        backdrop-filter: blur(5px);
    }
    .work-color-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    .data-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .api-test-result {
        max-height: 400px;
        overflow-y: auto;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        height: 400px;
    }
    .param-badge {
        font-family: monospace;
        font-size: 0.8em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-vial me-2"></i>–¢–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –¢–°
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="col-md-4">
            <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞ -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</label>
                        <select class="form-select" id="testVehicleSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>
                        </select>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                            <input type="date" class="form-control" id="testDateFrom" value="{{ default_start_date }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="date" class="form-control" id="testDateTo" value="{{ default_end_date }}">
                        </div>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ -->
                    <div class="mb-3 p-3 bg-light rounded">
                        <h6 class="mb-2">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:</h6>
                        <div id="requestParams">
                            <p class="text-muted small">–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –∏ –¥–∞—Ç—ã</p>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="runEnhancedAnalyticsTest()">
                            <i class="fas fa-chart-bar me-1"></i> –¢–µ—Å—Ç Enhanced Analytics
                        </button>
                        <button class="btn btn-outline-primary" onclick="runDirectWorkAnalysisTest()">
                            <i class="fas fa-bolt me-1"></i> –¢–µ—Å—Ç Work Analysis API
                        </button>
                        <button class="btn btn-outline-info" onclick="runBothTests()">
                            <i class="fas fa-sync-alt me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ —Ç–µ—Å—Ç–∞
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–° -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–°
                    </h5>
                </div>
                <div class="card-body">
                    <div id="vehicleInfo">
                        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="col-md-8">
            <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>–ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã - –ì—Ä–∞—Ñ–∏–∫
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="testWorkAnalysisChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="testWorkAnalysisDetails">
                                <p class="text-muted">–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAllRawData()">
                            <i class="fas fa-eye me-1"></i> –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—Å–µ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyAllData()">
                            <i class="fas fa-copy me-1"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>

                    <!-- Enhanced Analytics Results -->
                    <div class="data-section">
                        <h6>Enhanced Analytics API</h6>
                        <div class="mb-2">
                            <span class="badge bg-secondary" id="enhancedStatus">–ù–µ –∑–∞–ø—É—â–µ–Ω</span>
                            <small class="text-muted ms-2" id="enhancedUrl"></small>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleEnhancedData()">
                                <i class="fas fa-code me-1"></i> JSON
                            </button>
                        </div>
                        <pre id="enhancedRawData" style="display: none; max-height: 300px; overflow: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 11px;"></pre>
                        <div id="enhancedAnalysis"></div>
                    </div>

                    <!-- Work Analysis Results -->
                    <div class="data-section">
                        <h6>Work Analysis API</h6>
                        <div class="mb-2">
                            <span class="badge bg-secondary" id="workAnalysisStatus">–ù–µ –∑–∞–ø—É—â–µ–Ω</span>
                            <small class="text-muted ms-2" id="workAnalysisUrl"></small>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleWorkAnalysisData()">
                                <i class="fas fa-code me-1"></i> JSON
                            </button>
                        </div>
                        <pre id="workAnalysisRawData" style="display: none; max-height: 300px; overflow: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 11px;"></pre>
                        <div id="workAnalysisResult"></div>
                    </div>
                </div>
            </div>

            <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                    </h5>
                </div>
                <div class="card-body">
                    <div id="diagnosticInfo">
                        <p class="text-muted">–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="testLoading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞...</h5>
        <p class="mb-0 text-muted" id="testLoadingMessage">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const testState = {
    vehicles: [],
    selectedVehicle: null,
    enhancedData: null,
    workAnalysisData: null,
    chart: null
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã');
    loadTestVehicles();

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç
    document.getElementById('testDateFrom').addEventListener('change', updateRequestParams);
    document.getElementById('testDateTo').addEventListener('change', updateRequestParams);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¢–°
async function loadTestVehicles() {
    try {
        showTestLoading(true, '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¢–°...');

        const response = await fetch('/vehicles/api/vehicles/page-list/');
        const data = await response.json();

        if (data.success) {
            testState.vehicles = data.data.vehicles;
            populateVehicleSelect(testState.vehicles);
            console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¢–°:', testState.vehicles.length);

            // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ –¢–° –µ—Å–ª–∏ –µ—Å—Ç—å
            if (testState.vehicles.length > 0) {
                document.getElementById('testVehicleSelect').value = testState.vehicles[0].id;
                document.getElementById('testVehicleSelect').dispatchEvent(new Event('change'));
            }
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°: ' + error.message, 'error');
    } finally {
        showTestLoading(false);
    }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
function populateVehicleSelect(vehicles) {
    const select = document.getElementById('testVehicleSelect');
    let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>';

    vehicles.forEach(vehicle => {
        html += `<option value="${vehicle.id}">${vehicle.name} (${vehicle.license_plate || '–±–µ–∑ –Ω–æ–º–µ—Ä–∞'})</option>`;
    });

    select.innerHTML = html;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
    select.addEventListener('change', function() {
        const vehicleId = this.value;
        testState.selectedVehicle = testState.vehicles.find(v => v.id === vehicleId);
        updateVehicleInfo();
        updateRequestParams();
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¢–°
function updateVehicleInfo() {
    const container = document.getElementById('vehicleInfo');

    if (!testState.selectedVehicle) {
        container.innerHTML = '<p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>';
        return;
    }

    const vehicle = testState.selectedVehicle;
    container.innerHTML = `
        <table class="table table-sm">
            <tr>
                <td><strong>ID:</strong></td>
                <td><code class="small">${vehicle.id}</code></td>
            </tr>
            <tr>
                <td><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></td>
                <td>${vehicle.name}</td>
            </tr>
            <tr>
                <td><strong>–ì–æ—Å–Ω–æ–º–µ—Ä:</strong></td>
                <td>${vehicle.license_plate || '‚Äî'}</td>
            </tr>
            <tr>
                <td><strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</strong></td>
                <td>${vehicle.serial || '‚Äî'}</td>
            </tr>
        </table>
    `;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
function updateRequestParams() {
    const container = document.getElementById('requestParams');
    const vehicleId = testState.selectedVehicle?.id;
    const startDate = document.getElementById('testDateFrom').value;
    const endDate = document.getElementById('testDateTo').value;

    if (!vehicleId || !startDate || !endDate) {
        container.innerHTML = '<p class="text-muted small">–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –∏ –¥–∞—Ç—ã</p>';
        return;
    }

    container.innerHTML = `
        <div class="mb-1">
            <span class="param-badge badge bg-dark">vehicle_id=${vehicleId}</span>
        </div>
        <div class="mb-1">
            <span class="param-badge badge bg-dark">start_date=${startDate}</span>
        </div>
        <div>
            <span class="param-badge badge bg-dark">end_date=${endDate}</span>
        </div>
    `;
}

// –¢–ï–°–¢ 1: Enhanced Analytics API
async function runEnhancedAnalyticsTest() {
    if (!validateTestParameters()) return;

    try {
        showTestLoading(true, '–¢–µ—Å—Ç Enhanced Analytics API...');

        const vehicleId = testState.selectedVehicle.id;
        const startDate = document.getElementById('testDateFrom').value;
        const endDate = document.getElementById('testDateTo').value;

        const url = `/vehicles/api/enhanced-analytics/?vehicle_ids=${vehicleId}&start_date=${startDate}&end_date=${endDate}`;

        console.log('üîç Enhanced Analytics –∑–∞–ø—Ä–æ—Å:', url);
        document.getElementById('enhancedUrl').textContent = url;

        const response = await fetch(url);
        const data = await response.json();

        testState.enhancedData = data;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('enhancedStatus').className = data.success ? 'badge bg-success' : 'badge bg-danger';
        document.getElementById('enhancedStatus').textContent = data.success ? '–£—Å–ø–µ—Ö' : '–û—à–∏–±–∫–∞';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('enhancedRawData').textContent = JSON.stringify(data, null, 2);

        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        displayEnhancedAnalysis(data);

        // –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (data.success) {
            renderTestChart(data, 'enhanced');
        }

        console.log('‚úÖ Enhanced Analytics —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Enhanced Analytics —Ç–µ—Å—Ç–∞:', error);
        document.getElementById('enhancedStatus').className = 'badge bg-danger';
        document.getElementById('enhancedStatus').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('enhancedUrl').textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
        showNotification('–û—à–∏–±–∫–∞ Enhanced Analytics: ' + error.message, 'error');
    } finally {
        showTestLoading(false);
    }
}

// –¢–ï–°–¢ 2: Direct Work Analysis API
async function runDirectWorkAnalysisTest() {
    if (!validateTestParameters()) return;

    try {
        showTestLoading(true, '–¢–µ—Å—Ç Work Analysis API...');

        const vehicleId = testState.selectedVehicle.id;
        const startDate = document.getElementById('testDateFrom').value;
        const endDate = document.getElementById('testDateTo').value;

        const url = `/vehicles/api/work-analysis/?vehicle_id=${vehicleId}&start_date=${startDate}&end_date=${endDate}`;

        console.log('‚ö° Work Analysis –∑–∞–ø—Ä–æ—Å:', url);
        document.getElementById('workAnalysisUrl').textContent = url;

        const response = await fetch(url);
        const data = await response.json();

        testState.workAnalysisData = data;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('workAnalysisStatus').className = data.success ? 'badge bg-success' : 'badge bg-danger';
        document.getElementById('workAnalysisStatus').textContent = data.success ? '–£—Å–ø–µ—Ö' : '–û—à–∏–±–∫–∞';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('workAnalysisRawData').textContent = JSON.stringify(data, null, 2);

        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        displayWorkAnalysisResult(data);

        // –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (data.success) {
            renderTestChart(data, 'workAnalysis');
        }

        console.log('‚úÖ Work Analysis —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Work Analysis —Ç–µ—Å—Ç–∞:', error);
        document.getElementById('workAnalysisStatus').className = 'badge bg-danger';
        document.getElementById('workAnalysisStatus').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('workAnalysisUrl').textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
        showNotification('–û—à–∏–±–∫–∞ Work Analysis: ' + error.message, 'error');
    } finally {
        showTestLoading(false);
    }
}

// –¢–ï–°–¢ 3: –û–±–∞ —Ç–µ—Å—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
async function runBothTests() {
    if (!validateTestParameters()) return;

    try {
        showTestLoading(true, '–ó–∞–ø—É—Å–∫ –æ–±–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤...');

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–∞ —Ç–µ—Å—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        await Promise.all([
            runEnhancedAnalyticsTest(),
            runDirectWorkAnalysisTest()
        ]);

        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        compareResults();

        showNotification('–û–±–∞ —Ç–µ—Å—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã', 'success');

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤: ' + error.message, 'error');
    } finally {
        showTestLoading(false);
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
function validateTestParameters() {
    if (!testState.selectedVehicle) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –¢–° –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
        return false;
    }

    const startDate = document.getElementById('testDateFrom').value;
    const endDate = document.getElementById('testDateTo').value;

    if (!startDate || !endDate) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞', 'warning');
        return false;
    }

    return true;
}

// –ê–Ω–∞–ª–∏–∑ Enhanced Analytics –¥–∞–Ω–Ω—ã—Ö
function displayEnhancedAnalysis(data) {
    const container = document.getElementById('enhancedAnalysis');

    if (!data.success) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <strong>–û—à–∏–±–∫–∞ API:</strong> ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
            </div>
        `;
        return;
    }

    let html = '<div class="alert alert-success"><strong>–£—Å–ø–µ—Ö:</strong> –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã</div>';

    const analyticsData = data.data;

    if (analyticsData.vehicle_metrics) {
        const vehicleIds = Object.keys(analyticsData.vehicle_metrics);
        html += `<p><strong>–¢–° –≤ –¥–∞–Ω–Ω—ã—Ö:</strong> ${vehicleIds.length}</p>`;

        vehicleIds.forEach(vehicleId => {
            const vehicleData = analyticsData.vehicle_metrics[vehicleId];
            html += `
                <div class="card mt-2">
                    <div class="card-header py-1 small">
                        <strong>–¢–° ID:</strong> ${vehicleId}
                    </div>
                    <div class="card-body py-2">
                        <table class="table table-sm table-bordered mb-2">
                            <tr><td>basic_info</td><td>${vehicleData.basic_info ? '‚úÖ' : '‚ùå'}</td></tr>
                            <tr><td>trips_data</td><td>${vehicleData.trips_data ? `‚úÖ ${vehicleData.trips_data.length} —Ä–µ–π—Å–æ–≤` : '‚ùå'}</td></tr>
                            <tr><td>track_data</td><td>${vehicleData.track_data ? `‚úÖ ${vehicleData.track_data.length} —Ç–æ—á–µ–∫` : '‚ùå'}</td></tr>
                            <tr><td>work_analysis</td><td>${vehicleData.work_analysis ? '‚úÖ' : '‚ùå'}</td></tr>
                        </table>
            `;

            if (vehicleData.work_analysis) {
                html += `<div><strong>work_analysis:</strong><br>`;
                Object.keys(vehicleData.work_analysis).forEach(key => {
                    const value = vehicleData.work_analysis[key];
                    if (typeof value === 'object' && value !== null) {
                        html += `<small>${key}: ${JSON.stringify(value)}</small><br>`;
                    }
                });
                html += `</div>`;
            }

            html += `</div></div>`;
        });
    }

    container.innerHTML = html;
}

// –ê–Ω–∞–ª–∏–∑ Work Analysis –¥–∞–Ω–Ω—ã—Ö
function displayWorkAnalysisResult(data) {
    const container = document.getElementById('workAnalysisResult');

    if (!data.success) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <strong>–û—à–∏–±–∫–∞ API:</strong> ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
            </div>
        `;
        return;
    }

    let html = '<div class="alert alert-success"><strong>–£—Å–ø–µ—Ö:</strong> Work Analysis –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã</div>';

    const workData = data.data;

    if (workData.work_analysis) {
        html += `<div class="mt-3"><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ work_analysis:</strong><br>`;
        Object.keys(workData.work_analysis).forEach(key => {
            const value = workData.work_analysis[key];
            html += `<div class="mb-1"><code>${key}: ${JSON.stringify(value)}</code></div>`;
        });
        html += `</div>`;
    } else {
        html += `<div class="alert alert-warning">–ù–µ—Ç work_analysis –≤ –æ—Ç–≤–µ—Ç–µ</div>`;
    }

    container.innerHTML = html;
}

// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function compareResults() {
    const container = document.getElementById('diagnosticInfo');
    let html = '<h6>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</h6>';

    if (!testState.enhancedData || !testState.workAnalysisData) {
        html += '<p class="text-muted">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–∞ —Ç–µ—Å—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>';
        container.innerHTML = html;
        return;
    }

    const enhancedSuccess = testState.enhancedData.success;
    const workAnalysisSuccess = testState.workAnalysisData.success;

    html += `
        <table class="table table-sm table-bordered">
            <tr>
                <th>API</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>work_analysis –¥–æ—Å—Ç—É–ø–µ–Ω</th>
            </tr>
            <tr>
                <td>Enhanced Analytics</td>
                <td>${enhancedSuccess ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'}</td>
                <td>${enhancedSuccess && testState.enhancedData.data.vehicle_metrics ?
                    (Object.values(testState.enhancedData.data.vehicle_metrics)[0].work_analysis ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç') : '‚Äî'}</td>
            </tr>
            <tr>
                <td>Work Analysis</td>
                <td>${workAnalysisSuccess ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'}</td>
                <td>${workAnalysisSuccess && testState.workAnalysisData.data.work_analysis ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</td>
            </tr>
        </table>
    `;

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    if (enhancedSuccess && workAnalysisSuccess) {
        const enhancedWorkAnalysis = testState.enhancedData.data.vehicle_metrics ?
            Object.values(testState.enhancedData.data.vehicle_metrics)[0].work_analysis : null;
        const directWorkAnalysis = testState.workAnalysisData.data.work_analysis;

        if (enhancedWorkAnalysis && directWorkAnalysis) {
            html += `<div class="mt-3"><strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö work_analysis:</strong><br>`;

            const fields = ['engine_work_without_movement', 'engine_work_in_motion', 'parking_engine_off', 'no_data'];
            fields.forEach(field => {
                const enhancedValue = enhancedWorkAnalysis[field]?.percentage || 0;
                const directValue = directWorkAnalysis[field]?.percentage || 0;
                const diff = Math.abs(enhancedValue - directValue);

                html += `<div class="mb-1">
                    ${field}: Enhanced=${enhancedValue}%, Direct=${directValue}%,
                    <span class="${diff > 1 ? 'text-warning' : 'text-success'}">–†–∞–∑–Ω–∏—Ü–∞=${diff.toFixed(2)}%</span>
                </div>`;
            });

            html += `</div>`;
        }
    }

    container.innerHTML = html;
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function renderTestChart(data, source) {
    const ctx = document.getElementById('testWorkAnalysisChart').getContext('2d');

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
    if (testState.chart) {
        testState.chart.destroy();
    }

    const chartData = prepareTestChartData(data, source);

    testState.chart = new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: `–ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã (${source === 'enhanced' ? 'Enhanced Analytics' : 'Work Analysis API'})`
                }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
    updateTestWorkAnalysisDetails(data, source);
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
function prepareTestChartData(data, source) {
    if (!data.success) {
        return getEmptyChartData();
    }

    let workAnalysis;

    if (source === 'enhanced') {
        // –î–∞–Ω–Ω—ã–µ –∏–∑ Enhanced Analytics
        const vehicleId = testState.selectedVehicle.id;
        const vehicleData = data.data.vehicle_metrics[vehicleId];
        workAnalysis = vehicleData?.work_analysis;
    } else {
        // –î–∞–Ω–Ω—ã–µ –∏–∑ Work Analysis API
        workAnalysis = data.data.work_analysis;
    }

    if (!workAnalysis) {
        return getEmptyChartData();
    }

    const percentages = [
        workAnalysis.engine_work_without_movement?.percentage || 0,
        workAnalysis.engine_work_in_motion?.percentage || 0,
        workAnalysis.parking_engine_off?.percentage || 0,
        workAnalysis.no_data?.percentage || 0
    ];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
    if (percentages.reduce((sum, perc) => sum + perc, 0) === 0) {
        return getEmptyChartData();
    }

    return {
        labels: [
            '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è',
            '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏',
            '–ü—Ä–æ—Å—Ç–æ–π (–¥–≤–∏–≥–∞—Ç–µ–ª—å –≤—ã–∫–ª.)',
            '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'
        ],
        datasets: [{
            data: percentages,
            backgroundColor: [
                '#ffc107',
                '#28a745',
                '#6c757d',
                '#e9ecef'
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

function getEmptyChartData() {
    return {
        labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
        datasets: [{
            data: [100],
            backgroundColor: ['#e9ecef'],
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞
function updateTestWorkAnalysisDetails(data, source) {
    const container = document.getElementById('testWorkAnalysisDetails');

    if (!data.success) {
        container.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
        return;
    }

    let workAnalysis;
    let title = source === 'enhanced' ? 'Enhanced Analytics' : 'Work Analysis API';

    if (source === 'enhanced') {
        const vehicleId = testState.selectedVehicle.id;
        const vehicleData = data.data.vehicle_metrics[vehicleId];
        workAnalysis = vehicleData?.work_analysis;
    } else {
        workAnalysis = data.data.work_analysis;
    }

    if (!workAnalysis) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ ${title}
            </div>
        `;
        return;
    }

    let html = `<h6>–î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ (${title}):</h6>`;

    const categories = [
        { key: 'engine_work_without_movement', label: '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è', color: '#ffc107' },
        { key: 'engine_work_in_motion', label: '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏', color: '#28a745' },
        { key: 'parking_engine_off', label: '–ü—Ä–æ—Å—Ç–æ–π (–¥–≤–∏–≥–∞—Ç–µ–ª—å –≤—ã–∫–ª.)', color: '#6c757d' },
        { key: 'no_data', label: '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', color: '#e9ecef' }
    ];

    categories.forEach(category => {
        const data = workAnalysis[category.key];
        if (data) {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div class="d-flex align-items-center">
                        <span class="work-color-indicator me-2" style="background-color: ${category.color};"></span>
                        <span>${data.formatted || '0 —á–∞—Å. 00 –º–∏–Ω.'}</span>
                    </div>
                    <span class="badge bg-light text-dark">${data.percentage || 0}%</span>
                </div>
                <small class="text-muted d-block mb-3">${category.label}</small>
            `;
        }
    });

    if (workAnalysis.total_period) {
        html += `
            <div class="mt-3 p-2 bg-light rounded">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    –û–±—â–∏–π –ø–µ—Ä–∏–æ–¥: ${workAnalysis.total_period.formatted || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                </small>
            </div>
        `;
    }

    container.innerHTML = html;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showTestLoading(show, message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const overlay = document.getElementById('testLoading');
    const messageElement = document.getElementById('testLoadingMessage');

    if (show) {
        messageElement.textContent = message;
        overlay.style.display = 'flex';
    } else {
        overlay.style.display = 'none';
    }
}

function toggleEnhancedData() {
    const output = document.getElementById('enhancedRawData');
    output.style.display = output.style.display === 'none' ? 'block' : 'none';
}

function toggleWorkAnalysisData() {
    const output = document.getElementById('workAnalysisRawData');
    output.style.display = output.style.display === 'none' ? 'block' : 'none';
}

function toggleAllRawData() {
    toggleEnhancedData();
    toggleWorkAnalysisData();
}

function copyAllData() {
    const allData = {
        enhancedAnalytics: testState.enhancedData,
        workAnalysis: testState.workAnalysisData,
        testParameters: {
            vehicle: testState.selectedVehicle,
            dateFrom: document.getElementById('testDateFrom').value,
            dateTo: document.getElementById('testDateTo').value
        }
    };

    navigator.clipboard.writeText(JSON.stringify(allData, null, 2));
    showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}