{% extends 'base.html' %}

{% block page_title %}–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏{% endblock %}

{% block body_class %}test-dashboard-container{% endblock %}

{% block content %}
<div class="test-dashboard-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="test-header mb-4">
        <div class="header-glow"></div>
        <div class="container-fluid header-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center">
                        <div class="header-icon-wrapper me-4">
                            <i class="fas fa-chart-network fa-2x text-gold"></i>
                            <span class="test-badge">–¢–ï–°–¢</span>
                        </div>
                        <div>
                            <h1 class="h1 mb-2 fw-bold text-light">–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏</h1>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-danger">
                                    <i class="fas fa-flask me-1"></i> –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú
                                </span>
                                <span class="text-light opacity-75">
                                    <i class="fas fa-database me-1"></i> –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ AutoGRAPH
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="btn-group">
                        <a href="{% url 'vehicles_main' %}" class="btn btn-outline-gold">
                            <i class="fas fa-arrow-left me-2"></i>–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
                        </a>
                        <button class="btn btn-gold" onclick="testDashboard.loadRawData()">
                            <i class="fas fa-sync-alt me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="info-panel info-warning">
                    <div class="info-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="info-content">
                        <strong>–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º:</strong> –≠—Ç–∞ –ø–∞–Ω–µ–ª—å –≤—ã–≤–æ–¥–∏—Ç –í–°–ï —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ AutoGRAPH API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
                        <br>
                        <small class="opacity-75">–ü–µ—Ä–∏–æ–¥: <span id="periodDisplay">03.12.2025 - 10.12.2025</span></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="col-lg-3">
                <!-- –í—ã–±–æ—Ä –¢–° -->
                <div class="control-panel mb-4">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-car"></i>
                            –í—ã–±–æ—Ä –¢–°
                            <span class="badge bg-gold text-dark ms-2" id="testSelectedCount">0</span>
                        </h5>
                        <div class="input-group input-group-sm mt-2">
                            <span class="input-group-text bg-dark border-secondary text-light">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control bg-dark border-secondary text-light"
                                   placeholder="–ü–æ–∏—Å–∫ –¢–°..." id="testVehicleSearch"
                                   onkeyup="testDashboard.searchVehicles(this.value)">
                        </div>
                    </div>
                    <div class="panel-body" style="height: 300px; overflow-y: auto;">
                        <div class="btn-group w-100 mb-3">
                            <button class="btn btn-dark-custom flex-grow-1" onclick="testDashboard.selectAllVehicles()">
                                <i class="fas fa-check-double me-1"></i> –í—Å–µ
                            </button>
                            <button class="btn btn-dark-custom flex-grow-1" onclick="testDashboard.deselectAllVehicles()">
                                <i class="fas fa-times me-1"></i> –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                        </div>

                        <div class="vehicles-list" id="testVehiclesList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-gold" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <p class="text-muted mt-3 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –¢–°...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ -->
                <div class="control-panel mb-4">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-calendar-alt"></i>
                            –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
                        </h5>
                    </div>
                    <div class="panel-body">
                        <div class="mb-3">
                            <label class="form-label text-light">–ù–∞—á–∞–ª–æ</label>
                            <input type="date" class="form-control bg-dark border-secondary text-light"
                                   id="testDateFrom" value="2025-12-03">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
                            <input type="date" class="form-control bg-dark border-secondary text-light"
                                   id="testDateTo" value="2025-12-10">
                        </div>

                        <div class="btn-group w-100 mb-3">
                            <button class="btn btn-dark-custom flex-grow-1" onclick="testDashboard.setPeriod(1)">–î–µ–Ω—å</button>
                            <button class="btn btn-dark-custom flex-grow-1" onclick="testDashboard.setPeriod(7)">–ù–µ–¥–µ–ª—è</button>
                            <button class="btn btn-dark-custom flex-grow-1" onclick="testDashboard.setPeriod(30)">–ú–µ—Å—è—Ü</button>
                        </div>

                        <button class="btn btn-gold w-100" id="testLoadDataBtn" onclick="testDashboard.loadRawData()" disabled>
                            <i class="fas fa-database me-2"></i>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="control-panel">
                    <div class="panel-header">
                        <h5 class="panel-title">
                            <i class="fas fa-info-circle"></i>
                            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h5>
                    </div>
                    <div class="panel-body">
                        <div class="info-item">
                            <div class="info-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</div>
                            <div class="info-value" id="totalRecordsInfo">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–ü–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:</div>
                            <div class="info-value" id="totalParamsInfo">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–¢–° –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</div>
                            <div class="info-value" id="vehiclesLoadedInfo">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–∞–Ω–Ω—ã–º–∏ -->
            <div class="col-lg-9">
                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                <div class="tabs-container mb-4">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="rawdata">
                            <i class="fas fa-database me-2"></i> –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="tab-btn" data-tab="analysis">
                            <i class="fas fa-chart-line me-2"></i> –ê–Ω–∞–ª–∏–∑
                        </button>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="tab-content active" id="rawdataTab">
                        <div class="raw-data-container">
                            <!-- –í—ã–±–æ—Ä –¢–° –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label text-light">–¢–° –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</label>
                                    <select class="form-control bg-dark border-secondary text-light"
                                            id="rawDataVehicleSelect" onchange="testDashboard.showVehicleData()">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-light">–ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:</label>
                                    <div class="input-group">
                                        <select class="form-control bg-dark border-secondary text-light"
                                                id="rawDataParamSelect">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä...</option>
                                        </select>
                                        <button class="btn btn-gold" onclick="testDashboard.plotParameter()">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
                            <div class="card bg-dark border-secondary mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 100 –∑–∞–ø–∏—Å–µ–π)</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-dark table-hover mb-0">
                                            <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                                <tr>
                                                    <th>#</th>
                                                    <th>–í—Ä–µ–º—è</th>
                                                    <th>–°—Ç–∞–¥–∏—è</th>
                                                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                                    <th>Speed</th>
                                                    <th>Fuel</th>
                                                    <th>Distance</th>
                                                    <th>Rating</th>
                                                    <th>–î–µ—Ç–∞–ª–∏</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rawDataTableBody">
                                                <tr>
                                                    <td colspan="9" class="text-center py-4">
                                                        <i class="fas fa-database fa-2x text-muted mb-3"></i>
                                                        <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ -->
                            <div class="card bg-dark border-secondary mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">–ì—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-mini-container">
                                        <canvas id="rawParamChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                            <div class="card bg-dark border-secondary">
                                <div class="card-header">
                                    <h5 class="mb-0">–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¢–°</h5>
                                    <small class="text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</small>
                                </div>
                                <div class="card-body">
                                    <div id="rawParamsList" class="params-grid">
                                        <div class="text-center py-4">
                                            <p class="text-muted mb-0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –ê–Ω–∞–ª–∏–∑ -->
                    <div class="tab-content" id="analysisTab">
                        <div class="analysis-container">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary mb-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="paramsStats" class="stats-list">
                                                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary mb-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="btn-group-vertical w-100">
                                                <button class="btn btn-dark-custom mb-2" onclick="testDashboard.exportData('json')">
                                                    <i class="fas fa-file-code me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                                                </button>
                                                <button class="btn btn-dark-custom mb-2" onclick="testDashboard.exportData('csv')">
                                                    <i class="fas fa-file-csv me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                                                </button>
                                                <button class="btn btn-dark-custom" onclick="testDashboard.exportData('excel')">
                                                    <i class="fas fa-file-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞–ø–∏—Å–∏ -->
<div class="modal fade" id="recordDetailsModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gold">–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm table-dark" id="basicInfoTable">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h6>
                        <div class="params-details-container" id="paramsDetailsContainer">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="loading-overlay" id="testLoadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4 id="testLoadingTitle" class="mt-4 mb-2 text-gold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
        <p id="testLoadingMessage" class="text-light opacity-75 mb-0">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ AutoGRAPH...</p>
        <div class="progress mt-3" style="width: 300px;">
            <div class="progress-bar bg-gold" id="testLoadingProgress" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="testNotificationContainer" class="notification-container"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ============================================
// Test Dashboard - –ü–∞–Ω–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
// ============================================
class TestDashboard {
    constructor() {
        this.vehicles = [];
        this.filteredVehicles = [];
        this.selectedVehicles = [];
        this.rawData = null;
        this.currentVehicleId = null;
        this.chart = null;
    }

    // ============================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ============================================
    async init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏');

        try {
            await this.loadVehicles();
            this.setupEventListeners();
            this.setupTabs();
            this.updatePeriodDisplay();

            this.showNotification('–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'info');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            this.showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
        }
    }

    // ============================================
    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    // ============================================
    async loadVehicles() {
        this.showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¢–°', '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤...');

        try {
            const response = await fetch('/vehicles/api/get-vehicles/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞ ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                this.vehicles = data.data.vehicles;
                this.filteredVehicles = [...this.vehicles];
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¢–°: ${this.vehicles.length}`);
                this.renderVehiclesList();
                this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.vehicles.length} –¢–°`, 'success');
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°');
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°:', error);
            this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–°: ' + error.message, 'error');

        } finally {
            this.hideLoading();
        }
    }

    async loadRawData() {
        if (this.selectedVehicles.length === 0) {
            this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¢–°', 'warning');
            return;
        }

        const startDate = document.getElementById('testDateFrom').value;
        const endDate = document.getElementById('testDateTo').value;

        if (!startDate || !endDate) {
            this.showNotification('–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞', 'warning');
            return;
        }

        try {
            this.showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö', '–ü–æ–ª—É—á–µ–Ω–∏–µ –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö –∏–∑ AutoGRAPH...');
            this.updateProgress(30, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');

            const response = await fetch('/vehicles/api/test-get-raw-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    vehicle_ids: this.selectedVehicles,
                    start_date: startDate,
                    end_date: endDate
                })
            });

            this.updateProgress(60, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
            }

            const data = await response.json();
            this.updateProgress(90, '–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');

            if (data.success) {
                this.rawData = data.data;
                this.updateRawDataUI();
                this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.rawData.total_records} –∑–∞–ø–∏—Å–µ–π`, 'success');

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                this.switchTab('rawdata');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ –¢–°
                if (Object.keys(this.rawData.vehicles).length > 0) {
                    const firstVehicleId = Object.keys(this.rawData.vehicles)[0];
                    this.showVehicleData(firstVehicleId);
                }

            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            this.showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');

        } finally {
            this.updateProgress(100, '–ó–∞–≤–µ—Ä—à–µ–Ω–æ');
            setTimeout(() => this.hideLoading(), 1000);
        }
    }

    // ============================================
    // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–•
    // ============================================
    updateRawDataUI() {
        if (!this.rawData) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        document.getElementById('totalRecordsInfo').textContent =
            this.rawData.total_records.toLocaleString('ru-RU');
        document.getElementById('totalParamsInfo').textContent =
            this.rawData.all_parameters.length;
        document.getElementById('vehiclesLoadedInfo').textContent =
            Object.keys(this.rawData.vehicles).length;

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
        this.updatePeriodDisplay();
    }

    showVehicleData(vehicleId = null) {
        if (!vehicleId) {
            vehicleId = document.getElementById('rawDataVehicleSelect').value;
        }

        if (!vehicleId || !this.rawData || !this.rawData.vehicles[vehicleId]) {
            return;
        }

        this.currentVehicleId = vehicleId;
        const vehicleData = this.rawData.vehicles[vehicleId];

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –¢–° –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const vehicleSelect = document.getElementById('rawDataVehicleSelect');
        if (vehicleSelect.value !== vehicleId) {
            vehicleSelect.value = vehicleId;
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        this.renderDataTable(vehicleData);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        this.renderParametersList(vehicleData);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        this.renderParameterSelect(vehicleData);
    }

    renderDataTable(vehicleData) {
        const tbody = document.getElementById('rawDataTableBody');

        if (!vehicleData.samples || vehicleData.samples.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="fas fa-database fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';

        vehicleData.samples.forEach((item, index) => {
            const speed = this.getParamValue(item.Values, ['Speed', 'AverageSpeed', 'MaxSpeed']);
            const fuel = this.getParamValue(item.Values, ['Engine1FuelConsum', 'FuelConsumption', 'Fuel']);
            const distance = this.getParamValue(item.Values, ['TotalDistance', 'Distance', 'Odometer']);
            const rating = this.getParamValue(item.Values, ['DQRating', 'Rating']);

            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${this.formatDateTime(item.DT)}</td>
                    <td><span class="badge bg-secondary">${item.Stage || '‚Äî'}</span></td>
                    <td>${item.Duration || '‚Äî'}</td>
                    <td>${speed}</td>
                    <td>${fuel}</td>
                    <td>${distance}</td>
                    <td>${rating}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-gold"
                                onclick="testDashboard.showRecordDetails('${this.currentVehicleId}', ${index})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    renderParametersList(vehicleData) {
        const paramsList = document.getElementById('rawParamsList');

        if (!vehicleData.params || vehicleData.params.length === 0) {
            paramsList.innerHTML = `
                <div class="text-center py-4 w-100">
                    <p class="text-muted mb-0">–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                </div>
            `;
            return;
        }

        let html = '';

        vehicleData.params.forEach(param => {
            html += `
                <div class="param-item" onclick="testDashboard.plotSpecificParameter('${param}')">
                    <div class="param-name" title="${param}">${param}</div>
                    <div class="param-actions">
                        <button class="btn btn-sm btn-outline-gold" onclick="event.stopPropagation(); testDashboard.plotSpecificParameter('${param}')">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        paramsList.innerHTML = html;
    }

    renderParameterSelect(vehicleData) {
        const paramSelect = document.getElementById('rawDataParamSelect');

        let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä...</option>';

        if (vehicleData.params && vehicleData.params.length > 0) {
            vehicleData.params.forEach(param => {
                html += `<option value="${param}">${param}</option>`;
            });
        }

        paramSelect.innerHTML = html;
    }

    // ============================================
    // –ì–†–ê–§–ò–ö–ò
    // ============================================
    plotParameter() {
        const paramSelect = document.getElementById('rawDataParamSelect');
        const param = paramSelect.value;

        if (!param) {
            this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞', 'warning');
            return;
        }

        this.plotSpecificParameter(param);
    }

    plotSpecificParameter(paramName) {
        if (!this.currentVehicleId || !this.rawData || !this.rawData.vehicles[this.currentVehicleId]) {
            this.showNotification('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¢–°', 'warning');
            return;
        }

        const vehicleData = this.rawData.vehicles[this.currentVehicleId];
        if (!vehicleData.samples) return;

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const labels = [];
        const data = [];

        vehicleData.samples.forEach((item, index) => {
            if (item.Values[paramName] !== undefined && item.DT) {
                const time = this.formatTime(item.DT);
                const value = parseFloat(item.Values[paramName]);

                if (!isNaN(value)) {
                    labels.push(`${index + 1}. ${time}`);
                    data.push(value);
                }
            }
        });

        if (labels.length === 0) {
            this.showNotification(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ "${paramName}"`, 'warning');
            return;
        }

        // –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫
        const canvas = document.getElementById('rawParamChart');
        const ctx = canvas.getContext('2d');

        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
        if (this.chart) {
            this.chart.destroy();
        }

        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: paramName,
                    data: data,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: '#FFD700'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `–ü–∞—Ä–∞–º–µ—Ç—Ä: ${paramName}`,
                        color: '#FFD700',
                        font: { size: 16 }
                    },
                    legend: {
                        labels: {
                            color: '#FFFFFF',
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#FFD700',
                        bodyColor: '#FFFFFF',
                        borderColor: '#FFD700',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#CCCCCC',
                            maxTicksLimit: 20,
                            callback: function(value, index) {
                                return index + 1; // –ü—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#CCCCCC',
                            callback: (value) => this.formatNumber(value, 2)
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –≤ —Å–µ–ª–µ–∫—Ç–µ
        document.getElementById('rawDataParamSelect').value = paramName;

        this.showNotification(`–ü–æ—Å—Ç—Ä–æ–µ–Ω –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ "${paramName}"`, 'success');
    }

    // ============================================
    // –ü–†–û–°–ú–û–¢–† –î–ï–¢–ê–õ–ï–ô
    // ============================================
    showRecordDetails(vehicleId, itemIndex) {
        if (!this.rawData || !this.rawData.vehicles[vehicleId]) {
            return;
        }

        const vehicleData = this.rawData.vehicles[vehicleId];
        const item = vehicleData.samples[itemIndex];

        if (!item) return;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const basicInfoTable = document.getElementById('basicInfoTable');
        basicInfoTable.innerHTML = `
            <tr><td>–¢–°:</td><td class="text-gold">${vehicleData.name}</td></tr>
            <tr><td>–í—Ä–µ–º—è:</td><td>${this.formatDateTime(item.DT)}</td></tr>
            <tr><td>–°—Ç–∞–¥–∏—è:</td><td>${item.Stage || '‚Äî'}</td></tr>
            <tr><td>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</td><td>${item.Duration || '‚Äî'}</td></tr>
            <tr><td>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</td><td>${item.Caption || '‚Äî'}</td></tr>
        `;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const paramsContainer = document.getElementById('paramsDetailsContainer');
        let paramsHtml = '<div class="params-details-grid">';

        for (const [param, value] of Object.entries(item.Values)) {
            const numValue = parseFloat(value);
            const isNumeric = !isNaN(numValue);

            paramsHtml += `
                <div class="param-detail-item">
                    <div class="param-detail-name" title="${param}">${param}</div>
                    <div class="param-detail-value ${isNumeric ? 'numeric' : ''}">
                        ${isNumeric ? this.formatNumber(numValue, 4) : value}
                    </div>
                </div>
            `;
        }

        paramsHtml += '</div>';
        paramsContainer.innerHTML = paramsHtml;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('recordDetailsModal'));
        modal.show();
    }

    // ============================================
    // –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–•
    // ============================================
    exportData(format) {
        if (!this.rawData) {
            this.showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }

        let dataStr, filename, mimeType;

        switch(format) {
            case 'json':
                dataStr = JSON.stringify(this.rawData, null, 2);
                filename = `autograph-data-${new Date().toISOString().slice(0,10)}.json`;
                mimeType = 'application/json';
                break;

            case 'csv':
                dataStr = this.convertToCSV();
                filename = `autograph-data-${new Date().toISOString().slice(0,10)}.csv`;
                mimeType = 'text/csv;charset=utf-8;';
                break;

            case 'excel':
                dataStr = this.convertToCSV();
                filename = `autograph-data-${new Date().toISOString().slice(0,10)}.csv`;
                mimeType = 'application/vnd.ms-excel';
                break;

            default:
                return;
        }

        const blob = new Blob([dataStr], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();

        this.showNotification(`–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ ${format.toUpperCase()}`, 'success');
    }

    convertToCSV() {
        if (!this.rawData || !this.currentVehicleId || !this.rawData.vehicles[this.currentVehicleId]) {
            return '';
        }

        const vehicleData = this.rawData.vehicles[this.currentVehicleId];
        if (!vehicleData.samples || vehicleData.samples.length === 0) {
            return '';
        }

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const allParams = new Set(['Time', 'Stage', 'Duration', 'Caption']);

        vehicleData.samples.forEach(item => {
            Object.keys(item.Values).forEach(param => {
                allParams.add(param);
            });
        });

        const paramsArray = Array.from(allParams);

        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ CSV
        let csv = paramsArray.join(';') + '\n';

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        vehicleData.samples.forEach(item => {
            const row = [];

            paramsArray.forEach(param => {
                let value = '';

                switch(param) {
                    case 'Time':
                        value = item.DT || '';
                        break;
                    case 'Stage':
                        value = item.Stage || '';
                        break;
                    case 'Duration':
                        value = item.Duration || '';
                        break;
                    case 'Caption':
                        value = item.Caption || '';
                        break;
                    default:
                        value = item.Values[param] || '';
                }

                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                if (value.toString().includes(';') || value.toString().includes('"') || value.toString().includes('\n')) {
                    value = '"' + value.toString().replace(/"/g, '""') + '"';
                }

                row.push(value);
            });

            csv += row.join(';') + '\n';
        });

        return csv;
    }

    // ============================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´
    // ============================================
    renderVehiclesList() {
        const container = document.getElementById('testVehiclesList');
        if (!container) return;

        if (this.filteredVehicles.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-car fa-2x text-muted mb-3"></i>
                    <p class="text-muted mb-0">–¢–° –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                </div>
            `;
            return;
        }

        let html = '';
        this.filteredVehicles.forEach(vehicle => {
            const isSelected = this.selectedVehicles.includes(vehicle.id);
            html += `
                <div class="vehicle-item ${isSelected ? 'selected' : ''}"
                     onclick="testDashboard.toggleVehicle('${vehicle.id}')">
                    <div class="vehicle-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-name">${vehicle.name}</div>
                        <div class="vehicle-plate">${vehicle.license_plate || '‚Äî'}</div>
                    </div>
                    <div class="vehicle-check">
                        <i class="fas fa-${isSelected ? 'check-circle' : 'circle'}"></i>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        this.updateVehicleCount();
        this.updateLoadButton();
    }

    searchVehicles(query) {
        if (!query) {
            this.filteredVehicles = [...this.vehicles];
        } else {
            const searchLower = query.toLowerCase();
            this.filteredVehicles = this.vehicles.filter(vehicle =>
                vehicle.name.toLowerCase().includes(searchLower) ||
                (vehicle.license_plate && vehicle.license_plate.toLowerCase().includes(searchLower))
            );
        }
        this.renderVehiclesList();
    }

    toggleVehicle(vehicleId) {
        const index = this.selectedVehicles.indexOf(vehicleId);
        if (index > -1) {
            this.selectedVehicles.splice(index, 1);
        } else {
            this.selectedVehicles.push(vehicleId);
        }
        this.renderVehiclesList();
    }

    selectAllVehicles() {
        this.selectedVehicles = this.filteredVehicles.map(v => v.id);
        this.renderVehiclesList();
        this.showNotification('–í—Å–µ –¢–° –≤—ã–±—Ä–∞–Ω—ã', 'success');
    }

    deselectAllVehicles() {
        this.selectedVehicles = [];
        this.renderVehiclesList();
        this.showNotification('–í—ã–±–æ—Ä –¢–° —Å–±—Ä–æ—à–µ–Ω', 'info');
    }

    setPeriod(days) {
        const toDate = new Date();
        const fromDate = new Date();
        fromDate.setDate(toDate.getDate() - days);

        document.getElementById('testDateFrom').value = fromDate.toISOString().split('T')[0];
        document.getElementById('testDateTo').value = toDate.toISOString().split('T')[0];
        this.updateLoadButton();
        this.updatePeriodDisplay();
    }

    updatePeriodDisplay() {
        const startDate = document.getElementById('testDateFrom').value;
        const endDate = document.getElementById('testDateTo').value;

        if (startDate && endDate) {
            const startFormatted = this.formatDate(startDate);
            const endFormatted = this.formatDate(endDate);
            document.getElementById('periodDisplay').textContent = `${startFormatted} - ${endFormatted}`;
        }
    }

    updateLoadButton() {
        const hasVehicles = this.selectedVehicles.length > 0;
        const hasDates = document.getElementById('testDateFrom').value &&
                         document.getElementById('testDateTo').value;
        const loadBtn = document.getElementById('testLoadDataBtn');

        if (loadBtn) {
            loadBtn.disabled = !hasVehicles || !hasDates;
        }
    }

    updateVehicleCount() {
        document.getElementById('testSelectedCount').textContent = this.selectedVehicles.length;
    }

    getParamValue(values, paramNames) {
        for (const paramName of paramNames) {
            if (values[paramName] !== undefined) {
                const value = values[paramName];
                const numValue = parseFloat(value);
                return !isNaN(numValue) ? this.formatNumber(numValue, 2) : value;
            }
        }
        return '‚Äî';
    }

    formatDateTime(dt) {
        if (!dt) return '‚Äî';

        if (dt.includes('T')) {
            const [date, time] = dt.split('T');
            return `${this.formatDate(date)} ${time.substring(0, 8)}`;
        }

        return dt;
    }

    formatDate(dateStr) {
        if (!dateStr) return '‚Äî';

        try {
            const [year, month, day] = dateStr.split('-');
            return `${day}.${month}.${year}`;
        } catch {
            return dateStr;
        }
    }

    formatTime(dt) {
        if (!dt) return '‚Äî';

        if (dt.includes('T')) {
            return dt.split('T')[1].substring(0, 8);
        } else if (dt.includes(' ')) {
            return dt.split(' ')[1].substring(0, 8);
        }

        return dt.substring(11, 19) || dt;
    }

    formatNumber(value, decimals = 0) {
        if (value === null || value === undefined || isNaN(value)) {
            return '0';
        }

        return value.toLocaleString('ru-RU', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    setupEventListeners() {
        document.getElementById('testDateFrom')?.addEventListener('change', () => {
            this.updateLoadButton();
            this.updatePeriodDisplay();
        });

        document.getElementById('testDateTo')?.addEventListener('change', () => {
            this.updateLoadButton();
            this.updatePeriodDisplay();
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                this.loadRawData();
            }
        });
    }

    setupTabs() {
        document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                this.switchTab(tabId);
            });
        });
    }

    switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
        const activeContent = document.getElementById(`${tabId}Tab`);

        if (activeBtn) activeBtn.classList.add('active');
        if (activeContent) activeContent.classList.add('active');

        if (this.chart) {
            setTimeout(() => {
                try {
                    this.chart.resize();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', e);
                }
            }, 100);
        }
    }

    // ============================================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ì–†–£–ó–ö–û–ô
    // ============================================
    showLoading(title, message) {
        const overlay = document.getElementById('testLoadingOverlay');
        if (overlay) {
            document.getElementById('testLoadingTitle').textContent = title;
            document.getElementById('testLoadingMessage').textContent = message;
            overlay.style.display = 'flex';
        }
    }

    hideLoading() {
        const overlay = document.getElementById('testLoadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    updateProgress(percent, message = '') {
        const progress = document.getElementById('testLoadingProgress');
        if (progress) {
            progress.style.width = percent + '%';
        }

        if (message) {
            document.getElementById('testLoadingMessage').textContent = message;
        }
    }

    showNotification(message, type = 'info') {
        const container = document.getElementById('testNotificationContainer');
        if (!container) return;

        const icon = {
            success: 'fa-check-circle',
            error: 'fa-times-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        }[type];

        const alertClass = {
            success: 'alert-success',
            error: 'alert-danger',
            warning: 'alert-warning',
            info: 'alert-info'
        }[type];

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show`;
        notification.innerHTML = `
            <i class="fas ${icon} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        container.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
const testDashboard = new TestDashboard();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    testDashboard.init();
});
</script>

<style>
/* ============================================
   –°–¢–ò–õ–ò –î–õ–Ø –¢–ï–°–¢–û–í–û–ô –ü–ê–ù–ï–õ–ò
   ============================================ */

.test-dashboard-container {
    padding-bottom: 2rem;
}

.test-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    border-bottom: 2px solid #FFD700;
    padding: 1.5rem 0;
    position: relative;
    overflow: hidden;
}

.test-header .header-icon-wrapper {
    position: relative;
}

.test-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #dc3545;
    color: white;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-weight: bold;
}

.info-warning {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
    border-color: #ffc107;
}

.info-warning .info-icon {
    color: #ffc107;
}

/* –í–∫–ª–∞–¥–∫–∏ */
.tabs-container {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    overflow: hidden;
}

.tabs-header {
    display: flex;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.5rem;
}

.tab-btn {
    background: transparent;
    border: none;
    color: #CCCCCC;
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
    margin: 0 0.25rem;
}

.tab-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #FFFFFF;
}

.tab-btn.active {
    background: rgba(255, 215, 0, 0.1);
    color: #FFD700;
    border-bottom: 2px solid #FFD700;
}

.tab-content {
    display: none;
    padding: 1.5rem;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö */
.table-responsive {
    border-radius: 8px;
    overflow: hidden;
}

.table-dark {
    background: transparent;
    margin-bottom: 0;
}

.table-dark th {
    background: rgba(255, 215, 0, 0.1);
    color: #FFD700;
    border-color: rgba(255, 255, 255, 0.1);
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
}

.table-dark td {
    border-color: rgba(255, 255, 255, 0.05);
    padding: 0.75rem 1rem;
    vertical-align: middle;
    font-size: 0.9rem;
}

.table-dark tbody tr:hover {
    background: rgba(255, 215, 0, 0.05);
}

/* –°–µ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ */
.params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
    padding: 0.5rem;
}

.param-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.param-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 215, 0, 0.3);
    transform: translateY(-2px);
}

.param-name {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
    color: #CCCCCC;
    word-break: break-all;
    flex: 1;
    margin-right: 0.75rem;
}

.param-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

/* –î–µ—Ç–∞–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ */
.params-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
}

.param-detail-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 0.75rem;
}

.param-detail-name {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.8rem;
    color: #888888;
    margin-bottom: 0.25rem;
    word-break: break-all;
}

.param-detail-value {
    font-size: 0.9rem;
    color: #FFFFFF;
    font-weight: 500;
}

.param-detail-value.numeric {
    color: #FFD700;
    font-family: 'Consolas', 'Monaco', monospace;
}

/* –ì—Ä–∞—Ñ–∏–∫ */
.chart-mini-container {
    height: 300px;
    position: relative;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1rem;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    color: #CCCCCC;
    font-size: 0.9rem;
}

.info-value {
    color: #FFD700;
    font-weight: 600;
    font-size: 1.1rem;
}

/* –ö–Ω–æ–ø–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.btn-gold {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    border: none;
    color: #000000;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-gold:hover {
    background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
    color: #000000;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

.btn-outline-gold {
    border: 2px solid #FFD700;
    color: #FFD700;
    background: transparent;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-outline-gold:hover {
    background: rgba(255, 215, 0, 0.1);
    color: #FFD700;
    transform: translateY(-2px);
}

.btn-dark-custom {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #CCCCCC;
    transition: all 0.3s ease;
}

.btn-dark-custom:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 215, 0, 0.3);
    color: #FFFFFF;
}

/* –°–ø–∏—Å–æ–∫ –¢–° */
.vehicles-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.vehicle-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.vehicle-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
}

.vehicle-item.selected {
    background: rgba(255, 215, 0, 0.1);
    border-color: rgba(255, 215, 0, 0.3);
}

.vehicle-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: rgba(255, 215, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    color: #FFD700;
}

.vehicle-info {
    flex: 1;
}

.vehicle-name {
    color: #FFFFFF;
    font-weight: 500;
    font-size: 0.95rem;
    margin-bottom: 0.1rem;
}

.vehicle-plate {
    color: #888888;
    font-size: 0.8rem;
}

.vehicle-check {
    color: rgba(255, 255, 255, 0.3);
    font-size: 1.1rem;
}

.vehicle-item.selected .vehicle-check {
    color: #FFD700;
}

/* –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
}

.loading-content {
    text-align: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 215, 0, 0.3);
    border-top: 4px solid #FFD700;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notification-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9998;
    max-width: 350px;
}

.notification-container .alert {
    margin-bottom: 0.5rem;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.control-panel {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    overflow: hidden;
}

.panel-header {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.panel-title {
    color: #FFD700;
    font-weight: 600;
    font-size: 1rem;
    margin: 0;
    display: flex;
    align-items: center;
}

.panel-title i {
    margin-right: 0.5rem;
}

.panel-body {
    padding: 1.5rem;
}

/* –§–æ—Ä–º—ã */
.form-control.bg-dark {
    background: rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(255, 255, 255, 0.2);
    color: #FFFFFF;
}

.form-control.bg-dark:focus {
    background: rgba(0, 0, 0, 0.5);
    border-color: #FFD700;
    color: #FFFFFF;
    box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
}

.form-label {
    color: #CCCCCC;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.card.bg-dark {
    background: rgba(255, 255, 255, 0.03) !important;
}

.card-header {
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .params-grid {
        grid-template-columns: 1fr;
    }

    .params-details-grid {
        grid-template-columns: 1fr;
    }

    .tabs-header {
        flex-wrap: wrap;
    }

    .tab-btn {
        flex: 1;
        min-width: 120px;
        margin: 0.25rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    .vehicle-name {
        font-size: 0.85rem;
    }

    .vehicle-plate {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}