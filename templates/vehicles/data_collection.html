<!-- vehicles/templates/vehicles/data_collection.html -->
{% extends 'base.html' %}

{% block page_title %}Сбор данных AutoGRAPH{% endblock %}

{% block extra_css %}
<style>
    .data-card {
        transition: all 0.3s;
        border-left: 4px solid #007bff;
    }
    .data-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .data-type-badge {
        font-size: 0.7rem;
    }
    .collection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .status-success { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .status-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
    .status-error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .data-preview {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-1">
                <i class="fas fa-database me-2"></i>Сбор данных AutoGRAPH
            </h1>
            <p class="text-muted">Комплексный сбор и управление всеми доступными данными из API</p>
        </div>
    </div>

    <!-- Статус сбора -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Статус сбора данных
                    </h5>
                </div>
                <div class="card-body">
                    <div id="collectionStatus">
                        <p class="text-muted">Загрузка статуса...</p>
                    </div>
                    <button class="btn btn-primary btn-sm mt-2" onclick="loadCollectionStatus()">
                        <i class="fas fa-sync-alt me-1"></i> Обновить статус
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление сбором -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-play me-2"></i>Запуск сбора данных
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Схема</label>
                        <select class="form-select" id="schemaSelect">
                            <option value="fad66447-fe18-4a2a-a7b9-945eab775fda">Osipenko</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Период (дней назад)</label>
                        <select class="form-select" id="daysBackSelect">
                            <option value="1">1 день</option>
                            <option value="7" selected>7 дней</option>
                            <option value="30">30 дней</option>
                            <option value="90">90 дней</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100" onclick="runComprehensiveCollection()">
                        <i class="fas fa-download me-1"></i> Запустить сбор всех данных
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Быстрый сбор
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Сбор конкретных типов данных</p>

                    <div class="mb-3">
                        <label class="form-label">Тип данных</label>
                        <select class="form-select" id="dataTypeSelect">
                            <option value="">Выберите тип данных...</option>
                            <option value="vehicles">Транспортные средства</option>
                            <option value="drivers">Водители</option>
                            <option value="geofences">Геозоны</option>
                            <option value="online_info">Онлайн информация</option>
                            <option value="track_data">Данные треков</option>
                        </select>
                    </div>

                    <button class="btn btn-outline-primary w-100" onclick="runSpecificCollection()">
                        <i class="fas fa-download me-1"></i> Собрать выбранные данные
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Просмотр данных -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-eye me-2"></i>Просмотр собранных данных
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportAllData()">
                            <i class="fas fa-file-export me-1"></i> Экспорт всех данных
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllData()">
                            <i class="fas fa-trash me-1"></i> Очистить данные
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="dataPreview">
                        <p class="text-muted">Данные не собраны. Запустите сбор данных для просмотра.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="text-center text-white">
        <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="mb-0">Сбор данных...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Функции для работы со сбором данных
function loadCollectionStatus() {
    fetch('/vehicles/api/data/status/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCollectionStatus(data.status);
            } else {
                showNotification('Ошибка загрузки статуса', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
            showNotification('Ошибка загрузки статуса', 'error');
        });
}

function displayCollectionStatus(status) {
    const container = document.getElementById('collectionStatus');

    if (status.status === 'no_data') {
        container.innerHTML = `
            <div class="status-warning collection-status">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Данные не собраны</strong>
                <p class="mb-0 mt-1">Запустите сбор данных для начала работы.</p>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="status-success collection-status">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Данные собраны</strong>
                <p class="mb-0 mt-1">
                    Типов данных: ${status.total_data_types}<br>
                    История сборов: ${status.collection_history?.length || 0}
                </p>
            </div>
            <div class="mt-3">
                <h6>Собранные типы данных:</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${status.data_types?.map(type =>
                        `<span class="badge bg-primary">${type}</span>`
                    ).join('') || 'Нет данных'}
                </div>
            </div>
        `;
    }
}

function runComprehensiveCollection() {
    const schemaId = document.getElementById('schemaSelect').value;
    const daysBack = document.getElementById('daysBackSelect').value;

    showLoadingOverlay();

    fetch(`/vehicles/api/data/comprehensive/?schema_id=${schemaId}&days_back=${daysBack}`)
        .then(response => response.json())
        .then(data => {
            hideLoadingOverlay();
            if (data.success) {
                showNotification(`Собрано ${data.summary.total_data_types} типов данных`, 'success');
                loadCollectionStatus();
                loadDataPreview();
            } else {
                showNotification('Ошибка сбора данных: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoadingOverlay();
            console.error('Collection error:', error);
            showNotification('Ошибка сбора данных', 'error');
        });
}

function runSpecificCollection() {
    const dataType = document.getElementById('dataTypeSelect').value;
    if (!dataType) {
        showNotification('Выберите тип данных', 'warning');
        return;
    }

    showLoadingOverlay();

    fetch(`/vehicles/api/data/specific/?data_type=${dataType}`)
        .then(response => response.json())
        .then(data => {
            hideLoadingOverlay();
            if (data.success) {
                showNotification(`Данные типа "${dataType}" собраны`, 'success');
                loadDataPreview(dataType);
            } else {
                showNotification('Ошибка сбора данных: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoadingOverlay();
            console.error('Specific collection error:', error);
            showNotification('Ошибка сбора данных', 'error');
        });
}

function loadDataPreview(dataType = null) {
    const url = dataType ? `/vehicles/api/data/export/?data_type=${dataType}` : '/vehicles/api/data/export/';

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDataPreview(data);
            } else {
                document.getElementById('dataPreview').innerHTML =
                    '<p class="text-muted">Ошибка загрузки данных</p>';
            }
        })
        .catch(error => {
            console.error('Preview load error:', error);
            document.getElementById('dataPreview').innerHTML =
                '<p class="text-muted">Ошибка загрузки данных</p>';
        });
}

function displayDataPreview(data) {
    const container = document.getElementById('dataPreview');
    const dataType = data.data_type;
    const dataContent = data.data;

    let previewContent = '';

    if (dataType === 'all') {
        previewContent = `
            <h6>Все собранные данные (${Object.keys(dataContent).length} типов):</h6>
            ${Object.entries(dataContent).map(([key, value]) => `
                <div class="mb-3">
                    <strong>${key}:</strong>
                    <div class="data-preview">
                        ${JSON.stringify(value, null, 2).substring(0, 500)}...
                    </div>
                </div>
            `).join('')}
        `;
    } else {
        previewContent = `
            <h6>Данные типа: ${dataType}</h6>
            <div class="data-preview">
                ${JSON.stringify(dataContent, null, 2)}
            </div>
        `;
    }

    container.innerHTML = previewContent;
}

function exportAllData() {
    // Реализация экспорта всех данных
    showNotification('Экспорт данных запущен', 'info');
}

function clearAllData() {
    if (confirm('Вы уверены, что хотите очистить все собранные данные?')) {
        // Реализация очистки данных
        showNotification('Данные очищены', 'info');
        loadCollectionStatus();
        document.getElementById('dataPreview').innerHTML =
            '<p class="text-muted">Данные не собраны. Запустите сбор данных для просмотра.</p>';
    }
}

function showLoadingOverlay() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadCollectionStatus();
});
</script>
{% endblock %}