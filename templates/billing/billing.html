{% extends 'base.html' %}

{% block page_title %}–ó–∞–∫–∞–∑ —Å—á–µ—Ç–∞{% endblock %}

{% block extra_css %}
<style>
    .order-card {
        transition: transform 0.2s;
        border-left: 4px solid #007bff;
        height: 100%;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .feature-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .coming-soon-badge {
        background: linear-gradient(45deg, #FF6B6B, #FFA500);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .contact-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-file-invoice-dollar me-2"></i>–ó–∞–∫–∞–∑ —Å—á–µ—Ç–∞
                    </h1>
                    <p class="text-muted mb-0">–ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü –∏ –ò–ü</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark me-3">
                        <i class="fas fa-clock me-1"></i>
                        <span id="currentTime">{{ current_time|date:"H:i:s" }}</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card order-card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å—á–µ—Ç–∞
                    </h5>
                </div>
                <div class="card-body">
                    <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
                    <form id="invoiceForm">
                        <div class="row g-3">
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
                            <div class="col-12">
                                <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ *</label>
                                <input type="text" class="form-control" id="orgName"
                                       placeholder="–û–û–û '–ü—Ä–∏–º–µ—Ä'" required>
                            </div>

                            <!-- –ò–ù–ù -->
                            <div class="col-12">
                                <label class="form-label fw-bold">–ò–ù–ù *</label>
                                <input type="text" class="form-control" id="orgInn"
                                       placeholder="1234567890" required>
                                <div class="form-text">10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä</div>
                            </div>

                            <!-- Email –¥–ª—è —Å—á–µ—Ç–∞ -->
                            <div class="col-12">
                                <label class="form-label fw-bold">Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—á–µ—Ç–∞ *</label>
                                <input type="email" class="form-control" id="contactEmail"
                                       placeholder="buh@example.com" required>
                                <div class="form-text">–ù–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å—á–µ—Ç</div>
                            </div>

                            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                            <div class="col-12">
                                <label class="form-label fw-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                <textarea class="form-control" id="orderComment" rows="3"
                                          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è..."></textarea>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-3" id="submitOrderBtn">
                                    <i class="fas fa-paper-plane me-1"></i> –ó–∞–∫–∞–∑–∞—Ç—å —Å—á–µ—Ç
                                </button>

                                <button type="button" class="btn btn-outline-secondary" disabled
                                        title="–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ">
                                    <i class="fas fa-credit-card me-1"></i> –û–ø–ª–∞—Ç–∏—Ç—å –æ–Ω–ª–∞–π–Ω
                                    <span class="coming-soon-badge ms-2">–°–ö–û–†–û</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-4">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    </h5>
                </div>
                <div class="card-body">
                    <div class="feature-card">
                        <h6><i class="fas fa-bolt me-2"></i>–ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h6>
                        <p class="small mb-0">–°—á–µ—Ç –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</p>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="fas fa-rocket me-2"></i>–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ</h6>
                        <p class="small mb-0">–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π</p>
                    </div>

                    <div class="contact-info">
                        <h6><i class="fas fa-headset me-2"></i>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</h6>
                        <p class="small mb-1">–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤:</p>
                        <p class="mb-1">
                            <i class="fas fa-envelope me-2"></i>
                            <a href="mailto:support@example.com">support@example.com</a>
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-phone me-2"></i>
                            <a href="tel:+78001234567">8 (800) 123-45-67</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—Ö–∞ -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h5 class="mb-3">–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</h5>
                <p class="text-muted">
                    –°—á–µ—Ç –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è.
                </p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-home me-1"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="createNewOrder()">
                    <i class="fas fa-plus me-1"></i> –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–∞
const orderState = {
    organization: {
        name: '',
        inn: ''
    },
    contact: {
        email: ''
    },
    comment: ''
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–∫–∞–∑–∞ —Å—á–µ—Ç–∞');
    updateCurrentTime();
    setupEventListeners();
});

function setupEventListeners() {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    setInterval(updateCurrentTime, 1000);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitOrder();
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù
    document.getElementById('orgInn').addEventListener('blur', validateInn);
}

function validateInn() {
    const inn = document.getElementById('orgInn').value.trim();
    if (inn && !/^\d{10}$|^\d{12}$/.test(inn)) {
        showNotification('–ò–ù–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä', 'error');
        return false;
    }
    return true;
}

async function submitOrder() {
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    orderState.organization.name = document.getElementById('orgName').value.trim();
    orderState.organization.inn = document.getElementById('orgInn').value.trim();
    orderState.contact.email = document.getElementById('contactEmail').value.trim();
    orderState.comment = document.getElementById('orderComment').value.trim();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!orderState.organization.name || !orderState.organization.inn || !orderState.contact.email) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }

    if (!validateInn()) {
        return;
    }

    try {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = document.getElementById('submitOrderBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
        submitBtn.disabled = true;

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/api/order-invoice/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                organization: orderState.organization,
                contact: orderState.contact,
                comment: orderState.comment
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—Ö–∞
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        const submitBtn = document.getElementById('submitOrderBtn');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function createNewOrder() {
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    document.getElementById('invoiceForm').reset();

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    orderState.organization.name = '';
    orderState.organization.inn = '';
    orderState.contact.email = '';
    orderState.comment = '';

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
    modal.hide();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent =
        now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' :
                      type === 'success' ? 'alert-success' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px;';
    alert.innerHTML = `
        <strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>
{% endblock %}