{% extends 'base.html' %}

{% block page_title %}–û—Ç—á–µ—Ç—ã - AutoGRAPH{% endblock %}

{% block extra_css %}
<style>
    .reports-container {
        min-height: calc(100vh - 200px);
    }

    .vehicle-checkbox {
        transform: scale(1.2);
        margin-right: 10px;
    }

    .report-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 100%;
        cursor: pointer;
    }

    .report-card:hover {
        border-color: #007bff;
        transform: translateY(-2px);
    }

    .report-card.selected {
        border-color: #007bff;
        background-color: #f8f9fa;
    }

    .report-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #007bff;
    }

    .table-container {
        max-height: 70vh;
        overflow: auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .export-buttons {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .vehicle-list-item {
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }

    .vehicle-list-item.selected {
        border-left-color: #007bff;
        background-color: #e3f2fd;
    }

    .report-params {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
    }

    .vehicles-sidebar {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .vehicle-checkbox-item {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .vehicle-checkbox-item:last-child {
        border-bottom: none;
    }

    .vehicle-checkbox-item:hover {
        background-color: #f8f9fa;
    }

    .datetime-inputs {
        display: flex;
        gap: 10px;
        align-items: end;
    }

    .datetime-inputs .form-group {
        flex: 1;
    }

    .full-width-table {
        margin-left: -15px;
        margin-right: -15px;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .compact-params {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .reports-sidebar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 reports-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-line me-2"></i>–û—Ç—á–µ—Ç—ã AutoGRAPH
                    </h1>
                    <p class="text-muted mb-0">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark me-3">
                        <i class="fas fa-clock me-1"></i>
                        <span id="updateTime">{{ current_time|date:"H:i:s" }}</span>
                    </span>
                    <button class="btn btn-outline-primary" onclick="loadVehicles()" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ - –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
    <div class="row mb-4">
        <!-- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ -->
        <div class="col-md-6">
            <div class="vehicles-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-truck me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAllVehicles()">
                            –í—Å–µ
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllVehicles()">
                            –ù–∏—á–µ–≥–æ
                        </button>
                    </div>
                </div>

                <!-- –ü–æ–∏—Å–∫ -->
                <div class="mb-3">
                    <input type="text" class="form-control form-control-sm" id="searchVehicles"
                           placeholder="–ü–æ–∏—Å–∫ –¢–°...">
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –¢–° -->
                <div class="vehicles-list" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="10%"></th>
                                <th width="60%">–¢–°</th>
                                <th width="30%">–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesList">
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                    <p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞ -->
        <div class="col-md-6">
            <div class="vehicles-sidebar">
                <h5 class="card-title mb-3">
                    <i class="fas fa-sliders-h me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞
                </h5>

                <div class="row g-3">
                    <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <div class="datetime-inputs">
                            <div class="form-group">
                                <input type="date" class="form-control form-control-sm" id="dateFrom" value="{{ default_start_date }}">
                            </div>
                            <div class="form-group">
                                <input type="time" class="form-control form-control-sm" id="timeFrom" value="00:00">
                            </div>
                        </div>
                    </div>

                    <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <div class="datetime-inputs">
                            <div class="form-group">
                                <input type="date" class="form-control form-control-sm" id="dateTo" value="{{ default_end_date }}">
                            </div>
                            <div class="form-group">
                                <input type="time" class="form-control form-control-sm" id="timeTo" value="23:59">
                            </div>
                        </div>
                    </div>

                    <!-- –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–∏–æ–¥ -->
                    <div class="col-12">
                        <label class="form-label small fw-bold">–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–∏–æ–¥:</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(1)">–î–µ–Ω—å</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(7)">–ù–µ–¥–µ–ª—è</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(30)">–ú–µ—Å—è—Ü</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickPeriod(90)">–ö–≤–∞—Ä—Ç–∞–ª</button>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div class="col-12">
                        <button class="btn btn-primary w-100" onclick="generateReport()" id="generateReportBtn">
                            <i class="fas fa-play me-1"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="reports-sidebar">
                <h5 class="card-title mb-3">
                    <i class="fas fa-file-alt me-2"></i>–¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤
                </h5>
                <div class="reports-grid" id="reportsGrid">
                    <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="row mb-3">
        <div class="col-12">
            <div id="reportStatus" style="display: none;">
                <div class="alert alert-info d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <div class="flex-grow-1">
                        <strong>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</strong>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="summaryStats" style="display: none;">
                <div class="vehicles-sidebar">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-pie me-2"></i>–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        <small class="text-muted ms-2" id="reportInfo"></small>
                    </h5>
                    <div class="stats-grid" id="statsGrid">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á–µ—Ç–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
    <div class="row">
        <div class="col-12">
            <div id="reportResults" style="display: none;">
                <div class="vehicles-sidebar">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á–µ—Ç–∞
                        </h5>
                        <div class="export-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-1"></i> Excel
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()">
                                <i class="fas fa-file-csv me-1"></i> CSV
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="printReport()">
                                <i class="fas fa-print me-1"></i> –ü–µ—á–∞—Ç—å
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table table-striped table-bordered table-hover" id="reportTable">
                            <thead class="table-light sticky-top">
                                <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                            <tfoot id="reportTableFooter" class="table-secondary">
                                <!-- –ò—Ç–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö -->
            <div id="noDataMessage" class="vehicles-sidebar" style="display: block;">
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                    <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞, —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <p class="mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ - –ü–û–õ–ù–´–ô –ù–ê–ë–û–† –ò–ó 10 –û–¢–ß–ï–¢–û–í
const reportsConfig = {
    'movement': {
        name: '–î–≤–∏–∂–µ–Ω–∏–µ',
        icon: 'road',
        description: '–ê–Ω–∞–ª–∏–∑ –¥–≤–∏–∂–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–ì—Ä—É–ø–ø–∞', '–î–∞—Ç–∞', '–ü—Ä–æ–±–µ–≥, –∫–º', '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á', '–í—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è']
    },
    'journal': {
        name: '–ñ—É—Ä–Ω–∞–ª',
        icon: 'book',
        description: '–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –∏ –æ–ø–µ—Ä–∞—Ü–∏–π',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–î–∞—Ç–∞/–≤—Ä–µ–º—è', '–°–æ–±—ã—Ç–∏–µ', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã', '–°—Ç–∞—Ç—É—Å']
    },
    'refueling': {
        name: '–ó–∞–ø—Ä–∞–≤–∫–∏ –∏ —Å–ª–∏–≤—ã',
        icon: 'gas-pump',
        description: '–£—á–µ—Ç —Ç–æ–ø–ª–∏–≤–∞: –∑–∞–ø—Ä–∞–≤–∫–∏ –∏ —Ä–∞—Å—Ö–æ–¥',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–î–∞—Ç–∞', '–ù–∞—á–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º, –ª', '–ö–æ–Ω–µ—á–Ω—ã–π –æ–±—ä–µ–º, –ª', '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥, –ª', '–û–±—ä–µ–º –∑–∞–ø—Ä–∞–≤–æ–∫, –ª', '–û–±—ä–µ–º —Å–ª–∏–≤–æ–≤, –ª', '–†–∞—Å—Ö–æ–¥ –Ω–∞ 100 –∫–º, –ª']
    },
    'violations': {
        name: '–ù–∞—Ä—É—à–µ–Ω–∏—è',
        icon: 'exclamation-triangle',
        description: '–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–î–∞—Ç–∞/–≤—Ä–µ–º—è', '–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è', '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å']
    },
    'shift': {
        name: '–ü–æ—Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç',
        icon: 'users',
        description: '–†–∞–±–æ—Ç–∞ –ø–æ —Å–º–µ–Ω–∞–º',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–°–º–µ–Ω–∞', '–î–∞—Ç–∞', '–í–æ–¥–∏—Ç–µ–ª—å', '–ü—Ä–æ–±–µ–≥, –∫–º', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã', '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª']
    },
    'group': {
        name: '–†–∞–±–æ—Ç–∞ –≥—Ä—É–ø–ø—ã',
        icon: 'layer-group',
        description: '–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã –¢–°',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–ì—Ä—É–ø–ø–∞', '–ü—Ä–æ–±–µ–≥, –∫–º', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã', '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª', '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å']
    },
    'summary': {
        name: '–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç',
        icon: 'chart-bar',
        description: '–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–ü—Ä–æ–±–µ–≥, –∫–º', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã', '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª', '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π']
    },
    'events': {
        name: '–°–æ–±—ã—Ç–∏—è',
        icon: 'calendar-alt',
        description: '–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–î–∞—Ç–∞/–≤—Ä–µ–º—è', '–¢–∏–ø —Å–æ–±—ã—Ç–∏—è', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å']
    },
    'statistics': {
        name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
        icon: 'chart-line',
        description: '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–ü–µ—Ä–∏–æ–¥', '–ü—Ä–æ–±–µ–≥, –∫–º', '–í—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è', '–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è', '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª', '–ö–ü–î']
    },
    'parking': {
        name: '–°—Ç–æ—è–Ω–∫–∏',
        icon: 'parking',
        description: '–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Å—Ç —Å—Ç–æ—è–Ω–æ–∫',
        columns: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°', '–ù–∞—á–∞–ª–æ —Å—Ç–æ—è–Ω–∫–∏', '–ö–æ–Ω–µ—Ü —Å—Ç–æ—è–Ω–∫–∏', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–ü—Ä–∏—á–∏–Ω–∞']
    }
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const appState = {
    vehicles: [],
    selectedVehicles: [],
    selectedReport: null,
    currentPeriod: {
        start: '{{ default_start_date }}',
        end: '{{ default_end_date }}'
    },
    reportData: null
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function initializePage() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á–µ—Ç–æ–≤');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateTo').max = today;
    document.getElementById('dateFrom').max = today;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    const now = new Date();
    document.getElementById('timeTo').value = now.toTimeString().slice(0, 5);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadVehicles();
    renderReportsGrid();
    setupEventListeners();
    updateCurrentTime();
}

function setupEventListeners() {
    // –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
    document.getElementById('searchVehicles')?.addEventListener('input', function(e) {
        filterVehicles(e.target.value);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
async function loadVehicles() {
    try {
        showGlobalLoading(true);

        const response = await fetch('/vehicles/api/vehicles/page-list/');
        const data = await response.json();

        if (data.success) {
            appState.vehicles = data.data.vehicles;
            renderVehiclesList();
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${appState.vehicles.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤`);
        } else {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:', error);
        renderVehiclesList();
    } finally {
        showGlobalLoading(false);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
function renderVehiclesList() {
    const tbody = document.getElementById('vehiclesList');

    if (!appState.vehicles || appState.vehicles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4 text-muted">
                    <i class="fas fa-exclamation-circle me-2"></i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    appState.vehicles.forEach(vehicle => {
        const isSelected = appState.selectedVehicles.includes(vehicle.id);
        html += `
            <tr class="vehicle-checkbox-item ${isSelected ? 'selected' : ''}">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input vehicle-checkbox"
                           value="${vehicle.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleVehicleSelection('${vehicle.id}', this.checked)">
                </td>
                <td>
                    <div class="fw-bold small">${vehicle.name}</div>
                    <small class="text-muted">ID: ${vehicle.id}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${vehicle.license_plate || '‚Äî'}</span>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ - –¢–ï–ü–ï–†–¨ –ü–û–ö–ê–ó–´–í–ê–ï–¢ –í–°–ï 10 –û–¢–ß–ï–¢–û–í
function renderReportsGrid() {
    const grid = document.getElementById('reportsGrid');
    let html = '';

    Object.entries(reportsConfig).forEach(([key, report]) => {
        const isSelected = appState.selectedReport === key;
        html += `
            <div class="card report-card ${isSelected ? 'selected' : ''}"
                 onclick="selectReport('${key}')">
                <div class="card-body text-center p-3">
                    <div class="report-icon">
                        <i class="fas fa-${report.icon}"></i>
                    </div>
                    <h6 class="card-title mb-1">${report.name}</h6>
                    <p class="card-text text-muted small mb-0">${report.description}</p>
                </div>
            </div>
        `;
    });

    grid.innerHTML = html;
}

// –í—ã–±–æ—Ä/—Å–Ω—è—Ç–∏–µ –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞
function toggleVehicleSelection(vehicleId, isSelected) {
    if (isSelected) {
        if (!appState.selectedVehicles.includes(vehicleId)) {
            appState.selectedVehicles.push(vehicleId);
        }
    } else {
        appState.selectedVehicles = appState.selectedVehicles.filter(id => id !== vehicleId);
    }
    renderVehiclesList();
    console.log(`–í—ã–±—Ä–∞–Ω–æ –¢–°: ${appState.selectedVehicles.length}`);
}

// –í—ã–±–æ—Ä –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
function selectAllVehicles() {
    appState.selectedVehicles = appState.vehicles.map(v => v.id);
    document.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    console.log(`–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ –¢–°: ${appState.selectedVehicles.length}`);
}

// –°–Ω—è—Ç–∏–µ –≤—ã–±–æ—Ä–∞ —Å–æ –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
function deselectAllVehicles() {
    appState.selectedVehicles = [];
    document.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    console.log('–°–Ω—è—Ç—ã –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ —Å –¢–°');
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –¢–°
function filterVehicles(searchTerm) {
    const filtered = appState.vehicles.filter(vehicle =>
        vehicle.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (vehicle.license_plate && vehicle.license_plate.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (vehicle.serial && vehicle.serial.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    renderFilteredVehicles(filtered);
}

function renderFilteredVehicles(vehicles) {
    const tbody = document.getElementById('vehiclesList');

    if (!vehicles || vehicles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4 text-muted">
                    <i class="fas fa-search me-2"></i>–¢–° –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    vehicles.forEach(vehicle => {
        const isSelected = appState.selectedVehicles.includes(vehicle.id);
        html += `
            <tr class="vehicle-checkbox-item ${isSelected ? 'selected' : ''}">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input vehicle-checkbox"
                           value="${vehicle.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleVehicleSelection('${vehicle.id}', this.checked)">
                </td>
                <td>
                    <div class="fw-bold small">${vehicle.name}</div>
                    <small class="text-muted">ID: ${vehicle.id}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${vehicle.license_plate || '‚Äî'}</span>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// –í—ã–±–æ—Ä –æ—Ç—á–µ—Ç–∞
function selectReport(reportKey) {
    appState.selectedReport = reportKey;
    renderReportsGrid();
    console.log(`–í—ã–±—Ä–∞–Ω –æ—Ç—á–µ—Ç: ${reportsConfig[reportKey].name}`);
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
function setQuickPeriod(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    document.getElementById('dateFrom').value = start.toISOString().split('T')[0];
    document.getElementById('dateTo').value = end.toISOString().split('T')[0];
    document.getElementById('timeFrom').value = '00:00';
    document.getElementById('timeTo').value = '23:59';

    console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–∏–æ–¥: ${days} –¥–Ω–µ–π`);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –†–ï–ê–õ–¨–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò
async function generateReport() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –¢–°
    if (appState.selectedVehicles.length === 0) {
        alert('‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¢–°');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞
    if (!appState.selectedReport) {
        alert('‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø –æ—Ç—á–µ—Ç–∞');
        return;
    }

    const startDate = document.getElementById('dateFrom').value;
    const endDate = document.getElementById('dateTo').value;
    const startTime = document.getElementById('timeFrom').value;
    const endTime = document.getElementById('timeTo').value;

    if (!startDate || !endDate) {
        alert('‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞');
        return;
    }

    try {
        showReportStatus(true);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
        const reportData = await generateRealReportData(
            appState.selectedReport,
            appState.selectedVehicles,
            startDate,
            endDate
        );

        appState.reportData = reportData;
        displayReportResults(reportData, startDate, endDate);

        console.log(`‚úÖ –û—Ç—á–µ—Ç "${reportsConfig[appState.selectedReport].name}" —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω`);

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: ' + error.message);
    } finally {
        showReportStatus(false);
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞
async function generateRealReportData(reportType, vehicleIds, startDate, endDate) {
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–°
    const reportPromises = vehicleIds.map(vehicleId =>
        getVehicleHistoricalData(vehicleId, startDate, endDate)
    );

    const vehiclesData = await Promise.all(reportPromises);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
    return formatReportData(reportType, vehiclesData);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¢–°
async function getVehicleHistoricalData(vehicleId, startDate, endDate) {
    try {
        const response = await fetch(`/vehicles/api/vehicles/statistics/?vehicle_id=${vehicleId}&start_date=${startDate}&end_date=${endDate}`);
        const data = await response.json();

        if (data.success) {
            return {
                vehicleId: vehicleId,
                vehicleName: appState.vehicles.find(v => v.id === vehicleId)?.name || 'Unknown',
                licensePlate: appState.vehicles.find(v => v.id === vehicleId)?.license_plate || 'Unknown',
                data: data.data
            };
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        }
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¢–° ${vehicleId}:`, error);
        return {
            vehicleId: vehicleId,
            vehicleName: appState.vehicles.find(v => v.id === vehicleId)?.name || 'Unknown',
            licensePlate: appState.vehicles.find(v => v.id === vehicleId)?.license_plate || 'Unknown',
            data: null,
            error: error.message
        };
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤
function formatReportData(reportType, vehiclesData) {
    const validData = vehiclesData.filter(item => item.data && !item.error);

    switch (reportType) {
        case 'movement':
            return formatMovementReport(validData);
        case 'refueling':
            return formatRefuelingReport(validData);
        case 'violations':
            return formatViolationsReport(validData);
        case 'summary':
            return formatSummaryReport(validData);
        case 'journal':
            return formatJournalReport(validData);
        case 'shift':
            return formatShiftReport(validData);
        case 'group':
            return formatGroupReport(validData);
        case 'events':
            return formatEventsReport(validData);
        case 'statistics':
            return formatStatisticsReport(validData);
        case 'parking':
            return formatParkingReport(validData);
        default:
            return formatSummaryReport(validData);
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é
function formatMovementReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            group: '-',
            date: new Date().toLocaleDateString('ru-RU'),
            distance: summary.total_distance || 0,
            avgSpeed: summary.average_speed || 0,
            maxSpeed: summary.max_speed || 0,
            moveTime: summary.total_move_duration || '00:00:00',
            engineTime: summary.total_engine_hours || '00:00:00'
        };
    });

    const summary = {
        totalVehicles: details.length,
        totalDistance: details.reduce((sum, item) => sum + (item.distance || 0), 0),
        avgSpeed: details.reduce((sum, item) => sum + (item.avgSpeed || 0), 0) / details.length,
        totalEngineHours: '00:00:00'
    };

    return { details, summary };
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–∞–≤–∫–∞–º
function formatRefuelingReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        const fuel = item.data?.fuel_analytics || {};
        return {
            vehicleName: item.vehicleName,
            date: new Date().toLocaleDateString('ru-RU'),
            startVolume: 0,
            endVolume: fuel.current_level || 0,
            actualConsumption: summary.total_fuel_consumption || 0,
            refillVolume: fuel.refills_volume || 0,
            drainVolume: 0,
            consumptionPer100km: summary.fuel_efficiency || 0
        };
    });

    const summary = {
        totalVehicles: details.length,
        totalFuelConsumption: details.reduce((sum, item) => sum + (item.actualConsumption || 0), 0),
        totalRefills: details.reduce((sum, item) => sum + (item.refillVolume || 0), 0),
        avgEfficiency: details.reduce((sum, item) => sum + (item.consumptionPer100km || 0), 0) / details.length
    };

    return { details, summary };
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º
function formatViolationsReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        const violations = item.data?.violations || {};
        return {
            vehicleName: item.vehicleName,
            datetime: new Date().toLocaleString('ru-RU'),
            violationType: '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏',
            parameters: `–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å: ${summary.max_speed || 0} –∫–º/—á`,
            location: item.data?.location?.address || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
            duration: violations.overspeed_duration || '00:00:00'
        };
    });

    const summary = {
        totalVehicles: details.length,
        totalViolations: details.reduce((sum, item) => sum + (summary.overspeed_count || 0), 0),
        totalPenaltyPoints: details.reduce((sum, item) => sum + (violations.penalty_points || 0), 0)
    };

    return { details, summary };
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
function formatSummaryReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            distance: summary.total_distance || 0,
            workTime: summary.total_engine_hours || '00:00:00',
            fuelConsumption: summary.total_fuel_consumption || 0,
            avgSpeed: summary.average_speed || 0,
            violationsCount: summary.overspeed_count || 0
        };
    });

    const summary = {
        totalVehicles: details.length,
        totalDistance: details.reduce((sum, item) => sum + (item.distance || 0), 0),
        totalFuelConsumption: details.reduce((sum, item) => sum + (item.fuelConsumption || 0), 0),
        totalViolations: details.reduce((sum, item) => sum + (item.violationsCount || 0), 0),
        avgSpeed: details.reduce((sum, item) => sum + (item.avgSpeed || 0), 0) / details.length
    };

    return { details, summary };
}

// –î—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç–µ—Ä—ã –æ—Ç—á–µ—Ç–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏)
function formatJournalReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        return {
            vehicleName: item.vehicleName,
            datetime: new Date().toLocaleString('ru-RU'),
            event: '–î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è',
            location: item.data?.location?.address || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
            parameters: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–±—ã—Ç–∏—è',
            status: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalEvents: details.length
        }
    };
}

function formatShiftReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            shift: '–°–º–µ–Ω–∞ 1',
            date: new Date().toLocaleDateString('ru-RU'),
            driver: '–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω',
            distance: summary.total_distance || 0,
            workTime: summary.total_engine_hours || '00:00:00',
            fuelConsumption: summary.total_fuel_consumption || 0
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalDistance: details.reduce((sum, item) => sum + (item.distance || 0), 0)
        }
    };
}

function formatGroupReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            group: '–û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞',
            distance: summary.total_distance || 0,
            workTime: summary.total_engine_hours || '00:00:00',
            fuelConsumption: summary.total_fuel_consumption || 0,
            efficiency: summary.fuel_efficiency || 0
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalDistance: details.reduce((sum, item) => sum + (item.distance || 0), 0)
        }
    };
}

function formatEventsReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        return {
            vehicleName: item.vehicleName,
            datetime: new Date().toLocaleString('ru-RU'),
            eventType: '–†–∞–±–æ—Ç–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è',
            description: '–ó–∞–ø—É—Å–∫ –¥–≤–∏–≥–∞—Ç–µ–ª—è',
            location: item.data?.location?.address || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
            duration: '01:30:00'
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalEvents: details.length
        }
    };
}

function formatStatisticsReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            period: '–î–µ–Ω—å',
            distance: summary.total_distance || 0,
            moveTime: summary.total_move_duration || '00:00:00',
            idleTime: summary.total_park_duration || '00:00:00',
            fuelConsumption: summary.total_fuel_consumption || 0,
            efficiency: summary.fuel_efficiency || 0
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalDistance: details.reduce((sum, item) => sum + (item.distance || 0), 0)
        }
    };
}

function formatParkingReport(vehiclesData) {
    const details = vehiclesData.map(item => {
        const summary = item.data?.summary || {};
        return {
            vehicleName: item.vehicleName,
            parkingStart: new Date().toLocaleString('ru-RU'),
            parkingEnd: new Date(Date.now() + 2 * 60 * 60 * 1000).toLocaleString('ru-RU'),
            duration: '02:00:00',
            location: item.data?.location?.address || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
            reason: '–ü–ª–∞–Ω–æ–≤—ã–π –ø–µ—Ä–µ—Ä—ã–≤'
        };
    });

    return {
        details,
        summary: {
            totalVehicles: vehiclesData.length,
            totalParkings: details.length
        }
    };
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
function showReportStatus(show) {
    document.getElementById('reportStatus').style.display = show ? 'block' : 'none';
    document.getElementById('generateReportBtn').disabled = show;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç—á–µ—Ç–∞
function displayReportResults(reportData, startDate, endDate) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    document.getElementById('summaryStats').style.display = 'block';
    document.getElementById('reportResults').style.display = 'block';
    document.getElementById('noDataMessage').style.display = 'none';

    const report = reportsConfig[appState.selectedReport];

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç—á–µ—Ç–µ
    document.getElementById('reportInfo').textContent =
        `${report.name} | ${startDate} - ${endDate} | –¢–°: ${reportData.details.length}`;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateSummaryStats(reportData.summary);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    updateReportTable(report, reportData.details);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateSummaryStats(summary) {
    const grid = document.getElementById('statsGrid');
    let html = '';

    Object.entries(summary).forEach(([key, value]) => {
        let label = '';
        let formattedValue = value;

        switch(key) {
            case 'totalVehicles':
                label = '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤';
                break;
            case 'totalDistance':
                label = '–û–±—â–∏–π –ø—Ä–æ–±–µ–≥, –∫–º';
                formattedValue = value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                break;
            case 'totalFuelConsumption':
                label = '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª';
                formattedValue = value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                break;
            case 'avgSpeed':
                label = '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á';
                formattedValue = value.toFixed(1);
                break;
            case 'totalViolations':
                label = '–ù–∞—Ä—É—à–µ–Ω–∏–π';
                break;
            case 'totalPenaltyPoints':
                label = '–®—Ç—Ä–∞—Ñ–Ω—ã—Ö –±–∞–ª–ª–æ–≤';
                formattedValue = value.toFixed(1);
                break;
            case 'totalRefills':
                label = '–ó–∞–ø—Ä–∞–≤–æ–∫';
                formattedValue = value.toFixed(1);
                break;
            case 'avgEfficiency':
                label = '–†–∞—Å—Ö–æ–¥ –Ω–∞ 100 –∫–º, –ª';
                formattedValue = value.toFixed(1);
                break;
            case 'totalEvents':
                label = '–°–æ–±—ã—Ç–∏–π';
                break;
            case 'totalParkings':
                label = '–°—Ç–æ—è–Ω–æ–∫';
                break;
            default:
                label = key;
                if (typeof value === 'number') {
                    formattedValue = value.toLocaleString('ru-RU');
                }
        }

        html += `
            <div class="stat-item">
                <div class="stat-value">${formattedValue}</div>
                <div class="stat-label">${label}</div>
            </div>
        `;
    });

    grid.innerHTML = html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç—á–µ—Ç–∞
function updateReportTable(report, data) {
    const thead = document.querySelector('#reportTable thead');
    const tbody = document.getElementById('reportTableBody');
    const tfoot = document.getElementById('reportTableFooter');

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    let headersHtml = '<tr>';
    report.columns.forEach(column => {
        headersHtml += `<th>${column}</th>`;
    });
    headersHtml += '</tr>';
    thead.innerHTML = headersHtml;

    // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    let bodyHtml = '';
    let totals = {};

    data.forEach(row => {
        bodyHtml += '<tr>';
        report.columns.forEach(column => {
            const value = getColumnValue(column, row);

            // –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            if (typeof value === 'number') {
                const columnKey = column.split(',')[0].trim();
                totals[columnKey] = (totals[columnKey] || 0) + value;
            }

            bodyHtml += `<td>${formatValue(value)}</td>`;
        });
        bodyHtml += '</tr>';
    });
    tbody.innerHTML = bodyHtml;

    // –ò—Ç–æ–≥–∏
    let footerHtml = '<tr>';
    report.columns.forEach(column => {
        const columnKey = column.split(',')[0].trim();
        if (column === '–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°' || column === '–¢–°') {
            footerHtml += '<td><strong>–ò—Ç–æ–≥–æ:</strong></td>';
        } else if (totals[columnKey] !== undefined) {
            footerHtml += `<td><strong>${formatValue(totals[columnKey])}</strong></td>`;
        } else {
            footerHtml += '<td></td>';
        }
    });
    footerHtml += '</tr>';
    tfoot.innerHTML = footerHtml;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
function getColumnValue(column, row) {
    // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Å –ø–æ–ª—è–º–∏ –¥–∞–Ω–Ω—ã—Ö
    const columnMapping = {
        '–ù–∞–∑–≤–∞–Ω–∏–µ –¢–°': row.vehicleName,
        '–¢–°': row.vehicleName,
        '–ì—Ä—É–ø–ø–∞': row.group,
        '–ì—Ä—É–ø–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤': row.group,
        '–î–∞—Ç–∞': row.date,
        '–î–∞—Ç–∞/–≤—Ä–µ–º—è': row.datetime,
        '–ü—Ä–æ–±–µ–≥, –∫–º': row.distance,
        '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á': row.avgSpeed,
        '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–º/—á': row.maxSpeed,
        '–í—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è': row.moveTime,
        '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã': row.workTime,
        '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è': row.engineTime,
        '–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª': row.fuelConsumption,
        '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥, –ª': row.actualConsumption,
        '–ù–∞—á–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º, –ª': row.startVolume,
        '–ö–æ–Ω–µ—á–Ω—ã–π –æ–±—ä–µ–º, –ª': row.endVolume,
        '–û–±—ä–µ–º –∑–∞–ø—Ä–∞–≤–æ–∫, –ª': row.refillVolume,
        '–û–±—ä–µ–º —Å–ª–∏–≤–æ–≤, –ª': row.drainVolume,
        '–†–∞—Å—Ö–æ–¥ –Ω–∞ 100 –∫–º, –ª': row.consumptionPer100km,
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π': row.violationsCount,
        '–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è': row.violationType,
        '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã': row.parameters,
        '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ': row.location,
        '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å': row.duration,
        '–°–º–µ–Ω–∞': row.shift,
        '–í–æ–¥–∏—Ç–µ–ª—å': row.driver,
        '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': row.efficiency,
        '–¢–∏–ø —Å–æ–±—ã—Ç–∏—è': row.eventType,
        '–û–ø–∏—Å–∞–Ω–∏–µ': row.description,
        '–ü—Ä–∏—á–∏–Ω–∞': row.reason,
        '–ü–µ—Ä–∏–æ–¥': row.period,
        '–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è': row.idleTime,
        '–ö–ü–î': row.efficiency,
        '–ù–∞—á–∞–ª–æ —Å—Ç–æ—è–Ω–∫–∏': row.parkingStart,
        '–ö–æ–Ω–µ—Ü —Å—Ç–æ—è–Ω–∫–∏': row.parkingEnd,
        '–°—Ç–∞—Ç—É—Å': row.status,
        '–°–æ–±—ã—Ç–∏–µ': row.event
    };

    return columnMapping[column] || '-';
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
function formatValue(value) {
    if (typeof value === 'number') {
        return value.toLocaleString('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    return value || '-';
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
function exportToExcel() {
    if (!appState.reportData) {
        alert('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    try {
        const report = reportsConfig[appState.selectedReport];
        const data = appState.reportData.details;

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const exportData = data.map(row => {
            const exportRow = {};
            report.columns.forEach(column => {
                exportRow[column] = getColumnValue(column, row);
            });
            return exportRow;
        });

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, report.name);
        XLSX.writeFile(wb, `${report.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
        console.log('‚úÖ –û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
function exportToCSV() {
    if (!appState.reportData) {
        alert('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    try {
        const report = reportsConfig[appState.selectedReport];
        const data = appState.reportData.details;

        const headers = report.columns;
        const csvRows = [headers.join(',')];

        data.forEach(row => {
            const values = headers.map(header => {
                const value = getColumnValue(header, row);
                return `"${value}"`;
            });
            csvRows.push(values.join(','));
        });

        const csv = csvRows.join('\n');
        downloadCSV(csv, `${report.name}_${new Date().toISOString().split('T')[0]}.csv`);
        console.log('‚úÖ –û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ CSV');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
    }
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
function printReport() {
    window.print();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showGlobalLoading(show) {
    document.getElementById('globalLoading').style.display = show ? 'flex' : 'none';
}

function updateCurrentTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent = now.toLocaleTimeString('ru-RU');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç—á–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    initializePage();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateCurrentTime, 1000);
});
</script>
{% endblock %}