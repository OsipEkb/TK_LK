<!-- templates/dashboard/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}Главный дашборд - Мониторинг транспорта{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок и обновление -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-tachometer-alt me-2"></i>Мониторинг транспорта
            <span id="loadingSpinner" class="spinner-border spinner-border-sm text-primary ms-2 d-none" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </span>
        </h1>
        <div class="d-flex align-items-center">
            <small class="text-muted me-3" id="lastUpdate">Загрузка...</small>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshData()" id="refreshButton">
                <i class="fas fa-sync-alt me-1"></i> Обновить
            </button>
        </div>
    </div>

    <!-- Сообщение об ошибке -->
    <div class="alert alert-danger alert-dismissible fade show d-none mb-4" id="errorAlert" role="alert">
        <strong>Ошибка!</strong> <span id="errorMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Статистика -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-primary border-4 h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Всего ТС
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800" id="totalVehicles">0</div>
                            <small class="text-muted" id="schemaName">Загрузка...</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-success border-4 h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Онлайн
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800" id="onlineVehicles">0</div>
                            <small class="text-muted">активных ТС</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wifi fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-warning border-4 h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Оффлайн
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800" id="offlineVehicles">0</div>
                            <small class="text-muted">неактивных ТС</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wifi-off fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-info border-4 h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                В движении
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800" id="movingVehicles">0</div>
                            <small class="text-muted">ТС со скоростью > 0</small>
                        </div>
                        <div class="col-auto">
                            <div class="position-relative">
                                <i class="fas fa-truck fa-2x text-gray-300"></i>
                                <div class="position-absolute top-0 start-100 translate-middle">
                                    <div class="d-flex flex-column" style="margin-left: -8px;">
                                        <div class="bg-success" style="width: 12px; height: 2px; margin-bottom: 1px;"></div>
                                        <div class="bg-success" style="width: 12px; height: 2px; margin-bottom: 1px;"></div>
                                        <div class="bg-success" style="width: 12px; height: 2px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список транспортных средств -->
    <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center py-3">
            <h5 class="card-title mb-0">
                <i class="fas fa-truck me-2"></i>Транспортные средства
            </h5>
            <div>
                <span class="badge bg-primary me-2" id="badgeTotal">Всего: 0</span>
                <span class="badge bg-success me-2" id="badgeOnline">Онлайн: 0</span>
                <span class="badge bg-info me-2" id="badgeMoving">В движении: 0</span>
                <span class="badge bg-warning" id="badgeOffline">Оффлайн: 0</span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="vehiclesTable">
                    <thead class="table-light">
                        <tr>
                            <th>Транспорт</th>
                            <th>Госномер</th>
                            <th>Скорость</th>
                            <th>Уровень топлива</th>
                            <th>Моточасы</th>
                            <th>Статус</th>
                            <th>Местоположение</th>
                            <th>Последнее обновление</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                                Загрузка данных...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Информация о системе -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Информация о системе
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Статистика парка</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between px-0">
                                    <span>Всего транспортных средств:</span>
                                    <strong id="statTotal">0</strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between px-0">
                                    <span>Онлайн:</span>
                                    <strong class="text-success" id="statOnline">0</strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between px-0">
                                    <span>В движении:</span>
                                    <strong class="text-info" id="statMoving">0</strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between px-0">
                                    <span>Оффлайн:</span>
                                    <strong class="text-warning" id="statOffline">0</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Автообновление</h6>
                            <div class="alert alert-info">
                                <i class="fas fa-sync-alt me-2"></i>
                                <strong>Автоматическое обновление включено</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Интервал обновления: <strong>5 минут</strong></li>
                                    <li>Обновление при активности: <strong>Да</strong></li>
                                    <li>Статус API: <span class="badge bg-success" id="apiStatus">Работает</span></li>
                                    <li>Последнее обновление: <strong id="lastUpdateFull">-</strong></li>
                                    <li>Отладка: <a href="{% url 'debug_online' %}" class="alert-link">Просмотр сырых данных</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Конфигурация
const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 минут
let refreshTimer = null;
let isInitialLoad = true;

// Функция загрузки данных через API
async function loadDashboardData() {
    try {
        showLoadingState(true);

        const response = await fetch('/dashboard/api/data/');
        const result = await response.json();

        if (result.success) {
            updateDashboardUI(result.data, result.schema_name);
            hideError();

            if (isInitialLoad) {
                isInitialLoad = false;
                console.log('Первоначальная загрузка данных завершена');
            }
        } else {
            throw new Error(result.error || 'Ошибка загрузки данных');
        }
    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        showError('Ошибка загрузки данных: ' + error.message);
        document.getElementById('apiStatus').className = 'badge bg-danger';
        document.getElementById('apiStatus').textContent = 'Ошибка';
    } finally {
        showLoadingState(false);
    }
}

// Функция обновления интерфейса
function updateDashboardUI(data, schemaName) {
    // Обновляем статистические карточки
    document.getElementById('totalVehicles').textContent = data.total_vehicles || 0;
    document.getElementById('onlineVehicles').textContent = data.online_vehicles || 0;
    document.getElementById('offlineVehicles').textContent = data.offline_vehicles || 0;

    // Считаем ТС в движении
    const movingVehicles = data.vehicles ? data.vehicles.filter(v => v.speed > 0).length : 0;
    document.getElementById('movingVehicles').textContent = movingVehicles;

    // Обновляем схему
    if (schemaName) {
        document.getElementById('schemaName').textContent = `схема "${schemaName}"`;
    }

    // Обновляем бейджи
    document.getElementById('badgeTotal').textContent = `Всего: ${data.total_vehicles || 0}`;
    document.getElementById('badgeOnline').textContent = `Онлайн: ${data.online_vehicles || 0}`;
    document.getElementById('badgeMoving').textContent = `В движении: ${movingVehicles}`;
    document.getElementById('badgeOffline').textContent = `Оффлайн: ${data.offline_vehicles || 0}`;

    // Обновляем статистику
    document.getElementById('statTotal').textContent = data.total_vehicles || 0;
    document.getElementById('statOnline').textContent = data.online_vehicles || 0;
    document.getElementById('statMoving').textContent = movingVehicles;
    document.getElementById('statOffline').textContent = data.offline_vehicles || 0;

    // Обновляем таблицу транспортных средств
    updateVehiclesTable(data.vehicles || []);

    // Обновляем время последнего обновления
    updateLastUpdateTime();

    // Обновляем статус API
    document.getElementById('apiStatus').className = 'badge bg-success';
    document.getElementById('apiStatus').textContent = 'Работает';
}

// Функция обновления таблицы транспортных средств
function updateVehiclesTable(vehicles) {
    const tbody = document.getElementById('vehiclesTableBody');
    if (!tbody) return;

    if (vehicles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-truck fa-2x mb-2 d-block"></i>
                    Нет данных о транспортных средствах
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = vehicles.map(vehicle => `
        <tr class="${getVehicleRowClass(vehicle)}">
            <td>
                <div>
                    <strong>${escapeHtml(vehicle.name)}</strong>
                </div>
                <small class="text-muted">ID: ${vehicle.id}</small>
            </td>
            <td>
                ${vehicle.license_plate ?
                    `<span class="badge bg-dark fs-6">${escapeHtml(vehicle.license_plate)}</span>` :
                    '<span class="text-muted">-</span>'
                }
            </td>
            <td>
                <div class="d-flex align-items-center">
                    ${vehicle.speed > 0 ?
                        `<div class="position-relative me-2">
                            <i class="fas fa-truck text-success"></i>
                            <div class="position-absolute top-50 start-100 translate-middle-y" style="margin-left: -5px;">
                                <div class="d-flex flex-column">
                                    <div class="bg-success" style="width: 8px; height: 1px; margin-bottom: 1px;"></div>
                                    <div class="bg-success" style="width: 8px; height: 1px; margin-bottom: 1px;"></div>
                                    <div class="bg-success" style="width: 8px; height: 1px;"></div>
                                </div>
                            </div>
                        </div>
                        <span class="text-success fw-bold">${vehicle.speed} км/ч</span>` :
                        `<i class="fas fa-truck text-muted me-2"></i>
                        <span class="text-muted">0 км/ч</span>`
                    }
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-gas-pump text-warning me-2"></i>
                    <div>
                        <div class="fw-bold text-warning">${vehicle.fuel_level || '0'} л</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock text-info me-2"></i>
                    <div>
                        <div class="fw-bold text-info">${vehicle.engine_hours || '0'} ч</div>
                    </div>
                </div>
            </td>
            <td>
                ${getVehicleStatusBadge(vehicle)}
            </td>
            <td>
                <small class="text-muted">
                    ${vehicle.latitude && vehicle.longitude ?
                        `<i class="fas fa-map-marker-alt text-danger me-1"></i>
                        ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}` :
                        `<i class="fas fa-map-marker-alt text-muted me-1"></i>
                        -`
                    }
                    ${vehicle.address ? `<br><small class="text-muted">${escapeHtml(vehicle.address)}</small>` : ''}
                </small>
            </td>
            <td>
                <small>
                    <div class="text-nowrap">
                        <i class="fas fa-clock text-primary me-1"></i>
                        ${formatDateTime(vehicle.last_update)}
                    </div>
                    ${getTimeAgo(vehicle.last_update)}
                </small>
            </td>
        </tr>
    `).join('');
}

// Вспомогательные функции
function getVehicleRowClass(vehicle) {
    if (!vehicle.is_online) return 'table-warning';
    if (vehicle.speed > 0) return 'table-success';
    return '';
}

function getVehicleStatusBadge(vehicle) {
    if (!vehicle.is_online) {
        return `<span class="badge bg-warning">
            <i class="fas fa-exclamation-triangle me-1"></i>Нет данных
        </span>`;
    }

    if (vehicle.speed > 0) {
        return `<span class="badge bg-success">
            <div class="d-flex align-items-center">
                <div class="position-relative me-1">
                    <i class="fas fa-truck"></i>
                    <div class="position-absolute top-50 start-100 translate-middle-y" style="margin-left: -3px;">
                        <div class="d-flex flex-column">
                            <div class="bg-white" style="width: 4px; height: 1px; margin-bottom: 0.5px;"></div>
                            <div class="bg-white" style="width: 4px; height: 1px; margin-bottom: 0.5px;"></div>
                            <div class="bg-white" style="width: 4px; height: 1px;"></div>
                        </div>
                    </div>
                </div>
                <span>В движении</span>
            </div>
        </span>`;
    }

    return `<span class="badge bg-secondary">
        <i class="fas fa-truck me-1"></i>На стоянке
    </span>`;
}

function getTimeAgo(dateString) {
    if (!dateString) return '';

    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);

        if (diffMins < 1) {
            return '<span class="badge bg-success">Только что</span>';
        } else if (diffMins < 60) {
            return `<span class="badge bg-info">${diffMins} мин назад</span>`;
        } else if (diffHours < 24) {
            return `<span class="badge bg-warning">${diffHours} ч назад</span>`;
        } else {
            return `<span class="badge bg-danger">${Math.floor(diffHours / 24)} дн назад</span>`;
        }
    } catch (e) {
        return '';
    }
}

function showLoadingState(show) {
    const spinner = document.getElementById('loadingSpinner');
    const refreshBtn = document.getElementById('refreshButton');

    if (spinner) {
        spinner.classList.toggle('d-none', !show);
    }
    if (refreshBtn) {
        refreshBtn.disabled = show;
        refreshBtn.innerHTML = show ?
            '<div class="spinner-border spinner-border-sm me-1" role="status"><span class="visually-hidden">Загрузка...</span></div> Обновление...' :
            '<i class="fas fa-sync-alt me-1"></i> Обновить';
    }
}

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');

    if (errorAlert && errorMessage) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
    }
}

function hideError() {
    const errorAlert = document.getElementById('errorAlert');
    if (errorAlert) {
        errorAlert.classList.add('d-none');
    }
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU');
    const dateString = now.toLocaleDateString('ru-RU');

    const updateElement = document.getElementById('lastUpdate');
    const fullUpdateElement = document.getElementById('lastUpdateFull');

    if (updateElement) {
        updateElement.textContent = `Обновлено: ${timeString}`;
    }
    if (fullUpdateElement) {
        fullUpdateElement.textContent = `${dateString} ${timeString}`;
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '-';

    try {
        const date = new Date(dateString);
        return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return '-';
    }
}

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Функция для ручного обновления
function refreshData() {
    loadDashboardData();
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем данные сразу после загрузки страницы
    loadDashboardData();

    // Запускаем автоматическое обновление
    refreshTimer = setInterval(loadDashboardData, REFRESH_INTERVAL);

    // Останавливаем обновление при скрытии страницы для экономии ресурсов
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        } else {
            if (!refreshTimer) {
                refreshTimer = setInterval(loadDashboardData, REFRESH_INTERVAL);
            }
        }
    });
});

// Очистка при разгрузке страницы
window.addEventListener('beforeunload', function() {
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
});
</script>
{% endblock %}