<!-- templates/dashboard/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}–ì–ª–∞–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-tachometer-alt me-2"></i>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            <span id="loadingSpinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </span>
        </h1>
        <button class="btn btn-outline-primary btn-sm" onclick="loadData()">
            <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5>–í—Å–µ–≥–æ –¢–°</h5>
                    <h2 id="totalVehicles">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>–û–Ω–ª–∞–π–Ω</h5>
                    <h2 id="onlineVehicles">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5>–û—Ñ—Ñ–ª–∞–π–Ω</h5>
                    <h2 id="offlineVehicles">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>–í –¥–≤–∏–∂–µ–Ω–∏–∏</h5>
                    <h2 id="movingVehicles">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-truck me-2"></i>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
                <small class="text-muted ms-2" id="lastUpdate">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                            <th>–°–∫–æ—Ä–æ—Å—Ç—å</th>
                            <th>–¢–æ–ø–ª–∏–≤–æ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTable">
                        <tr>
                            <td colspan="6" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ü–†–û–°–¢–û–ô –ò –†–ê–ë–û–ß–ò–ô JavaScript
async function loadData() {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö...');

    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loadingSpinner').style.display = 'inline-block';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const response = await fetch('/dashboard/api/data/');
        console.log('üì° –û—Ç–≤–µ—Ç –æ—Ç API:', response.status);

        const data = await response.json();
        console.log('üìä –î–∞–Ω–Ω—ã–µ:', data);

        if (data.success) {
            updateDashboard(data.data);
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö:', data.error);
            showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }

    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

function updateDashboard(dashboardData) {
    console.log('üéØ –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ —Å –¥–∞–Ω–Ω—ã–º–∏:', dashboardData);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('totalVehicles').textContent = dashboardData.total_vehicles || 0;
    document.getElementById('onlineVehicles').textContent = dashboardData.online_vehicles || 0;
    document.getElementById('offlineVehicles').textContent = dashboardData.offline_vehicles || 0;

    // –°—á–∏—Ç–∞–µ–º –¢–° –≤ –¥–≤–∏–∂–µ–Ω–∏–∏
    const movingCount = dashboardData.vehicles ?
        dashboardData.vehicles.filter(v => v.speed > 0).length : 0;
    document.getElementById('movingVehicles').textContent = movingCount;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    updateVehiclesTable(dashboardData.vehicles || []);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
    document.getElementById('lastUpdate').textContent =
        '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('ru-RU');
}

function updateVehiclesTable(vehicles) {
    console.log('üìã –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å', vehicles.length, '–¢–°');

    const tbody = document.getElementById('vehiclesTable');

    if (vehicles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö</td></tr>';
        return;
    }

    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    let html = '';
    vehicles.forEach(vehicle => {
        const status = vehicle.is_online ?
            (vehicle.speed > 0 ?
                '<span class="badge bg-success">–í –¥–≤–∏–∂–µ–Ω–∏–∏</span>' :
                '<span class="badge bg-secondary">–ù–∞ —Å—Ç–æ—è–Ω–∫–µ</span>') :
            '<span class="badge bg-warning">–û—Ñ—Ñ–ª–∞–π–Ω</span>';

        const speed = vehicle.speed > 0 ?
            `<span class="text-success fw-bold">${vehicle.speed} –∫–º/—á</span>` :
            '<span class="text-muted">0 –∫–º/—á</span>';

        const fuel = vehicle.fuel_level ?
            `${vehicle.fuel_level} –ª` :
            '<span class="text-muted">-</span>';

        const lastUpdate = vehicle.last_update ?
            new Date(vehicle.last_update).toLocaleString('ru-RU') :
            '<span class="text-muted">-</span>';

        html += `
            <tr>
                <td><strong>${escapeHtml(vehicle.name)}</strong></td>
                <td>${vehicle.license_plate ? `<span class="badge bg-dark">${escapeHtml(vehicle.license_plate)}</span>` : '-'}</td>
                <td>${speed}</td>
                <td>${fuel}</td>
                <td>${status}</td>
                <td><small>${lastUpdate}</small></td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function showError(message) {
    // –ü—Ä–æ—Å—Ç–æ–π alert –¥–ª—è –æ—à–∏–±–æ–∫
    alert('–û—à–∏–±–∫–∞: ' + message);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö...');
    loadData();

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(loadData, 5 * 60 * 1000);
});
</script>
{% endblock %}